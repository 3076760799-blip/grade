<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学生成绩分析系统 - 理科版</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f8fafc;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(67, 97, 238, 0.2);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
            max-width: 800px;
            margin: 0 auto;
        }
        
        /* 导航栏 */
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 0;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            flex: 1;
            padding: 18px 25px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1rem;
            color: #555;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            min-width: 150px;
        }
        
        .nav-tab:hover {
            background-color: #f1f8ff;
            color: #4361ee;
        }
        
        .nav-tab.active {
            color: #4361ee;
            border-bottom: 3px solid #4361ee;
            background-color: rgba(67, 97, 238, 0.05);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* 卡片样式 */
        .card {
            background-color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.06);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f2f5;
        }
        
        .card-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #2d3748;
        }
        
        /* 按钮样式 */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background-color: #4cc9f0;
            color: white;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary {
            background-color: #4361ee;
        }
        
        .btn-success {
            background-color: #4cc9f0;
        }
        
        .btn-warning {
            background-color: #f72585;
        }
        
        .btn-danger {
            background-color: #7209b7;
        }
        
        .btn-info {
            background-color: #3a0ca3;
        }
        
        /* 表格样式 */
        .table-container {
            overflow-x: auto;
            margin-top: 15px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1500px;
        }
        
        th, td {
            padding: 12px 8px;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
        }
        
        th {
            background-color: #f7fafc;
            font-weight: 600;
            color: #2d3748;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }
        
        tr:hover {
            background-color: #f8fafc;
        }
        
        /* 输入框样式 */
        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            border-color: #4361ee;
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        
        .score-input {
            width: 60px;
            text-align: center;
            padding: 6px;
        }
        
        /* 图表容器 */
        .chart-container {
            height: 350px;
            margin-top: 20px;
            position: relative;
        }
        
        /* 操作按钮 */
        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .action-btn.edit {
            background-color: #4cc9f0;
            color: white;
        }
        
        .action-btn.delete {
            background-color: #f72585;
            color: white;
        }
        
        .action-btn.save {
            background-color: #4361ee;
            color: white;
        }
        
        .action-btn.cancel {
            background-color: #94a3b8;
            color: white;
        }
        
        .action-btn:hover {
            opacity: 0.9;
            transform: scale(1.05);
        }
        
        /* Excel导入区域 */
        .excel-import {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 2px dashed #4361ee;
        }
        
        .file-upload-area {
            border: 2px dashed #94a3b8;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            margin: 15px 0;
        }
        
        .file-upload-area:hover {
            border-color: #4361ee;
            background-color: #f8fafc;
        }
        
        .file-upload-area i {
            font-size: 3rem;
            color: #4361ee;
            margin-bottom: 15px;
        }
        
        /* 统计卡片 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.2);
        }
        
        .stat-card h3 {
            font-size: 1rem;
            margin-bottom: 10px;
            font-weight: 500;
            opacity: 0.9;
        }
        
        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }
            
            .nav-tab {
                width: 100%;
                border-bottom: 1px solid #e2e8f0;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* 模态框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f2f5;
        }
        
        .modal-title {
            font-size: 1.5rem;
            color: #2d3748;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
        }
        
        /* 学科导航 */
        .subject-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 25px;
            justify-content: center;
        }
        
        .subject-tab {
            padding: 12px 25px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #4a5568;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .subject-tab:hover {
            border-color: #4361ee;
            color: #4361ee;
        }
        
        .subject-tab.active {
            background: #4361ee;
            color: white;
            border-color: #4361ee;
        }
        
        .subject-content {
            display: none;
        }
        
        .subject-content.active {
            display: block;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .three-column {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 1100px) {
            .two-column, .three-column {
                grid-template-columns: 1fr;
            }
        }
        
        /* 分数线状态样式 */
        .above-double-first { color: #16a34a; font-weight: bold; }
        .above-excellent { color: #22c55e; font-weight: bold; }
        .above-first-tier { color: #f59e0b; font-weight: bold; }
        .above-key-tier { color: #ef4444; font-weight: bold; }
        .below-line { color: #64748b; }
        
        /* 学科特定颜色 */
        .subject-chinese { color: #e63946; }
        .subject-math { color: #1d3557; }
        .subject-english { color: #457b9d; }
        .subject-physics { color: #e9c46a; }
        .subject-chemistry { color: #2a9d8f; }
        .subject-biology { color: #f4a261; }
        
        /* 考试选择器 */
        .exam-selector {
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
        }
        
        .exam-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .exam-btn {
            padding: 8px 15px;
            background: white;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .exam-btn:hover {
            border-color: #4361ee;
            color: #4361ee;
        }
        
        .exam-btn.active {
            background: #4361ee;
            color: white;
            border-color: #4361ee;
        }
        
        /* 排名趋势图表样式 */
        .rank-trend-highlight {
            font-weight: bold;
            color: #4361ee;
        }
        
        .rank-improved {
            color: #16a34a;
        }
        
        .rank-declined {
            color: #ef4444;
        }
        
        .rank-stable {
            color: #64748b;
        }
        
        /* 排名标签页样式 */
        .rank-subtabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .rank-subtab {
            padding: 10px 20px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            color: #4a5568;
            transition: all 0.3s;
        }
        
        .rank-subtab:hover {
            border-color: #4361ee;
            color: #4361ee;
        }
        
        .rank-subtab.active {
            background: #4361ee;
            color: white;
            border-color: #4361ee;
        }
        
        .rank-subcontent {
            display: none;
        }
        
        .rank-subcontent.active {
            display: block;
        }
        
        /* 多考试选择器样式 */
        .exam-checkbox-container {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .exam-checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .exam-checkbox-item:last-child {
            border-bottom: none;
        }
        
        .exam-checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        
        .exam-checkbox-label {
            flex-grow: 1;
            font-weight: 500;
        }
        
        /* 趋势图表工具栏 */
        .chart-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 8px;
        }
        
        .chart-legend {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
        
        /* 分数和排名单元格样式 */
        .score-rank-cell {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 5px;
        }
        
        .score-value {
            flex: 1;
        }
        
        .rank-value {
            font-size: 0.8rem;
            color: #64748b;
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            min-width: 40px;
            text-align: center;
        }
        
        /* 排名趋势指标 */
        .rank-indicator {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 5px;
        }
        
        .rank-up {
            background-color: #dcfce7;
            color: #16a34a;
        }
        
        .rank-down {
            background-color: #fee2e2;
            color: #ef4444;
        }
        
        .rank-same {
            background-color: #f1f5f9;
            color: #64748b;
        }
        
        /* 警告和提示样式 */
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-warning {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #fbbf24;
        }
        
        .alert-info {
            background-color: #dbeafe;
            color: #1e40af;
            border: 1px solid #60a5fa;
        }
        
        .alert-success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #34d399;
        }
        
        .alert-error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #f87171;
        }
        
        /* 导入数据格式说明 */
        .format-guide {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #4361ee;
        }
        
        .format-guide h4 {
            margin-bottom: 10px;
            color: #2d3748;
        }
        
        .format-guide ul {
            padding-left: 20px;
            margin-bottom: 10px;
        }
        
        .format-guide li {
            margin-bottom: 5px;
            color: #4b5563;
        }
        
        /* 加载动画 */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4361ee;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 数据统计样式 */
        .data-summary {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            margin-bottom: 15px;
        }
        
        .data-summary h4 {
            margin-bottom: 10px;
            color: #2d3748;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        
        .summary-item {
            text-align: center;
            padding: 10px;
            background: #f8fafc;
            border-radius: 6px;
        }
        
        .summary-label {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 5px;
        }
        
        .summary-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2d3748;
        }
        
        /* 考试数据预览 */
        .exam-preview {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        
        .exam-preview table {
            min-width: auto;
            width: 100%;
        }
        
        .exam-preview th, .exam-preview td {
            padding: 8px;
            font-size: 0.9rem;
        }
        
        /* 新增：分数线参考线样式 */
        .score-line-reference {
            position: absolute;
            width: 100%;
            height: 2px;
            z-index: 1;
        }
        
        .line-key-tier {
            background-color: #ef4444;
        }
        
        .line-first-tier {
            background-color: #f59e0b;
        }
        
        .line-excellent {
            background-color: #22c55e;
        }
        
        .line-double-first {
            background-color: #16a34a;
        }
        
        .line-label {
            position: absolute;
            font-size: 0.8rem;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 3px;
            right: 5px;
            transform: translateY(-50%);
        }
        
        .label-key-tier {
            background-color: #ef4444;
            color: white;
        }
        
        .label-first-tier {
            background-color: #f59e0b;
            color: white;
        }
        
        .label-excellent {
            background-color: #22c55e;
            color: white;
        }
        
        .label-double-first {
            background-color: #16a34a;
            color: white;
        }
        
        /* 新增：分数线差距样式 */
        .line-diff-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 10px;
        }
        
        .line-diff-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2d3748;
        }
        
        .line-diff-value {
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        .line-diff-positive {
            color: #16a34a;
        }
        
        .line-diff-negative {
            color: #ef4444;
        }
        
        .line-diff-zero {
            color: #64748b;
        }
        
        /* 新增：排名标签样式 */
        .rank-label {
            display: inline-block;
            padding: 4px 8px;
            background: #f1f5f9;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #64748b;
            margin-left: 5px;
        }
        
        .grade-rank {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .class-rank {
            background: #fef3c7;
            color: #92400e;
        }
        
        /* 分数线批次样式 */
        .score-line-batch {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
        }
        
        .batch-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .batch-title {
            font-weight: 600;
            color: #2d3748;
        }
        
        .batch-actions {
            display: flex;
            gap: 10px;
        }
        
        /* 分数线表格样式 */
        .score-line-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .score-line-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #2d3748;
            padding: 10px;
            border: 1px solid #e2e8f0;
        }
        
        .score-line-table td {
            padding: 10px;
            border: 1px solid #e2e8f0;
            text-align: center;
        }
        
        .score-line-input {
            width: 80px;
            text-align: center;
            padding: 5px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
        }
        
        /* 分数线导入样式 */
        .score-line-import {
            background: #f8fafc;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px dashed #94a3b8;
        }
        
        .score-line-import:hover {
            border-color: #4361ee;
        }
        
        /* 新的：考试关联分数线样式 */
        .exam-line-association {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
        }
        
        .association-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .association-item:last-child {
            border-bottom: none;
        }
        
        .association-exam-name {
            flex-grow: 1;
            font-weight: 500;
        }
        
        .association-line-info {
            font-size: 0.9rem;
            color: #64748b;
        }
        
        .association-line-status {
            font-size: 0.8rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: #f1f5f9;
        }
        
        .status-has-line {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-no-line {
            background: #fee2e2;
            color: #991b1b;
        }
        
        /* 新的：学生表格完整显示样式 */
        .compact-cell {
            min-width: 100px;
        }
        
        .subject-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .subject-title {
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .subject-subtitle {
            font-size: 0.8rem;
            color: #64748b;
        }
        
        /* 新的：操作列样式 */
        .action-column {
            min-width: 120px;
        }
        
        /* 新增：考试管理操作样式 */
        .exam-management {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }
        
        .exam-edit-input {
            padding: 6px 10px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 0.9rem;
            width: 150px;
        }
        
        .exam-action-btn {
            padding: 4px 8px;
            font-size: 0.8rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .exam-action-btn.edit {
            background-color: #4cc9f0;
            color: white;
        }
        
        .exam-action-btn.delete {
            background-color: #f72585;
            color: white;
        }
        
        .exam-action-btn.save {
            background-color: #4361ee;
            color: white;
        }
        
        .exam-action-btn.cancel {
            background-color: #94a3b8;
            color: white;
        }
        
        .exam-action-btn:hover {
            opacity: 0.9;
            transform: scale(1.05);
        }
        
        /* 新增：趋势图分数线样式 */
        .trend-line-container {
            position: relative;
            width: 100%;
            height: 20px;
            margin-top: 10px;
        }
        
        .trend-line-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }
        
        .trend-line-color {
            width: 15px;
            height: 3px;
            border-radius: 1px;
        }
        
        .trend-line-label {
            font-size: 0.9rem;
            color: #4b5563;
        }
        
        /* 新增：智能识别提示 */
        .smart-recognition {
            background: #e0f2fe;
            border-left: 4px solid #0369a1;
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        
        .smart-recognition h5 {
            color: #0369a1;
            margin-bottom: 5px;
            font-size: 0.95rem;
        }
        
        .smart-recognition p {
            font-size: 0.85rem;
            color: #334155;
            margin: 3px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-chart-line"></i> 学生成绩分析系统 - 理科版</h1>
            <p class="subtitle">多考试数据导入 · 智能分数线识别 · 实时成绩统计与趋势分析</p>
        </header>
        
        <!-- 导航栏 -->
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="overview">
                <i class="fas fa-home"></i> 总览
            </div>
            <div class="nav-tab" data-tab="total-analysis">
                <i class="fas fa-star"></i> 总分分析
            </div>
            <div class="nav-tab" data-tab="subject-analysis">
                <i class="fas fa-book"></i> 学科分析
            </div>
            <div class="nav-tab" data-tab="rank-trend">
                <i class="fas fa-sort-numeric-down"></i> 排名分析
            </div>
            <div class="nav-tab" data-tab="score-lines">
                <i class="fas fa-sliders-h"></i> 分数线管理
            </div>
        </div>
        
        <!-- 总览页面 -->
        <div id="overview" class="tab-content active">
            <!-- Excel导入区域 -->
            <div class="excel-import">
                <h3><i class="fas fa-file-excel"></i> 学生成绩导入</h3>
                <div class="file-upload-area" id="fileUploadArea">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h4>点击或拖拽Excel文件到此处</h4>
                    <p>支持 .xlsx, .xls, .csv 格式</p>
                    <p class="btn btn-primary" style="display: inline-block; margin-top: 10px;">
                        <i class="fas fa-file-upload"></i> 选择文件
                    </p>
                    <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" style="display: none;">
                </div>
                
                <!-- 数据格式说明 -->
                <div class="format-guide">
                    <h4><i class="fas fa-info-circle"></i> 数据格式说明</h4>
                    <p>Excel文件应包含以下列（列名可自定义，系统会自动识别）：</p>
                    <ul>
                        <li><strong>姓名</strong> - 学生姓名（必需）</li>
                        <li><strong>总分</strong> - 学生总分（必需）</li>
                        <li><strong>校排名/年级排名</strong> - 年级排名（可选）</li>
                        <li><strong>语文、数学、英语、物理、化学、生物</strong> - 学科成绩（必需）</li>
                        <li><strong>语文排名、数学排名...</strong> - 学科年级排名（必需）</li>
                    </ul>
                    <p><small>提示：系统会根据姓名智能匹配学生，支持多次考试数据合并</small></p>
                </div>
                
                <div class="action-buttons" style="margin-top: 20px;">
                    <button class="btn btn-primary" id="importBtn">
                        <i class="fas fa-file-import"></i> 导入数据
                    </button>
                    <button class="btn btn-info" id="downloadTemplateBtn">
                        <i class="fas fa-download"></i> 下载模板
                    </button>
                    <select id="importMode" style="padding: 12px; border-radius: 8px; border: 1px solid #cbd5e0;">
                        <option value="append">追加到现有数据</option>
                        <option value="replace">替换现有数据</option>
                        <option value="new-exam">作为新考试导入</option>
                    </select>
                </div>
                
                <div id="filePreview" style="margin-top: 20px; display: none;">
                    <h4>数据预览</h4>
                    <div class="data-summary">
                        <h4>数据统计</h4>
                        <div class="summary-grid" id="dataSummary">
                            <!-- 数据统计信息 -->
                        </div>
                    </div>
                    <div class="exam-preview">
                        <table id="previewTable">
                            <thead></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- 分数线设置 -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-sliders-h"></i> 总分分数线设置</h2>
                </div>
                <div class="action-buttons">
                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <div>
                            <label>本科线: </label>
                            <input type="number" id="keyTierLine" value="328.5" min="0" max="750" class="score-input line-input">
                        </div>
                        <div>
                            <label>重本线: </label>
                            <input type="number" id="firstTierLine" value="451.5" min="0" max="750" class="score-input line-input">
                        </div>
                        <div>
                            <label>高优线: </label>
                            <input type="number" id="excellentLine" value="556.5" min="0" max="750" class="score-input line-input">
                        </div>
                        <div>
                            <label>双一流线: </label>
                            <input type="number" id="doubleFirstLine" value="600.5" min="0" max="750" class="score-input line-input">
                        </div>
                        <button class="btn btn-success" id="updateLinesBtn">
                            <i class="fas fa-sync-alt"></i> 更新分数线
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 学生成绩表格 -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-table"></i> 学生成绩管理</h2>
                    <span>学生总数: <span id="studentCount">0</span></span>
                </div>
                <div class="action-buttons" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" id="addStudentBtn">
                        <i class="fas fa-user-plus"></i> 添加学生
                    </button>
                    <button class="btn btn-success" id="calculateStatsBtn">
                        <i class="fas fa-calculator"></i> 计算统计
                    </button>
                    <button class="btn btn-warning" id="generateReportBtn">
                        <i class="fas fa-file-alt"></i> 生成报告
                    </button>
                    <button class="btn btn-danger" id="resetDataBtn">
                        <i class="fas fa-redo"></i> 重置数据
                    </button>
                </div>
                
                <!-- 考试选择器 -->
                <div class="exam-selector" style="margin-bottom: 20px;">
                    <h3><i class="fas fa-history"></i> 选择考试</h3>
                    <p>选择要查看和编辑的学生数据</p>
                    <div class="exam-buttons" id="currentExamButtons">
                        <!-- 当前考试按钮通过JS动态生成 -->
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="studentTable">
                        <thead>
                            <tr>
                                <th>姓名</th>
                                <th>总分</th>
                                <th>年级排名</th>
                                
                                <!-- 语文 -->
                                <th class="compact-cell">
                                    <div class="subject-header">
                                        <span class="subject-title">语文</span>
                                        <span class="subject-subtitle">150</span>
                                    </div>
                                </th>
                                <th class="compact-cell">
                                    <div class="subject-header">
                                        <span class="subject-title">排名</span>
                                    </div>
                                </th>
                                
                                <!-- 数学 -->
                                <th class="compact-cell">
                                    <div class="subject-header">
                                        <span class="subject-title">数学</span>
                                        <span class="subject-subtitle">150</span>
                                    </div>
                                </th>
                                <th class="compact-cell">
                                    <div class="subject-header">
                                        <span class="subject-title">排名</span>
                                    </div>
                                </th>
                                
                                <!-- 英语 -->
                                <th class="compact-cell">
                                    <div class="subject-header">
                                        <span class="subject-title">英语</span>
                                        <span class="subject-subtitle">150</span>
                                    </div>
                                </th>
                                <th class="compact-cell">
                                    <div class="subject-header">
                                        <span class="subject-title">排名</span>
                                    </div>
                                </th>
                                
                                <!-- 物理 -->
                                <th class="compact-cell">
                                    <div class="subject-header">
                                        <span class="subject-title">物理</span>
                                        <span class="subject-subtitle">100</span>
                                    </div>
                                </th>
                                <th class="compact-cell">
                                    <div class="subject-header">
                                        <span class="subject-title">排名</span>
                                    </div>
                                </th>
                                
                                <!-- 化学 -->
                                <th class="compact-cell">
                                    <div class="subject-header">
                                        <span class="subject-title">化学</span>
                                        <span class="subject-subtitle">100</span>
                                    </div>
                                </th>
                                <th class="compact-cell">
                                    <div class="subject-header">
                                        <span class="subject-title">排名</span>
                                    </div>
                                </th>
                                
                                <!-- 生物 -->
                                <th class="compact-cell">
                                    <div class="subject-header">
                                        <span class="subject-title">生物</span>
                                        <span class="subject-subtitle">100</span>
                                    </div>
                                </th>
                                <th class="compact-cell">
                                    <div class="subject-header">
                                        <span class="subject-title">排名</span>
                                    </div>
                                </th>
                                
                                <th class="action-column">操作</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody">
                            <!-- 数据通过JS动态生成 -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 班级统计 -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-chart-bar"></i> 班级统计概览</h2>
                </div>
                <div class="stats-grid" id="classStats">
                    <!-- 统计信息通过JS动态生成 -->
                </div>
            </div>
            
            <!-- 图表区域 -->
            <div class="two-column">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-chart-pie"></i> 学科与分数线对比分析</h2>
                        <div style="display: flex; gap: 10px;">
                            <select id="studentSelect" style="padding: 8px; border-radius: 6px; border: 1px solid #cbd5e0;">
                                <option value="">选择学生</option>
                            </select>
                            <select id="radarExamSelect" style="padding: 8px; border-radius: 6px; border: 1px solid #cbd5e0;">
                                <option value="">选择考试</option>
                            </select>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-chart-line"></i> 成绩变化趋势（含分数线）</h2>
                        <div style="display: flex; gap: 10px;">
                            <select id="trendStudentSelect" style="padding: 8px; border-radius: 6px; border: 1px solid #cbd5e0;">
                                <option value="">选择学生</option>
                            </select>
                            <select id="trendExamSelect" style="padding: 8px; border-radius: 6px; border: 1px solid #cbd5e0;">
                                <option value="all">所有考试</option>
                            </select>
                        </div>
                    </div>
                    <!-- 考试选择器 -->
                    <div class="exam-checkbox-container" style="margin: 15px 0; max-height: 200px;">
                        <h4><i class="fas fa-check-square"></i> 选择要分析的考试</h4>
                        <div id="examCheckboxes">
                            <!-- 考试复选框通过JS动态生成 -->
                        </div>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-success" id="selectAllExamsBtn" style="padding: 6px 12px; font-size: 0.9rem;">
                                <i class="fas fa-check-double"></i> 全选
                            </button>
                            <button class="btn btn-warning" id="deselectAllExamsBtn" style="padding: 6px 12px; font-size: 0.9rem;">
                                <i class="fas fa-times"></i> 全不选
                            </button>
                            <button class="btn btn-primary" id="applyExamSelectionBtn" style="padding: 6px 12px; font-size: 0.9rem;">
                                <i class="fas fa-play"></i> 应用选择
                            </button>
                        </div>
                    </div>
                    <!-- 分数线图例 -->
                    <div class="trend-line-container" id="trendLineLegend">
                        <!-- 分数线图例通过JS动态生成 -->
                    </div>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 总分分析页面 -->
        <div id="total-analysis" class="tab-content">
            <!-- 新增：总分分析考试选择器 -->
            <div class="exam-selector" style="margin-bottom: 20px;">
                <h3><i class="fas fa-history"></i> 选择考试进行分析</h3>
                <p>选择要分析总分数据的考试</p>
                <div class="exam-buttons" id="totalAnalysisExamButtons">
                    <!-- 考试按钮通过JS动态生成 -->
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-chart-bar"></i> 总分分布直方图</h2>
                </div>
                <div class="chart-container">
                    <canvas id="totalScoreChart"></canvas>
                </div>
            </div>
            
            <div class="two-column">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-list-ol"></i> 总分排名</h2>
                    </div>
                    <div class="table-container">
                        <table id="rankTable">
                            <thead>
                                <tr>
                                    <th>排名</th>
                                    <th>姓名</th>
                                    <th>总分</th>
                                    <th>年级排名</th>
                                    <th>分数线状态</th>
                                </tr>
                            </thead>
                            <tbody id="rankTableBody">
                                <!-- 排名数据通过JS动态生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-chart-pie"></i> 分数线分布</h2>
                    </div>
                    <div class="chart-container">
                        <canvas id="scoreLineChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- 新增：分数线差距分析 -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-ruler"></i> 总分与分数线差距分析</h2>
                    <div style="display: flex; gap: 10px;">
                        <select id="totalDiffStudentSelect" style="padding: 8px; border-radius: 6px; border: 1px solid #cbd5e0;">
                            <option value="">选择学生查看差距</option>
                        </select>
                    </div>
                </div>
                <div id="totalLineDiffContainer">
                    <!-- 分数线差距信息通过JS动态生成 -->
                </div>
            </div>
        </div>
        
        <!-- 学科分析页面 -->
        <div id="subject-analysis" class="tab-content">
            <!-- 新增：学科分析考试选择器 -->
            <div class="exam-selector" style="margin-bottom: 20px;">
                <h3><i class="fas fa-history"></i> 选择考试进行分析</h3>
                <p>选择要分析学科数据的考试</p>
                <div class="exam-buttons" id="subjectAnalysisExamButtons">
                    <!-- 考试按钮通过JS动态生成 -->
                </div>
            </div>
            
            <div class="subject-tabs">
                <div class="subject-tab active" data-subject="chinese">
                    <i class="fas fa-language"></i> 语文
                </div>
                <div class="subject-tab" data-subject="math">
                    <i class="fas fa-calculator"></i> 数学
                </div>
                <div class="subject-tab" data-subject="english">
                    <i class="fas fa-globe"></i> 英语
                </div>
                <div class="subject-tab" data-subject="physics">
                    <i class="fas fa-atom"></i> 物理
                </div>
                <div class="subject-tab" data-subject="chemistry">
                    <i class="fas fa-flask"></i> 化学
                </div>
                <div class="subject-tab" data-subject="biology">
                    <i class="fas fa-dna"></i> 生物
                </div>
            </div>
            
            <!-- 语文学科分析 -->
            <div id="chinese" class="subject-content active">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-language"></i> 语文成绩分析</h2>
                        <span>平均分: <span id="chineseAvg">0</span>分</span>
                    </div>
                    <div class="three-column">
                        <div class="chart-container">
                            <canvas id="chineseDistributionChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <canvas id="chineseLineChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h3><i class="fas fa-chart-line"></i> 语文与分数线趋势对比</h3>
                                <div style="display: flex; gap: 10px;">
                                    <select id="chineseTrendSelect" style="padding: 6px; border-radius: 4px; border: 1px solid #cbd5e0;">
                                        <option value="">选择学生</option>
                                    </select>
                                    <select id="chineseTrendExamSelect" style="padding: 6px; border-radius: 4px; border: 1px solid #cbd5e0;">
                                        <option value="all">所有考试</option>
                                    </select>
                                </div>
                            </div>
                            <canvas id="chineseTrendChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- 新增：学科分数线差距分析 -->
                    <div class="card" style="margin-top: 20px;">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-ruler"></i> 语文与分数线差距分析</h2>
                            <div style="display: flex; gap: 10px;">
                                <select id="chineseDiffStudentSelect" style="padding: 8px; border-radius: 6px; border: 1px solid #cbd5e0;">
                                    <option value="">选择学生查看差距</option>
                                </select>
                            </div>
                        </div>
                        <div id="chineseLineDiffContainer">
                            <!-- 语文分数线差距信息通过JS动态生成 -->
                        </div>
                    </div>
                    
                    <div class="stats-grid" style="margin-top: 20px;" id="chineseStats">
                        <!-- 语文学科统计信息 -->
                    </div>
                </div>
            </div>
            
            <!-- 数学学科分析 -->
            <div id="math" class="subject-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-calculator"></i> 数学成绩分析</h2>
                        <span>平均分: <span id="mathAvg">0</span>分</span>
                    </div>
                    <div class="three-column">
                        <div class="chart-container">
                            <canvas id="mathDistributionChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <canvas id="mathLineChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h3><i class="fas fa-chart-line"></i> 数学与分数线趋势对比</h3>
                                <div style="display: flex; gap: 10px;">
                                    <select id="mathTrendSelect" style="padding: 6px; border-radius: 4px; border: 1px solid #cbd5e0;">
                                        <option value="">选择学生</option>
                                    </select>
                                    <select id="mathTrendExamSelect" style="padding: 6px; border-radius: 4px; border: 1px solid #cbd5e0;">
                                        <option value="all">所有考试</option>
                                    </select>
                                </div>
                            </div>
                            <canvas id="mathTrendChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- 新增：学科分数线差距分析 -->
                    <div class="card" style="margin-top: 20px;">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-ruler"></i> 数学与分数线差距分析</h2>
                            <div style="display: flex; gap: 10px;">
                                <select id="mathDiffStudentSelect" style="padding: 8px; border-radius: 6px; border: 1px solid #cbd5e0;">
                                    <option value="">选择学生查看差距</option>
                                </select>
                            </div>
                        </div>
                        <div id="mathLineDiffContainer">
                            <!-- 数学分数线差距信息通过JS动态生成 -->
                        </div>
                    </div>
                    
                    <div class="stats-grid" style="margin-top: 20px;" id="mathStats">
                        <!-- 数学学科统计信息 -->
                    </div>
                </div>
            </div>
            
            <!-- 英语学科分析 -->
            <div id="english" class="subject-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-globe"></i> 英语成绩分析</h2>
                        <span>平均分: <span id="englishAvg">0</span>分</span>
                    </div>
                    <div class="three-column">
                        <div class="chart-container">
                            <canvas id="englishDistributionChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <canvas id="englishLineChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h3><i class="fas fa-chart-line"></i> 英语与分数线趋势对比</h3>
                                <div style="display: flex; gap: 10px;">
                                    <select id="englishTrendSelect" style="padding: 6px; border-radius: 4px; border: 1px solid #cbd5e0;">
                                        <option value="">选择学生</option>
                                    </select>
                                    <select id="englishTrendExamSelect" style="padding: 6px; border-radius: 4px; border: 1px solid #cbd5e0;">
                                        <option value="all">所有考试</option>
                                    </select>
                                </div>
                            </div>
                            <canvas id="englishTrendChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- 新增：学科分数线差距分析 -->
                    <div class="card" style="margin-top: 20px;">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-ruler"></i> 英语与分数线差距分析</h2>
                            <div style="display: flex; gap: 10px;">
                                <select id="englishDiffStudentSelect" style="padding: 8px; border-radius: 6px; border: 1px solid #cbd5e0;">
                                    <option value="">选择学生查看差距</option>
                                </select>
                            </div>
                        </div>
                        <div id="englishLineDiffContainer">
                            <!-- 英语分数线差距信息通过JS动态生成 -->
                        </div>
                    </div>
                    
                    <div class="stats-grid" style="margin-top: 20px;" id="englishStats">
                        <!-- 英语学科统计信息 -->
                    </div>
                </div>
            </div>
            
            <!-- 物理学科分析 -->
            <div id="physics" class="subject-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-atom"></i> 物理成绩分析</h2>
                        <span>平均分: <span id="physicsAvg">0</span>分</span>
                    </div>
                    <div class="three-column">
                        <div class="chart-container">
                            <canvas id="physicsDistributionChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <canvas id="physicsLineChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h3><i class="fas fa-chart-line"></i> 物理与分数线趋势对比</h3>
                                <div style="display: flex; gap: 10px;">
                                    <select id="physicsTrendSelect" style="padding: 6px; border-radius: 4px; border: 1px solid #cbd5e0;">
                                        <option value="">选择学生</option>
                                    </select>
                                    <select id="physicsTrendExamSelect" style="padding: 6px; border-radius: 4px; border: 1px solid #cbd5e0;">
                                        <option value="all">所有考试</option>
                                    </select>
                                </div>
                            </div>
                            <canvas id="physicsTrendChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- 新增：学科分数线差距分析 -->
                    <div class="card" style="margin-top: 20px;">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-ruler"></i> 物理与分数线差距分析</h2>
                            <div style="display: flex; gap: 10px;">
                                <select id="physicsDiffStudentSelect" style="padding: 8px; border-radius: 6px; border: 1px solid #cbd5e0;">
                                    <option value="">选择学生查看差距</option>
                                </select>
                            </div>
                        </div>
                        <div id="physicsLineDiffContainer">
                            <!-- 物理分数线差距信息通过JS动态生成 -->
                        </div>
                    </div>
                    
                    <div class="stats-grid" style="margin-top: 20px;" id="physicsStats">
                        <!-- 物理学科统计信息 -->
                    </div>
                </div>
            </div>
            
            <!-- 化学学科分析 -->
            <div id="chemistry" class="subject-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-flask"></i> 化学成绩分析</h2>
                        <span>平均分: <span id="chemistryAvg">0</span>分</span>
                    </div>
                    <div class="three-column">
                        <div class="chart-container">
                            <canvas id="chemistryDistributionChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <canvas id="chemistryLineChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h3><i class="fas fa-chart-line"></i> 化学与分数线趋势对比</h3>
                                <div style="display: flex; gap: 10px;">
                                    <select id="chemistryTrendSelect" style="padding: 6px; border-radius: 4px; border: 1px solid #cbd5e0;">
                                        <option value="">选择学生</option>
                                    </select>
                                    <select id="chemistryTrendExamSelect" style="padding: 6px; border-radius: 4px; border: 1px solid #cbd5e0;">
                                        <option value="all">所有考试</option>
                                    </select>
                                </div>
                            </div>
                            <canvas id="chemistryTrendChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- 新增：学科分数线差距分析 -->
                    <div class="card" style="margin-top: 20px;">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-ruler"></i> 化学与分数线差距分析</h2>
                            <div style="display: flex; gap: 10px;">
                                <select id="chemistryDiffStudentSelect" style="padding: 8px; border-radius: 6px; border: 1px solid #cbd5e0;">
                                    <option value="">选择学生查看差距</option>
                                </select>
                            </div>
                        </div>
                        <div id="chemistryLineDiffContainer">
                            <!-- 化学分数线差距信息通过JS动态生成 -->
                        </div>
                    </div>
                    
                    <div class="stats-grid" style="margin-top: 20px;" id="chemistryStats">
                        <!-- 化学学科统计信息 -->
                    </div>
                </div>
            </div>
            
            <!-- 生物学科分析 -->
            <div id="biology" class="subject-content">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-dna"></i> 生物成绩分析</h2>
                        <span>平均分: <span id="biologyAvg">0</span>分</span>
                    </div>
                    <div class="three-column">
                        <div class="chart-container">
                            <canvas id="biologyDistributionChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <canvas id="biologyLineChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h3><i class="fas fa-chart-line"></i> 生物与分数线趋势对比</h3>
                                <div style="display: flex; gap: 10px;">
                                    <select id="biologyTrendSelect" style="padding: 6px; border-radius: 4px; border: 1px solid #cbd5e0;">
                                        <option value="">选择学生</option>
                                    </select>
                                    <select id="biologyTrendExamSelect" style="padding: 6px; border-radius: 4px; border: 1px solid #cbd5e0;">
                                        <option value="all">所有考试</option>
                                    </select>
                                </div>
                            </div>
                            <canvas id="biologyTrendChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- 新增：学科分数线差距分析 -->
                    <div class="card" style="margin-top: 20px;">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-ruler"></i> 生物与分数线差距分析</h2>
                            <div style="display: flex; gap: 10px;">
                                <select id="biologyDiffStudentSelect" style="padding: 8px; border-radius: 6px; border: 1px solid #cbd5e0;">
                                    <option value="">选择学生查看差距</option>
                                </select>
                            </div>
                        </div>
                        <div id="biologyLineDiffContainer">
                            <!-- 生物分数线差距信息通过JS动态生成 -->
                        </div>
                    </div>
                    
                    <div class="stats-grid" style="margin-top: 20px;" id="biologyStats">
                        <!-- 生物学科统计信息 -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 排名分析页面 -->
        <div id="rank-trend" class="tab-content">
            <div class="rank-subtabs">
                <div class="rank-subtab active" data-rank-tab="total-rank">
                    <i class="fas fa-sort-numeric-down"></i> 总分排名趋势
                </div>
                <div class="rank-subtab" data-rank-tab="subject-rank">
                    <i class="fas fa-book"></i> 学科排名趋势
                </div>
            </div>
            
            <!-- 总分排名趋势 -->
            <div id="total-rank" class="rank-subcontent active">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-sort-numeric-down"></i> 学生总分排名趋势分析</h2>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div>
                                <label>选择学生: </label>
                                <select id="rankTrendStudentSelect" style="padding: 8px; border-radius: 6px; border: 1px solid #cbd5e0;">
                                    <option value="">选择学生</option>
                                </select>
                            </div>
                            <div>
                                <label>选择考试: </label>
                                <select id="rankTrendExamSelect" style="padding: 8px; border-radius: 6px; border: 1px solid #cbd5e0;">
                                    <option value="all">所有考试</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" id="analyzeRankTrendBtn">
                                <i class="fas fa-chart-line"></i> 分析排名趋势
                            </button>
                        </div>
                    </div>
                    
                    <div class="two-column">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title"><i class="fas fa-chart-line"></i> 总分排名变化趋势图</h2>
                            </div>
                            <div class="chart-container">
                                <canvas id="rankTrendChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title"><i class="fas fa-table"></i> 详细排名数据</h2>
                            </div>
                            <div class="table-container">
                                <table id="rankTrendTable">
                                    <thead>
                                        <tr>
                                            <th>考试名称</th>
                                            <th>考试时间</th>
                                            <th>总分</th>
                                            <th>年级排名</th>
                                            <th>排名变化</th>
                                            <th>与上次对比</th>
                                        </tr>
                                    </thead>
                                    <tbody id="rankTrendTableBody">
                                        <!-- 排名趋势数据通过JS动态生成 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-chart-bar"></i> 排名统计分析</h2>
                        </div>
                        <div class="stats-grid" id="rankStats">
                            <div class="stat-card">
                                <h3>最佳排名</h3>
                                <div class="stat-value" id="bestRank">--</div>
                                <p id="bestRankExam">--</p>
                            </div>
                            <div class="stat-card">
                                <h3>最差排名</h3>
                                <div class="stat-value" id="worstRank">--</div>
                                <p id="worstRankExam">--</p>
                            </div>
                            <div class="stat-card">
                                <h3>平均排名</h3>
                                <div class="stat-value" id="avgRank">--</div>
                                <p>所有考试平均</p>
                            </div>
                            <div class="stat-card">
                                <h3>排名稳定性</h3>
                                <div class="stat-value" id="rankStability">--</div>
                                <p>排名标准差</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 学科排名趋势 -->
            <div id="subject-rank" class="rank-subcontent">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-book"></i> 学科排名趋势分析</h2>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div>
                                <label>选择学生: </label>
                                <select id="subjectRankStudentSelect" style="padding: 8px; border-radius: 6px; border: 1px solid #cbd5e0;">
                                    <option value="">选择学生</option>
                                </select>
                            </div>
                            <div>
                                <label>选择学科: </label>
                                <select id="subjectRankSubjectSelect" style="padding: 8px; border-radius: 6px; border: 1px solid #cbd5e0;">
                                    <option value="chinese">语文</option>
                                    <option value="math">数学</option>
                                    <option value="english">英语</option>
                                    <option value="physics">物理</option>
                                    <option value="chemistry">化学</option>
                                    <option value="biology">生物</option>
                                </select>
                            </div>
                            <div>
                                <label>选择考试: </label>
                                <select id="subjectRankExamSelect" style="padding: 8px; border-radius: 6px; border: 1px solid #cbd5e0;">
                                    <option value="all">所有考试</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" id="analyzeSubjectRankBtn">
                                <i class="fas fa-chart-line"></i> 分析学科排名趋势
                            </button>
                        </div>
                    </div>
                    
                    <div class="two-column">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title"><i class="fas fa-chart-line"></i> 学科排名变化趋势图</h2>
                            </div>
                            <div class="chart-container">
                                <canvas id="subjectRankTrendChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title"><i class="fas fa-table"></i> 详细学科排名数据</h2>
                            </div>
                            <div class="table-container">
                                <table id="subjectRankTable">
                                    <thead>
                                        <tr>
                                            <th>考试名称</th>
                                            <th>考试时间</th>
                                            <th>学科分数</th>
                                            <th>年级排名</th>
                                            <th>排名变化</th>
                                            <th>与上次对比</th>
                                        </tr>
                                    </thead>
                                    <tbody id="subjectRankTableBody">
                                        <!-- 学科排名趋势数据通过JS动态生成 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-chart-bar"></i> 学科排名统计分析</h2>
                        </div>
                        <div class="stats-grid" id="subjectRankStats">
                            <div class="stat-card">
                                <h3>最佳排名</h3>
                                <div class="stat-value" id="subjectBestRank">--</div>
                                <p id="subjectBestRankExam">--</p>
                            </div>
                            <div class="stat-card">
                                <h3>最差排名</h3>
                                <div class="stat-value" id="subjectWorstRank">--</div>
                                <p id="subjectWorstRankExam">--</p>
                            </div>
                            <div class="stat-card">
                                <h3>平均排名</h3>
                                <div class="stat-value" id="subjectAvgRank">--</div>
                                <p>所有考试平均</p>
                            </div>
                            <div class="stat-card">
                                <h3>排名稳定性</h3>
                                <div class="stat-value" id="subjectRankStability">--</div>
                                <p>排名标准差</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 分数线管理页面 - 重构版 -->
        <div id="score-lines" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-sliders-h"></i> 考试分数线关联管理</h2>
                    <span>当前考试: <span id="currentExamName">默认考试</span></span>
                </div>
                
                <div class="action-buttons" style="margin-bottom: 20px;">
                    <button class="btn btn-success" id="importLinesBtn">
                        <i class="fas fa-file-import"></i> 导入当前考试分数线
                    </button>
                    <button class="btn btn-info" id="applyDefaultLinesBtn">
                        <i class="fas fa-magic"></i> 应用默认分数线
                    </button>
                    <button class="btn btn-warning" id="resetLinesBtn">
                        <i class="fas fa-undo"></i> 重置为默认
                    </button>
                    <button class="btn btn-primary" id="addExamBtn">
                        <i class="fas fa-plus"></i> 添加新考试
                    </button>
                </div>
                
                <!-- 考试管理 -->
                <div class="exam-selector">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3><i class="fas fa-history"></i> 考试管理</h3>
                        <span>共 <span id="examCount">1</span> 个考试</span>
                    </div>
                    <p>选择要设置分数线的考试，分数线会自动与该考试关联</p>
                    <div class="exam-buttons" id="examLineButtons">
                        <!-- 考试按钮通过JS动态生成 -->
                    </div>
                    
                    <!-- 考试管理操作 -->
                    <div class="exam-management" id="examManagement">
                        <!-- 考试管理操作通过JS动态生成 -->
                    </div>
                </div>
                
                <!-- 考试分数线关联状态 -->
                <div class="exam-line-association">
                    <h3><i class="fas fa-link"></i> 考试分数线关联状态</h3>
                    <div id="examLineAssociations">
                        <!-- 关联状态通过JS动态生成 -->
                    </div>
                </div>
                
                <!-- 总分分数线设置 -->
                <div class="score-line-batch">
                    <div class="batch-header">
                        <h3 class="batch-title"><i class="fas fa-star"></i> 总分分数线设置</h3>
                        <span>满分: 750分</span>
                    </div>
                    <table class="score-line-table">
                        <thead>
                            <tr>
                                <th>分数线类型</th>
                                <th>分数</th>
                                <th>说明</th>
                                <th>参考人数</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>双一流线</td>
                                <td><input type="number" id="totalDoubleFirst" value="600.5" min="0" max="750" class="score-line-input"></td>
                                <td>双一流大学录取线</td>
                                <td id="totalDoubleFirstCount">0人</td>
                            </tr>
                            <tr>
                                <td>高优线</td>
                                <td><input type="number" id="totalExcellent" value="556.5" min="0" max="750" class="score-line-input"></td>
                                <td>高水平大学录取线</td>
                                <td id="totalExcellentCount">0人</td>
                            </tr>
                            <tr>
                                <td>重本线</td>
                                <td><input type="number" id="totalFirstTier" value="451.5" min="0" max="750" class="score-line-input"></td>
                                <td>重点本科大学录取线</td>
                                <td id="totalFirstTierCount">0人</td>
                            </tr>
                            <tr>
                                <td>本科线</td>
                                <td><input type="number" id="totalKeyTier" value="328.5" min="0" max="750" class="score-line-input"></td>
                                <td>本科大学录取线</td>
                                <td id="totalKeyTierCount">0人</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- 学科分数线设置 -->
                <div class="score-line-batch">
                    <div class="batch-header">
                        <h3 class="batch-title"><i class="fas fa-book"></i> 学科分数线设置</h3>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                        <!-- 语文学科分数线 -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-language"></i> 语文</h3>
                                <span>满分: 150</span>
                            </div>
                            <div style="display: grid; gap: 15px;">
                                <div>
                                    <label>双一流线: </label>
                                    <input type="number" id="chineseDoubleFirst" value="109" min="0" max="150" class="score-input line-input" style="width: 100%;">
                                    <div style="font-size: 0.8rem; color: #64748b; margin-top: 2px;">人数: <span id="chineseDoubleFirstCount">0</span></div>
                                </div>
                                <div>
                                    <label>高优线: </label>
                                    <input type="number" id="chineseExcellent" value="104" min="0" max="150" class="score-input line-input" style="width: 100%;">
                                    <div style="font-size: 0.8rem; color: #64748b; margin-top: 2px;">人数: <span id="chineseExcellentCount">0</span></div>
                                </div>
                                <div>
                                    <label>重本线: </label>
                                    <input type="number" id="chineseFirstTier" value="87" min="0" max="150" class="score-input line-input" style="width: 100%;">
                                    <div style="font-size: 0.8rem; color: #64748b; margin-top: 2px;">人数: <span id="chineseFirstTierCount">0</span></div>
                                </div>
                                <div>
                                    <label>本科线: </label>
                                    <input type="number" id="chineseKeyTier" value="70" min="0" max="150" class="score-input line-input" style="width: 100%;">
                                    <div style="font-size: 0.8rem; color: #64748b; margin-top: 2px;">人数: <span id="chineseKeyTierCount">0</span></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 数学学科分数线 -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-calculator"></i> 数学</h3>
                                <span>满分: 150</span>
                            </div>
                            <div style="display: grid; gap: 15px;">
                                <div>
                                    <label>双一流线: </label>
                                    <input type="number" id="mathDoubleFirst" value="135" min="0" max="150" class="score-input line-input" style="width: 100%;">
                                    <div style="font-size: 0.8rem; color: #64748b; margin-top: 2px;">人数: <span id="mathDoubleFirstCount">0</span></div>
                                </div>
                                <div>
                                    <label>高优线: </label>
                                    <input type="number" id="mathExcellent" value="117" min="0" max="150" class="score-input line-input" style="width: 100%;">
                                    <div style="font-size: 0.8rem; color: #64748b; margin-top: 2px;">人数: <span id="mathExcellentCount">0</span></div>
                                </div>
                                <div>
                                    <label>重本线: </label>
                                    <input type="number" id="mathFirstTier" value="79" min="0" max="150" class="score-input line-input" style="width: 100%;">
                                    <div style="font-size: 0.8rem; color: #64748b; margin-top: 2px;">人数: <span id="mathFirstTierCount">0</span></div>
                                </div>
                                <div>
                                    <label>本科线: </label>
                                    <input type="number" id="mathKeyTier" value="38" min="0" max="150" class="score-input line-input" style="width: 100%;">
                                    <div style="font-size: 0.8rem; color: #64748b; margin-top: 2px;">人数: <span id="mathKeyTierCount">0</span></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 英语学科分数线 -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-globe"></i> 英语</h3>
                                <span>满分: 150</span>
                            </div>
                            <div style="display: grid; gap: 15px;">
                                <div>
                                    <label>双一流线: </label>
                                    <input type="number" id="englishDoubleFirst" value="132" min="0" max="150" class="score-input line-input" style="width: 100%;">
                                    <div style="font-size: 0.8rem; color: #64748b; margin-top: 2px;">人数: <span id="englishDoubleFirstCount">0</span></div>
                                </div>
                                <div>
                                    <label>高优线: </label>
                                    <input type="number" id="englishExcellent" value="128" min="0" max="150" class="score-input line-input" style="width: 100%;">
                                    <div style="font-size: 0.8rem; color: #64748b; margin-top: 2px;">人数: <span id="englishExcellentCount">0</span></div>
                                </div>
                                <div>
                                    <label>重本线: </label>
                                    <input type="number" id="englishFirstTier" value="107.5" min="0" max="150" class="score-input line-input" style="width: 100%;">
                                    <div style="font-size: 0.8rem; color: #64748b; margin-top: 2px;">人数: <span id="englishFirstTierCount">0</span></div>
                                </div>
                                <div>
                                    <label>本科线: </label>
                                    <input type="number" id="englishKeyTier" value="63" min="0" max="150" class="score-input line-input" style="width: 100%;">
                                    <div style="font-size: 0.8rem; color: #64748b; margin-top: 2px;">人数: <span id="englishKeyTierCount">0</span></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 物理学科分数线 -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-atom"></i> 物理</h3>
                                <span>满分: 100</span>
                            </div>
                            <div style="display: grid; gap: 15px;">
                                <div>
                                    <label>双一流线: </label>
                                    <input type="number" id="physicsDoubleFirst" value="81" min="0" max="100" class="score-input line-input" style="width: 100%;">
                                    <div style="font-size: 0.8rem; color: #64748b; margin-top: 2px;">人数: <span id="physicsDoubleFirstCount">0</span></div>
                                </div>
                                <div>
                                    <label>高优线: </label>
                                    <input type="number" id="physicsExcellent" value="72" min="0" max="100" class="score-input line-input" style="width: 100%;">
                                    <div style="font-size: 0.8rem; color: #64748b; margin-top: 2px;">人数: <span id="physicsExcellentCount">0</span></div>
                                </div>
                                <div>
                                    <label>重本线: </label>
                                    <input type="number" id="physicsFirstTier" value="39" min="0" max="100" class="score-input line-input" style="width: 100%;">
                                    <div style="font-size: 0.8rem; color: #64748b; margin-top: 2px;">人数: <span id="physicsFirstTierCount">0</span></div>
                                </div>
                                <div>
                                    <label>本科线: </label>
                                    <input type="number" id="physicsKeyTier" value="20" min="0" max="100" class="score-input line-input" style="width: 100%;">
                                    <div style="font-size: 0.8rem; color: #64748b; margin-top: 2px;">人数: <span id="physicsKeyTierCount">0</span></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 化学学科分数线 -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-flask"></i> 化学</h3>
                                <span>满分: 100</span>
                            </div>
                            <div style="display: grid; gap: 15px;">
                                <div>
                                    <label>双一流线: </label>
                                    <input type="number" id="chemistryDoubleFirst" value="99" min="0" max="100" class="score-input line-input" style="width: 100%;">
                                    <div style="font-size: 0.8rem; color: #64748b; margin-top: 2px;">人数: <span id="chemistryDoubleFirstCount">0</span></div>
                                </div>
                                <div>
                                    <label>高优线: </label>
                                    <input type="number" id="chemistryExcellent" value="89" min="0" max="100" class="score-input line-input" style="width: 100%;">
                                    <div style="font-size: 0.8rem; color: #64748b; margin-top: 2px;">人数: <span id="chemistryExcellentCount">0</span></div>
                                </div>
                                <div>
                                    <label>重本线: </label>
                                    <input type="number" id="chemistryFirstTier" value="66" min="0" max="100" class="score-input line-input" style="width: 100%;">
                                    <div style="font-size: 0.8rem; color: #64748b; margin-top: 2px;">人数: <span id="chemistryFirstTierCount">0</span></div>
                                </div>
                                <div>
                                    <label>本科线: </label>
                                    <input type="number" id="chemistryKeyTier" value="38" min="0" max="100" class="score-input line-input" style="width: 100%;">
                                    <div style="font-size: 0.8rem; color: #64748b; margin-top: 2px;">人数: <span id="chemistryKeyTierCount">0</span></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 生物学科分数线 -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-dna"></i> 生物</h3>
                                <span>满分: 100</span>
                            </div>
                            <div style="display: grid; gap: 15px;">
                                <div>
                                    <label>双一流线: </label>
                                    <input type="number" id="biologyDoubleFirst" value="94" min="0" max="100" class="score-input line-input" style="width: 100%;">
                                    <div style="font-size: 0.8rem; color: #64748b; margin-top: 2px;">人数: <span id="biologyDoubleFirstCount">0</span></div>
                                </div>
                                <div>
                                    <label>高优线: </label>
                                    <input type="number" id="biologyExcellent" value="90" min="0" max="100" class="score-input line-input" style="width: 100%;">
                                    <div style="font-size: 0.8rem; color: #64748b; margin-top: 2px;">人数: <span id="biologyExcellentCount">0</span></div>
                                </div>
                                <div>
                                    <label>重本线: </label>
                                    <input type="number" id="biologyFirstTier" value="64" min="0" max="100" class="score-input line-input" style="width: 100%;">
                                    <div style="font-size: 0.8rem; color: #64748b; margin-top: 2px;">人数: <span id="biologyFirstTierCount">0</span></div>
                                </div>
                                <div>
                                    <label>本科线: </label>
                                    <input type="number" id="biologyKeyTier" value="34" min="0" max="100" class="score-input line-input" style="width: 100%;">
                                    <div style="font-size: 0.8rem; color: #64748b; margin-top: 2px;">人数: <span id="biologyKeyTierCount">0</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 分数线导入区域 -->
                <div class="score-line-import" id="scoreLineImportArea">
                    <h3><i class="fas fa-file-excel"></i> 分数线Excel导入（智能识别）</h3>
                    
                    <div class="smart-recognition">
                        <h5><i class="fas fa-brain"></i> 智能识别功能</h5>
                        <p>• 自动识别科目名称：语文、数学、英语、物理、化学、生物、总分等</p>
                        <p>• 自动识别分数线类型：本科线、重本线、高优线、双一流线等</p>
                        <p>• 支持多种格式：行列式、表格式、混合式等</p>
                        <p>• 自动匹配并应用数据到当前考试</p>
                    </div>
                    
                    <div class="file-upload-area" id="scoreLineFileUpload">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h4>点击或拖拽分数线Excel文件到此处</h4>
                        <p>支持 .xlsx, .xls, .csv 格式（系统会自动智能识别）</p>
                        <p class="btn btn-primary" style="display: inline-block; margin-top: 10px;">
                            <i class="fas fa-file-upload"></i> 选择文件
                        </p>
                        <input type="file" id="scoreLineExcelFile" accept=".xlsx,.xls,.csv" style="display: none;">
                    </div>
                    
                    <div class="format-guide" style="margin-top: 15px;">
                        <h4><i class="fas fa-info-circle"></i> 支持的数据格式示例</h4>
                        <p>系统会自动识别以下格式：</p>
                        <ul>
                            <li><strong>格式一（推荐）：</strong> 每行一个科目，包含分数线类型和分数</li>
                            <li><strong>格式二：</strong> 科目为列，分数线类型为行</li>
                            <li><strong>格式三：</strong> 混合格式，系统会自动匹配</li>
                        </ul>
                        <p><small>提示：系统会智能识别科目和分数线类型，无需固定格式</small></p>
                    </div>
                    
                    <div class="action-buttons" style="margin-top: 20px;">
                        <button class="btn btn-success" id="importScoreLinesBtn" disabled>
                            <i class="fas fa-file-import"></i> 导入分数线
                        </button>
                        <button class="btn btn-info" id="downloadScoreLineTemplateBtn">
                            <i class="fas fa-download"></i> 下载模板
                        </button>
                    </div>
                    
                    <div id="scoreLinePreview" style="margin-top: 20px; display: none;">
                        <h4>智能识别结果预览</h4>
                        <div id="recognitionResult" class="smart-recognition" style="margin-bottom: 15px;">
                            <!-- 智能识别结果 -->
                        </div>
                        <div class="exam-preview">
                            <table id="scoreLinePreviewTable">
                                <thead></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 导入确认模态框 -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-file-excel"></i> 确认导入</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>检测到 <span id="rowCount">0</span> 条学生记录，请确认：</p>
                <div class="data-summary" id="modalDataSummary">
                    <!-- 模态框中的数据统计 -->
                </div>
                <div class="exam-preview" style="margin: 15px 0;">
                    <table id="modalPreviewTable">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <p><strong>导入方式:</strong> <span id="importModeText">追加到现有数据</span></p>
                    <div id="examNameInputContainer">
                        <p><strong>考试名称:</strong> <input type="text" id="examNameInput" placeholder="请输入考试名称，如：第一次月考" style="width: 100%; margin-top: 5px; padding: 8px;"></p>
                        <p><strong>考试日期:</strong> <input type="date" id="examDateInput" style="width: 100%; margin-top: 5px; padding: 8px;"></p>
                    </div>
                    <p><small>系统会根据学生姓名智能匹配数据</small></p>
                </div>
            </div>
            <div class="action-buttons" style="margin-top: 20px;">
                <button class="btn btn-danger" id="cancelImportBtn">取消</button>
                <button class="btn btn-success" id="confirmImportBtn">确认导入</button>
            </div>
        </div>
    </div>

    <!-- 导入分数线确认模态框 -->
    <div id="importLinesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-file-excel"></i> 确认导入分数线</h3>
                <button class="modal-close" data-modal="importLinesModal">&times;</button>
            </div>
            <div class="modal-body">
                <p>检测到分数线数据，请确认导入到当前考试：</p>
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-top: 10px;">
                    <p><strong>当前考试:</strong> <span id="currentExamNameForLines">--</span></p>
                    <p><strong>智能识别结果:</strong> <span id="lineDataCount">0</span> 条分数线记录</p>
                    <p><strong>识别科目:</strong> <span id="recognizedSubjects">--</span></p>
                    <p><small>导入后，这些分数线将自动与当前考试关联</small></p>
                </div>
                <div class="exam-preview" style="margin: 15px 0;">
                    <table id="importLinesPreviewTable">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="action-buttons" style="margin-top: 20px;">
                <button class="btn btn-danger" id="cancelImportLinesBtn">取消</button>
                    <button class="btn btn-success" id="confirmImportLinesBtn">确认导入</button>
            </div>
        </div>
    </div>

    <!-- 考试编辑模态框 -->
    <div id="editExamModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-edit"></i> 编辑考试信息</h3>
                <button class="modal-close" data-modal="editExamModal">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">考试名称</label>
                    <input type="text" id="editExamName" placeholder="请输入考试名称" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">考试日期</label>
                    <input type="date" id="editExamDate" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px;">
                </div>
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
                    <p><strong>提示：</strong>修改考试名称后，系统中所有相关显示都会自动更新</p>
                </div>
            </div>
            <div class="action-buttons" style="margin-top: 20px;">
                <button class="btn btn-danger" id="cancelEditExamBtn">取消</button>
                <button class="btn btn-success" id="saveEditExamBtn">保存</button>
            </div>
        </div>
    </div>

    <script>
        // 初始化数据
        let students = []; // 所有学生的基本信息
        let studentExamData = {}; // 按姓名索引的考试数据

        // 分数线设置 - 默认值
        let scoreLines = {
            total: { doubleFirst: 600.5, excellent: 556.5, firstTier: 451.5, keyTier: 328.5 },
            chinese: { doubleFirst: 109, excellent: 104, firstTier: 87, keyTier: 70 },
            math: { doubleFirst: 135, excellent: 117, firstTier: 79, keyTier: 38 },
            english: { doubleFirst: 132, excellent: 128, firstTier: 107.5, keyTier: 63 },
            physics: { doubleFirst: 81, excellent: 72, firstTier: 39, keyTier: 20 },
            chemistry: { doubleFirst: 99, excellent: 89, firstTier: 66, keyTier: 38 },
            biology: { doubleFirst: 94, excellent: 90, firstTier: 64, keyTier: 34 }
        };

        // 多考试数据 - 重构：每个考试包含自己的分数线和学生数据
        let exams = [
            {
                id: 1,
                name: '默认考试',
                date: new Date().toISOString().split('T')[0],
                data: [],
                lines: JSON.parse(JSON.stringify(scoreLines)),
                selected: true,
                hasLines: true
            }
        ];
        
        // 当前选中的考试
        let currentExamId = 1;
        // 当前分数线设置对应的考试ID
        let currentLineExamId = 1;
        // 选中的考试用于趋势分析
        let selectedExamIds = [1];
        // 正在编辑的考试ID
        let editingExamId = null;
        
        // 新增：总分分析页面当前选中的考试ID
        let totalAnalysisExamId = 1;
        // 新增：学科分析页面当前选中的考试ID
        let subjectAnalysisExamId = 1;

        // 图表实例
        let charts = {};

        // Excel导入数据
        let importData = null;
        // 分数线导入数据
        let scoreLineImportData = null;
        // 智能识别结果
        let recognitionResult = null;

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // 渲染学生表格
            renderStudentTable();
            
            // 更新统计数据
            updateClassStats();
            
            // 更新分数线显示
            updateScoreLineDisplay();
            
            // 初始化图表
            initCharts();
            
            // 绑定所有事件
            bindEvents();
            
            // 更新学生选择下拉框
            updateStudentSelects();
            
            // 更新考试数据显示
            updateExamDisplay();
            
            // 更新考试选择下拉框
            updateExamSelects();
            
            // 更新考试复选框
            updateExamCheckboxes();
            
            // 更新分数线批次显示
            updateExamLineDisplay();
            
            // 更新当前考试显示
            updateCurrentExamDisplay();
            
            // 更新考试分数线关联状态
            updateExamLineAssociations();
            
            // 更新分数线人数统计
            updateLineCounts();
            
            // 更新考试管理界面
            updateExamManagement();
            
            // 新增：更新总分分析考试选择器
            updateTotalAnalysisExamSelector();
            
            // 新增：更新学科分析考试选择器
            updateSubjectAnalysisExamSelector();
        }

        // 绑定所有事件
        function bindEvents() {
            // 导航标签点击事件
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });

            // 学科标签点击事件
            document.querySelectorAll('.subject-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const subject = this.getAttribute('data-subject');
                    switchSubject(subject);
                });
            });

            // 排名子标签页点击事件
            document.querySelectorAll('.rank-subtab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-rank-tab');
                    switchRankTab(tabId);
                });
            });

            // 文件上传事件
            document.getElementById('fileUploadArea').addEventListener('click', function() {
                document.getElementById('excelFile').click();
            });

            document.getElementById('excelFile').addEventListener('change', handleFileSelect);
            
            // 分数线文件上传事件
            document.getElementById('scoreLineFileUpload').addEventListener('click', function() {
                document.getElementById('scoreLineExcelFile').click();
            });

            document.getElementById('scoreLineExcelFile').addEventListener('change', handleScoreLineFileSelect);
            
            // 拖拽上传事件
            setupDragAndDrop();
            
            // 按钮点击事件
            document.getElementById('importBtn').addEventListener('click', showImportModal);
            document.getElementById('downloadTemplateBtn').addEventListener('click', downloadTemplate);
            document.getElementById('updateLinesBtn').addEventListener('click', updateTotalScoreLines);
            document.getElementById('addStudentBtn').addEventListener('click', addNewStudent);
            document.getElementById('calculateStatsBtn').addEventListener('click', updateClassStats);
            document.getElementById('generateReportBtn').addEventListener('click', generateReport);
            document.getElementById('resetDataBtn').addEventListener('click', resetData);
            document.getElementById('resetLinesBtn').addEventListener('click', resetScoreLines);
            document.getElementById('importLinesBtn').addEventListener('click', showImportLinesModal);
            document.getElementById('applyDefaultLinesBtn').addEventListener('click', applyDefaultScoreLines);
            document.getElementById('importScoreLinesBtn').addEventListener('click', showImportScoreLinesModal);
            document.getElementById('downloadScoreLineTemplateBtn').addEventListener('click', downloadScoreLineTemplate);
            document.getElementById('addExamBtn').addEventListener('click', addNewExam);
            
            // 多考试管理按钮
            document.getElementById('selectAllExamsBtn').addEventListener('click', selectAllExams);
            document.getElementById('deselectAllExamsBtn').addEventListener('click', deselectAllExams);
            document.getElementById('applyExamSelectionBtn').addEventListener('click', applyExamSelection);
            
            // 排名趋势分析按钮
            document.getElementById('analyzeRankTrendBtn').addEventListener('click', updateRankTrendAnalysis);
            document.getElementById('analyzeSubjectRankBtn').addEventListener('click', updateSubjectRankTrendAnalysis);
            
            // 模态框事件
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', function() {
                    const modalId = this.getAttribute('data-modal') || 'importModal';
                    closeModal(modalId);
                });
            });
            
            document.getElementById('cancelImportBtn').addEventListener('click', function() {
                closeModal('importModal');
            });
            
            document.getElementById('confirmImportBtn').addEventListener('click', confirmImport);
            
            document.getElementById('cancelImportLinesBtn').addEventListener('click', function() {
                closeModal('importLinesModal');
            });
            
            document.getElementById('confirmImportLinesBtn').addEventListener('click', confirmImportLines);
            
            document.getElementById('cancelEditExamBtn').addEventListener('click', function() {
                closeModal('editExamModal');
            });
            
            document.getElementById('saveEditExamBtn').addEventListener('click', saveExamEdit);
            
            // 学生选择变化事件
            document.getElementById('studentSelect').addEventListener('change', updateRadarChart);
            document.getElementById('radarExamSelect').addEventListener('change', updateRadarChart);
            document.getElementById('trendStudentSelect').addEventListener('change', updateTrendChart);
            document.getElementById('trendExamSelect').addEventListener('change', updateTrendChart);
            
            // 排名趋势选择变化事件
            document.getElementById('rankTrendStudentSelect').addEventListener('change', function() {
                if (this.value) {
                    updateRankTrendAnalysis();
                }
            });
            
            document.getElementById('rankTrendExamSelect').addEventListener('change', function() {
                updateRankTrendAnalysis();
            });
            
            // 学科排名趋势选择变化事件
            document.getElementById('subjectRankStudentSelect').addEventListener('change', function() {
                if (this.value) {
                    updateSubjectRankTrendAnalysis();
                }
            });
            
            document.getElementById('subjectRankSubjectSelect').addEventListener('change', function() {
                updateSubjectRankTrendAnalysis();
            });
            
            document.getElementById('subjectRankExamSelect').addEventListener('change', function() {
                updateSubjectRankTrendAnalysis();
            });
            
            // 学科趋势选择变化事件
            const subjects = ['chinese', 'math', 'english', 'physics', 'chemistry', 'biology'];
            subjects.forEach(subject => {
                document.getElementById(`${subject}TrendSelect`)?.addEventListener('change', function() {
                    updateSubjectTrendChart(subject);
                });
                
                document.getElementById(`${subject}TrendExamSelect`)?.addEventListener('change', function() {
                    updateSubjectTrendChart(subject);
                });
                
                // 分数线差距选择变化事件
                document.getElementById(`${subject}DiffStudentSelect`)?.addEventListener('change', function() {
                    updateSubjectLineDiffAnalysis(subject);
                });
            });
            
            // 总分差距选择变化事件
            document.getElementById('totalDiffStudentSelect')?.addEventListener('change', function() {
                updateTotalLineDiffAnalysis();
            });
            
            // 修复分数线输入框问题
            document.querySelectorAll('.line-input, .score-line-input').forEach(input => {
                input.addEventListener('blur', handleLineInputBlur);
                input.addEventListener('change', handleLineInputChange);
            });
            
            // 修复学生成绩输入框事件
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('score-input') && !e.target.classList.contains('line-input') && !e.target.classList.contains('score-line-input')) {
                    updateStudentScore(e.target);
                }
            });
            
            // 修复导入模式选择事件
            document.getElementById('importMode').addEventListener('change', function() {
                const examNameContainer = document.getElementById('examNameInputContainer');
                if (this.value === 'new-exam') {
                    examNameContainer.style.display = 'block';
                    document.getElementById('examNameInput').value = '';
                    document.getElementById('examDateInput').value = new Date().toISOString().split('T')[0];
                } else {
                    examNameContainer.style.display = 'none';
                }
            });
        }

        // 设置拖拽上传功能
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('fileUploadArea');
            const scoreLineUploadArea = document.getElementById('scoreLineFileUpload');
            
            // 阻止默认拖放行为
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
                scoreLineUploadArea.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            
            // 高亮拖拽区域
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
                scoreLineUploadArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
                scoreLineUploadArea.addEventListener(eventName, unhighlight, false);
            });
            
            // 处理文件放置
            uploadArea.addEventListener('drop', handleDrop, false);
            scoreLineUploadArea.addEventListener('drop', handleScoreLineDrop, false);
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function highlight() {
                this.style.borderColor = '#4361ee';
                this.style.backgroundColor = '#f8fafc';
            }
            
            function unhighlight() {
                this.style.borderColor = '#94a3b8';
                this.style.backgroundColor = 'white';
            }
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    const file = files[0];
                    if (file.name.match(/\.(xlsx|xls|csv)$/i)) {
                        document.getElementById('excelFile').files = files;
                        handleFileSelect({ target: { files: files } });
                    } else {
                        alert('请选择Excel文件 (.xlsx, .xls, .csv)');
                    }
                }
            }
            
            function handleScoreLineDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    const file = files[0];
                    if (file.name.match(/\.(xlsx|xls|csv)$/i)) {
                        document.getElementById('scoreLineExcelFile').files = files;
                        handleScoreLineFileSelect({ target: { files: files } });
                    } else {
                        alert('请选择Excel文件 (.xlsx, .xls, .csv)');
                    }
                }
            }
        }

        // 处理文件选择 - 优化版，改进Excel识别
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // 检查文件类型
            if (!file.name.match(/\.(xlsx|xls|csv)$/i)) {
                alert('请选择Excel文件 (.xlsx, .xls, .csv)');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // 获取第一个工作表
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // 将工作表转换为JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
                    
                    console.log('Excel数据读取成功:', jsonData);
                    
                    // 处理Excel数据
                    const processedData = processExcelData(jsonData);
                    if (processedData && processedData.length > 0) {
                        importData = processedData;
                        showDataPreview(processedData);
                        document.getElementById('importBtn').disabled = false;
                    }
                } catch (error) {
                    console.error('Excel读取错误:', error);
                    alert('文件读取失败: ' + error.message);
                }
            };
            
            reader.onerror = function(e) {
                alert('文件读取错误，请确保文件格式正确');
            };
            
            reader.readAsArrayBuffer(file);
        }

        // 处理分数线Excel文件选择 - 智能识别版
        function handleScoreLineFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // 检查文件类型
            if (!file.name.match(/\.(xlsx|xls|csv)$/i)) {
                alert('请选择Excel文件 (.xlsx, .xls, .csv)');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // 获取第一个工作表
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // 将工作表转换为JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
                    
                    console.log('分数线Excel数据读取成功:', jsonData);
                    
                    // 智能识别分数线数据
                    const processedData = intelligentRecognitionScoreLines(jsonData);
                    if (processedData) {
                        scoreLineImportData = processedData.data;
                        recognitionResult = processedData.recognition;
                        showScoreLineDataPreview(processedData);
                        document.getElementById('importScoreLinesBtn').disabled = false;
                    }
                } catch (error) {
                    console.error('分数线Excel读取错误:', error);
                    alert('文件读取失败: ' + error.message);
                }
            };
            
            reader.onerror = function(e) {
                alert('文件读取错误，请确保文件格式正确');
            };
            
            reader.readAsArrayBuffer(file);
        }

        // 智能识别分数线数据 - 改进版，支持多种格式
        function intelligentRecognitionScoreLines(jsonData) {
            if (!jsonData || jsonData.length === 0) {
                alert('Excel文件数据为空或格式不正确');
                return null;
            }
            
            console.log('原始分数线Excel数据:', jsonData);
            
            // 获取第一行数据作为样本
            const firstRow = jsonData[0];
            if (!firstRow) {
                alert('Excel文件中没有数据');
                return null;
            }
            
            console.log('第一行数据:', firstRow);
            
            // 获取所有列名
            const columnNames = Object.keys(firstRow);
            console.log('所有列名:', columnNames);
            
            // 智能识别结果
            const recognition = {
                method: '',
                subjects: [],
                lineTypes: [],
                notes: []
            };
            
            // 尝试不同的识别方法
            
            // 方法1：行列式（科目为行，分数线类型为列）
            let result = recognizeRowColumnFormat(jsonData, columnNames);
            if (result) {
                recognition.method = '行列式识别';
                recognition.subjects = result.subjects;
                recognition.lineTypes = result.lineTypes;
                recognition.notes = result.notes;
                return result;
            }
            
            // 方法2：表格式（科目为列，分数线类型为行）
            result = recognizeColumnRowFormat(jsonData, columnNames);
            if (result) {
                recognition.method = '表格式识别';
                recognition.subjects = result.subjects;
                recognition.lineTypes = result.lineTypes;
                recognition.notes = result.notes;
                return result;
            }
            
            // 方法3：混合格式识别
            result = recognizeMixedFormat(jsonData, columnNames);
            if (result) {
                recognition.method = '混合格式识别';
                recognition.subjects = result.subjects;
                recognition.lineTypes = result.lineTypes;
                recognition.notes = result.notes;
                return result;
            }
            
            alert('无法识别分数线数据格式，请检查文件格式');
            return null;
        }

        // 识别行列式格式（科目为行，分数线类型为列）
        function recognizeRowColumnFormat(jsonData, columnNames) {
            console.log('尝试行列式识别...');
            
            // 查找可能的科目列和分数线列
            let subjectColumn = null;
            const lineColumns = {};
            
            // 科目名称关键词
            const subjectKeywords = ['科目', '学科', '项目', '名称', 'subject', 'course'];
            // 分数线类型关键词
            const lineTypeKeywords = {
                'keyTier': ['本科线', '本科', '二本', '二批', '普通'],
                'firstTier': ['重本线', '重本', '一本', '一批', '重点'],
                'excellent': ['高优线', '高优', '优秀', '特优', '卓越'],
                'doubleFirst': ['双一流线', '双一流', '顶尖', '一流']
            };
            
            // 识别列
            for (const colName of columnNames) {
                const colNameLower = colName.toLowerCase().trim();
                
                // 检查是否是科目列
                for (const keyword of subjectKeywords) {
                    if (colNameLower.includes(keyword.toLowerCase())) {
                        subjectColumn = colName;
                        console.log(`识别到科目列: ${colName}`);
                        break;
                    }
                }
                
                // 检查是否是分数线列
                for (const [lineCode, keywords] of Object.entries(lineTypeKeywords)) {
                    for (const keyword of keywords) {
                        if (colNameLower.includes(keyword.toLowerCase())) {
                            lineColumns[lineCode] = colName;
                            console.log(`识别到${lineCode}列: ${colName}`);
                            break;
                        }
                    }
                }
            }
            
            // 如果没有找到科目列，假设第一列是科目
            if (!subjectColumn && columnNames.length > 0) {
                subjectColumn = columnNames[0];
                console.log(`假设第一列为科目: ${subjectColumn}`);
            }
            
            // 检查是否识别到足够的列
            const recognizedLineTypes = Object.keys(lineColumns);
            if (!subjectColumn || recognizedLineTypes.length < 2) {
                console.log('行列式识别失败: 列识别不足');
                return null;
            }
            
            console.log('识别到的分数线类型:', recognizedLineTypes);
            
            // 解析数据
            const lineData = {};
            const subjects = [];
            const lineTypes = [];
            
            for (let i = 0; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row) continue;
                
                // 获取科目
                let subject = String(row[subjectColumn] || '').trim();
                if (!subject) continue;
                
                // 标准化科目名称
                let subjectCode = standardizeSubjectName(subject);
                if (!subjectCode) continue;
                
                subjects.push(subject);
                
                // 初始化科目数据
                if (!lineData[subjectCode]) {
                    lineData[subjectCode] = {};
                }
                
                // 解析各分数线
                for (const [lineCode, colName] of Object.entries(lineColumns)) {
                    const value = parseFloat(row[colName]);
                    if (!isNaN(value) && value > 0) {
                        lineData[subjectCode][lineCode] = value;
                        if (!lineTypes.includes(lineCode)) {
                            lineTypes.push(lineCode);
                        }
                    }
                }
            }
            
            if (Object.keys(lineData).length === 0) {
                console.log('行列式识别失败: 无有效数据');
                return null;
            }
            
            console.log('行列式识别成功:', lineData);
            
            return {
                data: lineData,
                subjects: [...new Set(subjects)],
                lineTypes: lineTypes,
                notes: [
                    `识别方式: 行列式（科目为行）`,
                    `识别到科目: ${subjects.length}个`,
                    `识别到分数线类型: ${lineTypes.length}种`
                ]
            };
        }

        // 识别表格式格式（科目为列，分数线类型为行）
        function recognizeColumnRowFormat(jsonData, columnNames) {
            console.log('尝试表格式识别...');
            
            // 查找可能的分数线类型行标识
            let lineTypeColumn = null;
            const subjectColumns = {};
            
            // 分数线类型关键词
            const lineTypeKeywords = ['本科线', '重本线', '高优线', '双一流线', '本科', '重本', '高优', '双一流'];
            
            // 识别第一列是否是分数线类型
            const firstColumn = columnNames[0];
            const firstColumnLower = firstColumn.toLowerCase().trim();
            
            for (const keyword of lineTypeKeywords) {
                if (firstColumnLower.includes(keyword.toLowerCase())) {
                    lineTypeColumn = firstColumn;
                    console.log(`识别到分数线类型列: ${firstColumn}`);
                    break;
                }
            }
            
            // 如果没有识别到分数线类型列，尝试查找
            if (!lineTypeColumn) {
                // 查找包含"类型"、"名称"等的列
                for (const colName of columnNames) {
                    const colNameLower = colName.toLowerCase().trim();
                    if (colNameLower.includes('类型') || colNameLower.includes('名称') || 
                        colNameLower.includes('分数线') || colNameLower.includes('line')) {
                        lineTypeColumn = colName;
                        console.log(`假设为分数线类型列: ${colName}`);
                        break;
                    }
                }
            }
            
            if (!lineTypeColumn && columnNames.length > 0) {
                lineTypeColumn = columnNames[0];
                console.log(`假设第一列为分数线类型: ${lineTypeColumn}`);
            }
            
            // 识别科目列
            for (let i = 1; i < columnNames.length; i++) {
                const colName = columnNames[i];
                const colNameLower = colName.toLowerCase().trim();
                
                // 标准化科目名称
                const subjectCode = standardizeSubjectName(colName);
                if (subjectCode) {
                    subjectColumns[subjectCode] = colName;
                    console.log(`识别到科目列 ${subjectCode}: ${colName}`);
                }
            }
            
            // 检查是否识别到足够的列
            if (!lineTypeColumn || Object.keys(subjectColumns).length < 2) {
                console.log('表格式识别失败: 列识别不足');
                return null;
            }
            
            console.log('识别到的科目:', Object.keys(subjectColumns));
            
            // 解析数据
            const lineData = {};
            const subjects = [];
            const lineTypes = [];
            
            // 初始化科目数据
            for (const [subjectCode, colName] of Object.entries(subjectColumns)) {
                lineData[subjectCode] = {};
                subjects.push(colName);
            }
            
            for (let i = 0; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row) continue;
                
                // 获取分数线类型
                let lineType = String(row[lineTypeColumn] || '').trim();
                if (!lineType) continue;
                
                // 标准化分数线类型
                const lineCode = standardizeLineType(lineType);
                if (!lineCode) continue;
                
                lineTypes.push(lineCode);
                
                // 解析各科目分数
                for (const [subjectCode, colName] of Object.entries(subjectColumns)) {
                    const value = parseFloat(row[colName]);
                    if (!isNaN(value) && value > 0) {
                        lineData[subjectCode][lineCode] = value;
                    }
                }
            }
            
            if (lineTypes.length === 0) {
                console.log('表格式识别失败: 无有效分数线类型');
                return null;
            }
            
            console.log('表格式识别成功:', lineData);
            
            return {
                data: lineData,
                subjects: subjects,
                lineTypes: [...new Set(lineTypes)],
                notes: [
                    `识别方式: 表格式（科目为列）`,
                    `识别到科目: ${subjects.length}个`,
                    `识别到分数线类型: ${lineTypes.length}种`
                ]
            };
        }

        // 识别混合格式
        function recognizeMixedFormat(jsonData, columnNames) {
            console.log('尝试混合格式识别...');
            
            // 收集所有可能的科目和分数线
            const allSubjects = new Set();
            const allLineTypes = new Set();
            const potentialData = {};
            
            // 遍历所有数据
            for (let i = 0; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row) continue;
                
                // 检查每一列
                for (const colName of columnNames) {
                    const value = row[colName];
                    if (!value && value !== 0) continue;
                    
                    const valueStr = String(value).trim();
                    
                    // 检查是否是科目名称
                    const subjectCode = standardizeSubjectName(valueStr);
                    if (subjectCode) {
                        allSubjects.add(valueStr);
                        continue;
                    }
                    
                    // 检查是否是分数线类型
                    const lineCode = standardizeLineType(valueStr);
                    if (lineCode) {
                        allLineTypes.add(valueStr);
                        continue;
                    }
                    
                    // 检查是否是数字（可能是分数）
                    const numValue = parseFloat(value);
                    if (!isNaN(numValue) && numValue > 0) {
                        // 尝试根据上下文确定这个数字是什么
                        // 检查同一行的其他列
                        for (const otherCol of columnNames) {
                            if (otherCol === colName) continue;
                            
                            const otherValue = row[otherCol];
                            if (!otherValue) continue;
                            
                            const otherValueStr = String(otherValue).trim();
                            
                            // 检查是否是科目
                            const otherSubjectCode = standardizeSubjectName(otherValueStr);
                            if (otherSubjectCode) {
                                if (!potentialData[otherSubjectCode]) {
                                    potentialData[otherSubjectCode] = {};
                                }
                                
                                // 检查是否是分数线类型
                                const colNameLower = colName.toLowerCase().trim();
                                const lineCodeFromCol = standardizeLineTypeFromColumn(colNameLower);
                                if (lineCodeFromCol) {
                                    potentialData[otherSubjectCode][lineCodeFromCol] = numValue;
                                    allLineTypes.add(lineCodeFromCol);
                                }
                                break;
                            }
                            
                            // 检查是否是分数线类型
                            const otherLineCode = standardizeLineType(otherValueStr);
                            if (otherLineCode) {
                                // 这个数字可能是某个科目的分数
                                // 需要更多的上下文信息
                            }
                        }
                    }
                }
            }
            
            // 如果找到足够的数据
            if (Object.keys(potentialData).length >= 2) {
                console.log('混合格式识别成功（部分）:', potentialData);
                
                const subjects = Object.keys(potentialData).map(code => {
                    const name = getSubjectName(code) || code;
                    return name;
                });
                
                const lineTypes = [];
                Object.values(potentialData).forEach(data => {
                    Object.keys(data).forEach(lineCode => {
                        if (!lineTypes.includes(lineCode)) {
                            lineTypes.push(lineCode);
                        }
                    });
                });
                
                return {
                    data: potentialData,
                    subjects: subjects,
                    lineTypes: lineTypes,
                    notes: [
                        `识别方式: 混合格式智能识别`,
                        `识别到科目: ${subjects.length}个`,
                        `识别到分数线类型: ${lineTypes.length}种`,
                        `提示: 部分数据可能需要手动确认`
                    ]
                };
            }
            
            console.log('混合格式识别失败');
            return null;
        }

        // 标准化科目名称
        function standardizeSubjectName(subject) {
            if (!subject) return null;
            
            const subjectLower = subject.toLowerCase().trim();
            
            if (subjectLower.includes('总分') || subjectLower.includes('total') || subjectLower.includes('合计')) {
                return 'total';
            } else if (subjectLower.includes('语文') || subjectLower.includes('chinese') || subjectLower.includes('中文')) {
                return 'chinese';
            } else if (subjectLower.includes('数学') || subjectLower.includes('math') || subjectLower.includes('mathematics')) {
                return 'math';
            } else if (subjectLower.includes('英语') || subjectLower.includes('english') || subjectLower.includes('英文')) {
                return 'english';
            } else if (subjectLower.includes('物理') || subjectLower.includes('physics')) {
                return 'physics';
            } else if (subjectLower.includes('化学') || subjectLower.includes('chemistry')) {
                return 'chemistry';
            } else if (subjectLower.includes('生物') || subjectLower.includes('biology')) {
                return 'biology';
            }
            
            return null;
        }

        // 标准化分数线类型
        function standardizeLineType(lineType) {
            if (!lineType) return null;
            
            const lineTypeLower = lineType.toLowerCase().trim();
            
            if (lineTypeLower.includes('双一流') || lineTypeLower.includes('顶尖') || lineTypeLower.includes('一流')) {
                return 'doubleFirst';
            } else if (lineTypeLower.includes('高优') || lineTypeLower.includes('优秀') || lineTypeLower.includes('特优')) {
                return 'excellent';
            } else if (lineTypeLower.includes('重本') || lineTypeLower.includes('一本') || lineTypeLower.includes('重点')) {
                return 'firstTier';
            } else if (lineTypeLower.includes('本科') || lineTypeLower.includes('二本') || lineTypeLower.includes('普通')) {
                return 'keyTier';
            }
            
            return null;
        }

        // 从列名标准化分数线类型
        function standardizeLineTypeFromColumn(columnName) {
            return standardizeLineType(columnName);
        }

        // 获取科目显示名称
        function getSubjectName(subjectCode) {
            const subjectNames = {
                'total': '总分',
                'chinese': '语文',
                'math': '数学',
                'english': '英语',
                'physics': '物理',
                'chemistry': '化学',
                'biology': '生物'
            };
            return subjectNames[subjectCode] || subjectCode;
        }

        // 获取分数线类型显示名称
        function getLineTypeName(lineCode) {
            const lineTypeNames = {
                'keyTier': '本科线',
                'firstTier': '重本线',
                'excellent': '高优线',
                'doubleFirst': '双一流线'
            };
            return lineTypeNames[lineCode] || lineCode;
        }

        // 显示分数线数据预览
        function showScoreLineDataPreview(processedData) {
            const preview = document.getElementById('scoreLinePreview');
            const recognitionResultDiv = document.getElementById('recognitionResult');
            const table = document.getElementById('scoreLinePreviewTable');
            
            // 清空表格
            table.innerHTML = '';
            
            // 显示智能识别结果
            if (recognitionResultDiv) {
                recognitionResultDiv.innerHTML = `
                    <h5><i class="fas fa-check-circle"></i> 智能识别结果</h5>
                    <p><strong>识别方式:</strong> ${processedData.recognition?.method || '智能识别'}</p>
                    <p><strong>识别科目:</strong> ${processedData.subjects.join(', ')}</p>
                    <p><strong>分数线类型:</strong> ${processedData.lineTypes.map(lt => getLineTypeName(lt)).join(', ')}</p>
                    ${processedData.notes ? processedData.notes.map(note => `<p>${note}</p>`).join('') : ''}
                `;
            }
            
            // 创建表头
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            // 确定要显示的列
            const columns = ['subject', 'keyTier', 'firstTier', 'excellent', 'doubleFirst'];
            
            columns.forEach(col => {
                const th = document.createElement('th');
                th.textContent = col === 'subject' ? '科目' : getLineTypeName(col);
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // 创建数据行
            const tbody = document.createElement('tbody');
            
            // 显示每个科目
            for (const [subjectCode, lines] of Object.entries(processedData.data)) {
                const row = document.createElement('tr');
                
                columns.forEach(col => {
                    const td = document.createElement('td');
                    let value = '';
                    
                    if (col === 'subject') {
                        value = getSubjectName(subjectCode) || subjectCode;
                    } else {
                        value = lines[col] || lines[col] === 0 ? lines[col] : '--';
                    }
                    
                    td.textContent = value;
                    row.appendChild(td);
                });
                
                tbody.appendChild(row);
            }
            
            table.appendChild(tbody);
            
            // 显示预览
            preview.style.display = 'block';
        }

        // 显示导入分数线确认模态框
        function showImportScoreLinesModal() {
            if (!scoreLineImportData) {
                alert('请先选择分数线Excel文件');
                return;
            }
            
            const modal = document.getElementById('importLinesModal');
            const currentExam = exams.find(exam => exam.id === currentLineExamId);
            
            document.getElementById('currentExamNameForLines').textContent = currentExam ? currentExam.name : '未知考试';
            document.getElementById('lineDataCount').textContent = Object.keys(scoreLineImportData).length;
            
            const subjects = Object.keys(scoreLineImportData).map(code => getSubjectName(code) || code);
            document.getElementById('recognizedSubjects').textContent = subjects.join(', ');
            
            // 更新预览表格
            updateImportLinesPreviewTable(scoreLineImportData);
            
            modal.style.display = 'flex';
        }

        // 更新导入分数线预览表格
        function updateImportLinesPreviewTable(data) {
            const table = document.getElementById('importLinesPreviewTable');
            table.innerHTML = '';
            
            // 创建表头
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            const columns = ['subject', 'keyTier', 'firstTier', 'excellent', 'doubleFirst'];
            
            columns.forEach(col => {
                const th = document.createElement('th');
                th.textContent = col === 'subject' ? '科目' : getLineTypeName(col);
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // 创建数据行
            const tbody = document.createElement('tbody');
            
            for (const [subjectCode, lines] of Object.entries(data)) {
                const row = document.createElement('tr');
                
                columns.forEach(col => {
                    const td = document.createElement('td');
                    let value = '';
                    
                    if (col === 'subject') {
                        value = getSubjectName(subjectCode) || subjectCode;
                    } else {
                        value = lines[col] || lines[col] === 0 ? lines[col] : '--';
                    }
                    
                    td.textContent = value;
                    row.appendChild(td);
                });
                
                tbody.appendChild(row);
            }
            
            table.appendChild(tbody);
        }

        // 确认导入分数线
        function confirmImportLines() {
            if (!scoreLineImportData) return;
            
            // 更新当前考试的分数线
            const currentExam = exams.find(exam => exam.id === currentLineExamId);
            if (currentExam) {
                // 更新各科目分数线
                for (const [subjectCode, lines] of Object.entries(scoreLineImportData)) {
                    if (subjectCode === 'total' || ['chinese', 'math', 'english', 'physics', 'chemistry', 'biology'].includes(subjectCode)) {
                        if (!currentExam.lines[subjectCode]) {
                            currentExam.lines[subjectCode] = {};
                        }
                        
                        // 只更新识别到的分数线类型
                        Object.keys(lines).forEach(lineType => {
                            if (['keyTier', 'firstTier', 'excellent', 'doubleFirst'].includes(lineType)) {
                                currentExam.lines[subjectCode][lineType] = lines[lineType];
                            }
                        });
                    }
                }
                
                currentExam.hasLines = true;
                
                // 如果当前正在查看这个考试的分数线，更新显示
                if (currentLineExamId === currentExamId) {
                    scoreLines = JSON.parse(JSON.stringify(currentExam.lines));
                    updateScoreLineDisplay();
                    updateLineCounts();
                }
                
                // 更新考试分数线关联状态
                updateExamLineAssociations();
                
                // 更新趋势图
                updateTrendChart();
                
                // 更新雷达图
                updateRadarChart();
                
                alert(`成功为考试 "${currentExam.name}" 导入分数线（${recognitionResult?.method || '智能识别'}）`);
            }
            
            closeModal('importLinesModal');
            
            // 重置导入区域
            document.getElementById('scoreLineExcelFile').value = '';
            document.getElementById('scoreLinePreview').style.display = 'none';
            document.getElementById('importScoreLinesBtn').disabled = true;
            scoreLineImportData = null;
            recognitionResult = null;
        }

        // 下载分数线模板
        function downloadScoreLineTemplate() {
            // 创建两种格式的模板
            const templateData1 = [
                ['科目', '本科线', '重本线', '高优线', '双一流线'],
                ['总分', 328.5, 451.5, 556.5, 600.5],
                ['语文', 70, 87, 104, 109],
                ['数学', 38, 79, 117, 135],
                ['英语', 63, 107.5, 128, 132],
                ['物理', 20, 39, 72, 81],
                ['化学', 38, 66, 89, 99],
                ['生物', 34, 64, 90, 94]
            ];
            
            const templateData2 = [
                ['分数线类型', '语文', '数学', '英语', '物理', '化学', '生物', '总分'],
                ['本科线', 70, 38, 63, 20, 38, 34, 328.5],
                ['重本线', 87, 79, 107.5, 39, 66, 64, 451.5],
                ['高优线', 104, 117, 128, 72, 89, 90, 556.5],
                ['双一流线', 109, 135, 132, 81, 99, 94, 600.5]
            ];
            
            const workbook = XLSX.utils.book_new();
            
            // 添加第一种格式的工作表
            const worksheet1 = XLSX.utils.aoa_to_sheet(templateData1);
            XLSX.utils.book_append_sheet(workbook, worksheet1, '格式1-行列式');
            
            // 添加第二种格式的工作表
            const worksheet2 = XLSX.utils.aoa_to_sheet(templateData2);
            XLSX.utils.book_append_sheet(workbook, worksheet2, '格式2-表格式');
            
            XLSX.writeFile(workbook, '分数线导入模板（两种格式）.xlsx');
        }

        // 处理Excel数据 - 按您提供的格式进行智能识别
        function processExcelData(jsonData) {
            if (!jsonData || jsonData.length === 0) {
                alert('Excel文件数据为空或格式不正确');
                return null;
            }
            
            console.log('原始Excel数据:', jsonData);
            
            // 获取第一行数据作为样本
            const firstRow = jsonData[0];
            if (!firstRow) {
                alert('Excel文件中没有数据');
                return null;
            }
            
            console.log('第一行数据:', firstRow);
            
            // 获取所有列名
            const columnNames = Object.keys(firstRow);
            console.log('所有列名:', columnNames);
            
            // 智能识别列名 - 改进版，按您提供的格式
            const columnMap = {};
            
            // 按您提供的模板格式识别
            for (let i = 0; i < columnNames.length; i++) {
                const colName = columnNames[i];
                const colNameLower = colName.toLowerCase().trim();
                
                // 识别姓名列
                if (colNameLower.includes('姓名') || colNameLower.includes('名字') || colNameLower === 'name') {
                    columnMap.name = colName;
                }
                // 识别总分列
                else if (colNameLower.includes('总分') || colNameLower.includes('总成绩')) {
                    columnMap.total = colName;
                }
                // 识别校名/年级排名列
                else if (colNameLower.includes('校名') || colNameLower.includes('校排名') || colNameLower.includes('年级排名')) {
                    columnMap.totalRank = colName;
                }
                // 识别各学科成绩和排名列
                else if (i > 0) {
                    // 通过列位置识别学科和排名
                    const prevColName = columnNames[i-1].toLowerCase().trim();
                    
                    // 检查是否是排名列（前一列是学科成绩）
                    if (prevColName.includes('语文') && !prevColName.includes('排名') && colNameLower.includes('排名')) {
                        columnMap.chineseRank = colName;
                    } else if (prevColName.includes('数学') && !prevColName.includes('排名') && colNameLower.includes('排名')) {
                        columnMap.mathRank = colName;
                    } else if (prevColName.includes('英语') && !prevColName.includes('排名') && colNameLower.includes('排名')) {
                        columnMap.englishRank = colName;
                    } else if (prevColName.includes('物理') && !prevColName.includes('排名') && colNameLower.includes('排名')) {
                        columnMap.physicsRank = colName;
                    } else if (prevColName.includes('化学') && !prevColName.includes('排名') && colNameLower.includes('排名')) {
                        columnMap.chemistryRank = colName;
                    } else if (prevColName.includes('生物') && !prevColName.includes('排名') && colNameLower.includes('排名')) {
                        columnMap.biologyRank = colName;
                    }
                    // 检查是否是学科成绩列
                    else if (colNameLower.includes('语文') && !colNameLower.includes('排名')) {
                        columnMap.chinese = colName;
                    } else if (colNameLower.includes('数学') && !colNameLower.includes('排名')) {
                        columnMap.math = colName;
                    } else if (colNameLower.includes('英语') && !colNameLower.includes('排名')) {
                        columnMap.english = colName;
                    } else if (colNameLower.includes('物理') && !colNameLower.includes('排名')) {
                        columnMap.physics = colName;
                    } else if (colNameLower.includes('化学') && !colNameLower.includes('排名')) {
                        columnMap.chemistry = colName;
                    } else if (colNameLower.includes('生物') && !colNameLower.includes('排名')) {
                        columnMap.biology = colName;
                    }
                }
            }
            
            // 备用方案：如果没有识别到姓名列，假设第一列是姓名
            if (!columnMap.name && columnNames.length > 0) {
                columnMap.name = columnNames[0];
                console.log(`备用方案：假设第一列为姓名: ${columnNames[0]}`);
            }
            
            console.log('列映射结果:', columnMap);
            
            // 检查必要字段
            if (!columnMap.name) {
                alert('无法识别姓名列，请确保Excel文件包含学生姓名信息');
                return null;
            }
            
            // 解析数据
            const studentData = [];
            
            for (let i = 0; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row) continue;
                
                // 获取姓名
                let name = String(row[columnMap.name] || '').trim();
                if (!name) continue; // 跳过没有姓名的行
                
                // 清理姓名，移除多余空格
                name = name.replace(/\s+/g, ' ');
                
                // 生成学生ID（基于姓名）
                const studentId = generateStudentIdFromName(name);
                
                // 创建学生对象
                const student = {
                    id: studentId,
                    name: name
                };
                
                // 解析总分
                if (columnMap.total) {
                    const totalValue = parseFloat(row[columnMap.total]);
                    if (!isNaN(totalValue)) {
                        student.total = totalValue;
                    }
                }
                
                // 解析总分排名（年级排名）
                if (columnMap.totalRank) {
                    const rankValue = parseInt(row[columnMap.totalRank]);
                    if (!isNaN(rankValue)) {
                        student.totalRank = rankValue;
                        student.gradeRank = rankValue; // 添加年级排名字段
                    }
                }
                
                // 解析学科成绩和排名 - 使用上传表格中的排名数据
                const subjectFields = [
                    { field: 'chinese', col: columnMap.chinese, rankCol: columnMap.chineseRank },
                    { field: 'math', col: columnMap.math, rankCol: columnMap.mathRank },
                    { field: 'english', col: columnMap.english, rankCol: columnMap.englishRank },
                    { field: 'physics', col: columnMap.physics, rankCol: columnMap.physicsRank },
                    { field: 'chemistry', col: columnMap.chemistry, rankCol: columnMap.chemistryRank },
                    { field: 'biology', col: columnMap.biology, rankCol: columnMap.biologyRank }
                ];
                
                subjectFields.forEach(subject => {
                    // 解析学科成绩
                    if (subject.col) {
                        const value = row[subject.col];
                        if (value !== undefined && value !== null && value !== '') {
                            // 尝试转换为数字
                            const numValue = parseFloat(value);
                            if (!isNaN(numValue)) {
                                student[subject.field] = numValue;
                            } else {
                                student[subject.field] = 0;
                            }
                        } else {
                            student[subject.field] = 0;
                        }
                    } else {
                        student[subject.field] = 0;
                    }
                    
                    // 解析学科排名（直接使用上传表格中的排名数据）
                    if (subject.rankCol) {
                        const rankValue = parseInt(row[subject.rankCol]);
                        if (!isNaN(rankValue)) {
                            student[`${subject.field}Rank`] = rankValue;
                            student[`${subject.field}GradeRank`] = rankValue; // 添加年级排名字段
                        }
                    }
                });
                
                // 如果没有总分，计算总分
                if (!student.total) {
                    const total = (student.chinese || 0) + (student.math || 0) + (student.english || 0) + 
                                 (student.physics || 0) + (student.chemistry || 0) + (student.biology || 0);
                    student.total = total;
                }
                
                studentData.push(student);
            }
            
            if (studentData.length === 0) {
                alert('未找到有效的学生数据');
                return null;
            }
            
            console.log('成功解析数据:', studentData.length, '条记录');
            return studentData;
        }

        // 从姓名生成学生ID
        function generateStudentIdFromName(name) {
            // 清理姓名
            const cleanName = name.replace(/\s+/g, '');
            
            // 生成简单的哈希值作为ID
            let hash = 0;
            for (let i = 0; i < cleanName.length; i++) {
                const char = cleanName.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // 转换为32位整数
            }
            
            // 取绝对值并格式化为3位数字
            const idNum = Math.abs(hash) % 900 + 100; // 100-999之间的数字
            return idNum.toString();
        }

        // 显示数据预览
        function showDataPreview(data) {
            const preview = document.getElementById('filePreview');
            const table = document.getElementById('previewTable');
            
            // 清空表格
            table.innerHTML = '';
            
            // 创建表头
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            // 确定要显示的列
            const columns = ['name', 'total', 'gradeRank', 'chinese', 'chineseRank', 'math', 'mathRank', 'english', 'englishRank', 'physics', 'physicsRank', 'chemistry', 'chemistryRank', 'biology', 'biologyRank'];
            
            columns.forEach(col => {
                const th = document.createElement('th');
                th.textContent = getPreviewColumnName(col);
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // 创建数据行
            const tbody = document.createElement('tbody');
            const displayCount = Math.min(10, data.length);
            
            for (let i = 0; i < displayCount; i++) {
                const student = data[i];
                const row = document.createElement('tr');
                
                columns.forEach(col => {
                    const td = document.createElement('td');
                    let value = student[col];
                    
                    // 特殊处理排名字段
                    if (col.includes('Rank')) {
                        if (col === 'gradeRank') {
                            value = student.totalRank || student.gradeRank || '--';
                        } else {
                            const subject = col.replace('Rank', '');
                            value = student[col] || student[`${subject}GradeRank`] || '--';
                        }
                    }
                    
                    td.textContent = value || value === 0 ? value : '--';
                    row.appendChild(td);
                });
                
                tbody.appendChild(row);
            }
            
            table.appendChild(tbody);
            
            // 更新数据统计
            updateDataSummary(data);
            
            // 显示预览
            preview.style.display = 'block';
        }

        // 获取预览列名
        function getPreviewColumnName(col) {
            const columnNames = {
                'name': '姓名',
                'total': '总分',
                'totalRank': '年级排名',
                'gradeRank': '年级排名',
                'chinese': '语文',
                'chineseRank': '语文排名',
                'math': '数学',
                'mathRank': '数学排名',
                'english': '英语',
                'englishRank': '英语排名',
                'physics': '物理',
                'physicsRank': '物理排名',
                'chemistry': '化学',
                'chemistryRank': '化学排名',
                'biology': '生物',
                'biologyRank': '生物排名'
            };
            return columnNames[col] || col;
        }

        // 更新数据统计
        function updateDataSummary(data) {
            const summaryContainer = document.getElementById('dataSummary');
            summaryContainer.innerHTML = '';
            
            if (data.length === 0) return;
            
            // 计算统计信息
            const studentCount = data.length;
            
            // 计算各科平均分
            const subjects = ['chinese', 'math', 'english', 'physics', 'chemistry', 'biology'];
            let totalSum = 0;
            let validSubjectCount = 0;
            
            subjects.forEach(subject => {
                const sum = data.reduce((acc, student) => acc + (student[subject] || 0), 0);
                const avg = sum / data.length;
                
                if (avg > 0) {
                    validSubjectCount++;
                    totalSum += sum;
                    
                    const summaryItem = document.createElement('div');
                    summaryItem.className = 'summary-item';
                    summaryItem.innerHTML = `
                        <div class="summary-label">${getSubjectName(subject)}均分</div>
                        <div class="summary-value">${avg.toFixed(1)}</div>
                    `;
                    summaryContainer.appendChild(summaryItem);
                }
            });
            
            const overallAvg = validSubjectCount > 0 ? totalSum / (data.length * validSubjectCount) : 0;
            
            // 添加学生人数和总平均分
            const countItem = document.createElement('div');
            countItem.className = 'summary-item';
            countItem.innerHTML = `
                <div class="summary-label">学生人数</div>
                <div class="summary-value">${studentCount}</div>
            `;
            summaryContainer.insertBefore(countItem, summaryContainer.firstChild);
            
            const avgItem = document.createElement('div');
            avgItem.className = 'summary-item';
            avgItem.innerHTML = `
                <div class="summary-label">总平均分</div>
                <div class="summary-value">${overallAvg.toFixed(1)}</div>
            `;
            summaryContainer.appendChild(avgItem);
        }

        // 显示导入确认模态框
        function showImportModal() {
            if (!importData) {
                alert('请先选择Excel文件');
                return;
            }
            
            const modal = document.getElementById('importModal');
            const importMode = document.getElementById('importMode').value;
            
            document.getElementById('rowCount').textContent = importData.length;
            document.getElementById('importModeText').textContent = 
                importMode === 'append' ? '追加到现有数据' : 
                importMode === 'replace' ? '替换现有数据' : '作为新考试导入';
            
            // 更新模态框中的数据统计
            updateModalDataSummary(importData);
            
            // 更新模态框预览表格
            updateModalPreviewTable(importData);
            
            // 显示/隐藏考试名称输入框
            const examNameContainer = document.getElementById('examNameInputContainer');
            if (importMode === 'new-exam') {
                examNameContainer.style.display = 'block';
                document.getElementById('examNameInput').value = '';
                document.getElementById('examDateInput').value = new Date().toISOString().split('T')[0];
            } else {
                examNameContainer.style.display = 'none';
            }
            
            modal.style.display = 'flex';
        }

        // 更新模态框数据统计
        function updateModalDataSummary(data) {
            const summaryContainer = document.getElementById('modalDataSummary');
            summaryContainer.innerHTML = '<h4>数据统计</h4>';
            
            const summaryGrid = document.createElement('div');
            summaryGrid.className = 'summary-grid';
            
            // 计算统计信息
            const studentCount = data.length;
            
            // 计算各科平均分
            const subjects = ['chinese', 'math', 'english', 'physics', 'chemistry', 'biology'];
            let totalSum = 0;
            let validSubjectCount = 0;
            
            subjects.forEach(subject => {
                const sum = data.reduce((acc, student) => acc + (student[subject] || 0), 0);
                const avg = sum / data.length;
                
                if (avg > 0) {
                    validSubjectCount++;
                    totalSum += sum;
                    
                    const summaryItem = document.createElement('div');
                    summaryItem.className = 'summary-item';
                    summaryItem.innerHTML = `
                        <div class="summary-label">${getSubjectName(subject)}均分</div>
                        <div class="summary-value">${avg.toFixed(1)}</div>
                    `;
                    summaryGrid.appendChild(summaryItem);
                }
            });
            
            const overallAvg = validSubjectCount > 0 ? totalSum / (data.length * validSubjectCount) : 0;
            
            // 添加学生人数和总平均分
            const countItem = document.createElement('div');
            countItem.className = 'summary-item';
            countItem.innerHTML = `
                <div class="summary-label">学生人数</div>
                <div class="summary-value">${studentCount}</div>
            `;
            summaryGrid.insertBefore(countItem, summaryGrid.firstChild);
            
            const avgItem = document.createElement('div');
            avgItem.className = 'summary-item';
            avgItem.innerHTML = `
                <div class="summary-label">总平均分</div>
                <div class="summary-value">${overallAvg.toFixed(1)}</div>
            `;
            summaryGrid.appendChild(avgItem);
            
            summaryContainer.appendChild(summaryGrid);
        }

        // 更新模态框预览表格
        function updateModalPreviewTable(data) {
            const table = document.getElementById('modalPreviewTable');
            table.innerHTML = '';
            
            // 创建表头
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            // 确定要显示的列
            const columns = ['name', 'total', 'gradeRank', 'chinese', 'chineseRank', 'math', 'mathRank', 'english', 'englishRank'];
            
            columns.forEach(col => {
                const th = document.createElement('th');
                th.textContent = getPreviewColumnName(col);
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // 创建数据行
            const tbody = document.createElement('tbody');
            const displayCount = Math.min(5, data.length);
            
            for (let i = 0; i < displayCount; i++) {
                const student = data[i];
                const row = document.createElement('tr');
                
                columns.forEach(col => {
                    const td = document.createElement('td');
                    let value = student[col];
                    
                    // 特殊处理排名字段
                    if (col === 'gradeRank') {
                        value = student.totalRank || student.gradeRank || '--';
                    } else if (col.includes('Rank')) {
                        const subject = col.replace('Rank', '');
                        value = student[col] || student[`${subject}GradeRank`] || '--';
                    }
                    
                    td.textContent = value || value === 0 ? value : '--';
                    row.appendChild(td);
                });
                
                tbody.appendChild(row);
            }
            
            table.appendChild(tbody);
        }

        // 关闭模态框
        function closeModal(modalId = 'importModal') {
            document.getElementById(modalId).style.display = 'none';
        }

        // 确认导入
        function confirmImport() {
            if (!importData) return;
            
            const importMode = document.getElementById('importMode').value;
            
            if (importMode === 'new-exam') {
                // 作为新考试导入
                const examName = document.getElementById('examNameInput').value.trim();
                const examDate = document.getElementById('examDateInput').value;
                
                if (!examName) {
                    alert('请输入考试名称');
                    return;
                }
                
                // 检查考试名称是否已存在
                if (exams.some(exam => exam.name === examName)) {
                    alert('考试名称已存在，请使用其他名称');
                    return;
                }
                
                // 创建新考试
                const newExamId = exams.length > 0 ? Math.max(...exams.map(e => e.id)) + 1 : 1;
                const newExam = {
                    id: newExamId,
                    name: examName,
                    date: examDate || new Date().toISOString().split('T')[0],
                    data: JSON.parse(JSON.stringify(importData)),
                    lines: JSON.parse(JSON.stringify(scoreLines)), // 使用当前分数线
                    selected: true,
                    hasLines: true // 新考试有默认分数线
                };
                
                exams.push(newExam);
                currentExamId = newExamId;
                currentLineExamId = newExamId;
                selectedExamIds.push(newExamId);
                
                alert(`成功创建新考试 "${examName}" 并导入 ${importData.length} 条学生记录`);
            } else {
                // 导入到当前考试
                const currentExam = exams.find(exam => exam.id === currentExamId);
                
                if (importMode === 'replace') {
                    // 替换数据
                    if (currentExam) {
                        currentExam.data = JSON.parse(JSON.stringify(importData));
                    }
                    alert(`成功替换 ${importData.length} 条学生记录`);
                } else {
                    // 追加数据（根据姓名智能匹配）
                    if (currentExam) {
                        // 获取现有学生姓名集合
                        const existingNames = new Set(currentExam.data.map(s => s.name));
                        
                        // 过滤出新学生（姓名不重复的）
                        const newStudents = importData.filter(s => !existingNames.has(s.name));
                        
                        // 对于已存在的学生，更新他们的数据
                        const updatedStudents = importData.filter(s => existingNames.has(s.name));
                        
                        // 更新已存在学生的数据
                        updatedStudents.forEach(newStudent => {
                            const index = currentExam.data.findIndex(s => s.name === newStudent.name);
                            if (index !== -1) {
                                // 保留ID，更新其他数据
                                const oldId = currentExam.data[index].id;
                                currentExam.data[index] = { ...newStudent, id: oldId };
                            }
                        });
                        
                        // 添加新学生
                        currentExam.data.push(...JSON.parse(JSON.stringify(newStudents)));
                        alert(`成功更新 ${updatedStudents.length} 条学生记录，新增 ${newStudents.length} 条学生记录`);
                    }
                }
            }
            
            // 重新渲染界面
            renderStudentTable();
            updateClassStats();
            updateStudentSelects();
            updateSubjectTrendSelects();
            updateRankTrendSelect();
            updateSubjectRankSelects();
            updateExamDisplay();
            updateExamSelects();
            updateExamCheckboxes();
            updateExamLineDisplay();
            updateExamLineAssociations();
            updateCurrentExamDisplay();
            updateExamManagement();
            
            // 更新分数线差距分析选择框
            updateLineDiffSelects();
            
            // 更新分数线人数统计
            updateLineCounts();
            
            // 新增：更新总分分析考试选择器
            updateTotalAnalysisExamSelector();
            
            // 新增：更新学科分析考试选择器
            updateSubjectAnalysisExamSelector();
            
            closeModal('importModal');
            
            // 重置导入区域
            document.getElementById('excelFile').value = '';
            document.getElementById('filePreview').style.display = 'none';
            document.getElementById('importBtn').disabled = true;
            importData = null;
            
            // 更新当前学科的图表
            const activeTab = document.querySelector('.subject-tab.active');
            if (activeTab) {
                updateSubjectAnalysis(activeTab.getAttribute('data-subject'));
            }
            
            // 如果正在查看排名趋势页面，更新排名趋势分析
            if (document.getElementById('rank-trend').classList.contains('active')) {
                updateRankTrendAnalysis();
            }
            
            // 更新总分分析
            if (document.getElementById('total-analysis').classList.contains('active')) {
                updateTotalAnalysis();
            }
            
            // 更新趋势图
            updateTrendChart();
        }

        // 下载模板
        function downloadTemplate() {
            const templateData = [
                ['姓名', '总分', '校名', '语文', '排名', '数学', '排名', '英语', '排名', '物理', '排名', '化学', '排名', '生物', '排名'],
                ['俞越', 554.5, 29, 99, 65, 109, 53, 109.5, 226, 71, 30, 89, 27, 77, 99],
                ['熊豪杰', 541.5, 46, 94, 138, 126, 14, 114.5, 174, 69, 36, 64, 265, 74, 131],
                ['刘继凯', 532, 62, 92, 165, 113, 41, 96, 328, 60, 79, 83, 75, 88, 33]
            ];
            
            const worksheet = XLSX.utils.aoa_to_sheet(templateData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, '学生成绩');
            
            XLSX.writeFile(workbook, '学生成绩模板(符合您格式).xlsx');
        }

        // 处理分数线输入框blur事件
        function handleLineInputBlur(e) {
            const input = e.target;
            const value = parseFloat(input.value);
            const min = parseFloat(input.min) || 0;
            const max = parseFloat(input.max) || 750;
            
            if (isNaN(value)) {
                // 如果是空值，恢复默认值
                if (input.id.includes('KeyTier')) {
                    input.value = input.id.includes('total') ? 328.5 : 
                                 input.id.includes('chinese') ? 70 :
                                 input.id.includes('math') ? 38 :
                                 input.id.includes('english') ? 63 :
                                 input.id.includes('physics') ? 20 :
                                 input.id.includes('chemistry') ? 38 : 34;
                } else if (input.id.includes('FirstTier')) {
                    input.value = input.id.includes('total') ? 451.5 : 
                                 input.id.includes('chinese') ? 87 :
                                 input.id.includes('math') ? 79 :
                                 input.id.includes('english') ? 107.5 :
                                 input.id.includes('physics') ? 39 :
                                 input.id.includes('chemistry') ? 66 : 64;
                } else if (input.id.includes('Excellent')) {
                    input.value = input.id.includes('total') ? 556.5 : 
                                 input.id.includes('chinese') ? 104 :
                                 input.id.includes('math') ? 117 :
                                 input.id.includes('english') ? 128 :
                                 input.id.includes('physics') ? 72 :
                                 input.id.includes('chemistry') ? 89 : 90;
                } else if (input.id.includes('DoubleFirst')) {
                    input.value = input.id.includes('total') ? 600.5 : 
                                 input.id.includes('chinese') ? 109 :
                                 input.id.includes('math') ? 135 :
                                 input.id.includes('english') ? 132 :
                                 input.id.includes('physics') ? 81 :
                                 input.id.includes('chemistry') ? 99 : 94;
                } else {
                    input.value = min;
                }
            } else {
                // 确保值在有效范围内
                input.value = Math.max(min, Math.min(max, value));
            }
        }

        // 处理分数线输入框change事件
        function handleLineInputChange(e) {
            const input = e.target;
            const value = parseFloat(input.value);
            const min = parseFloat(input.min) || 0;
            const max = parseFloat(input.max) || 750;
            
            if (!isNaN(value) && value >= min && value <= max) {
                // 更新当前考试的分数线
                const currentExam = exams.find(exam => exam.id === currentLineExamId);
                if (currentExam) {
                    // 确定是哪个科目和哪种分数线
                    const id = input.id;
                    let subjectCode = '';
                    let lineType = '';
                    
                    if (id.includes('total')) {
                        subjectCode = 'total';
                    } else if (id.includes('chinese')) {
                        subjectCode = 'chinese';
                    } else if (id.includes('math')) {
                        subjectCode = 'math';
                    } else if (id.includes('english')) {
                        subjectCode = 'english';
                    } else if (id.includes('physics')) {
                        subjectCode = 'physics';
                    } else if (id.includes('chemistry')) {
                        subjectCode = 'chemistry';
                    } else if (id.includes('biology')) {
                        subjectCode = 'biology';
                    }
                    
                    if (id.includes('KeyTier')) {
                        lineType = 'keyTier';
                    } else if (id.includes('FirstTier')) {
                        lineType = 'firstTier';
                    } else if (id.includes('Excellent')) {
                        lineType = 'excellent';
                    } else if (id.includes('DoubleFirst')) {
                        lineType = 'doubleFirst';
                    }
                    
                    if (subjectCode && lineType && currentExam.lines[subjectCode]) {
                        currentExam.lines[subjectCode][lineType] = value;
                        currentExam.hasLines = true;
                        
                        // 如果当前正在查看这个考试的分数线，更新全局分数线
                        if (currentLineExamId === currentExamId) {
                            scoreLines[subjectCode][lineType] = value;
                        }
                        
                        // 更新分数线人数统计
                        updateLineCounts();
                        
                        // 更新考试分数线关联状态
                        updateExamLineAssociations();
                        
                        // 更新趋势图
                        updateTrendChart();
                    }
                }
            }
        }

        // 切换主标签页
        function switchTab(tabId) {
            // 更新导航标签
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.nav-tab[data-tab="${tabId}"]`).classList.add('active');
            
            // 更新内容区域
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
            
            // 更新相关图表
            if (tabId === 'total-analysis') {
                updateTotalAnalysis();
                updateLineDiffSelects();
            } else if (tabId === 'subject-analysis') {
                updateSubjectAnalysis();
                updateLineDiffSelects();
            } else if (tabId === 'rank-trend') {
                updateRankTrendSelect();
                // 如果已经选择了学生，更新排名趋势分析
                const studentId = document.getElementById('rankTrendStudentSelect').value;
                if (studentId) {
                    updateRankTrendAnalysis();
                }
            } else if (tabId === 'score-lines') {
                updateExamLineDisplay();
                updateExamLineAssociations();
                updateLineCounts();
                updateExamManagement();
            }
        }

        // 切换排名子标签页
        function switchRankTab(tabId) {
            // 更新排名子标签页
            document.querySelectorAll('.rank-subtab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.rank-subtab[data-rank-tab="${tabId}"]`).classList.add('active');
            
            // 更新内容区域
            document.querySelectorAll('.rank-subcontent').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
            
            // 如果切换到学科排名趋势，更新选择下拉框
            if (tabId === 'subject-rank') {
                updateSubjectRankSelects();
            }
        }

        // 切换学科
        function switchSubject(subject) {
            // 更新学科标签
            document.querySelectorAll('.subject-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.subject-tab[data-subject="${subject}"]`).classList.add('active');
            
            // 更新内容区域
            document.querySelectorAll('.subject-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(subject).classList.add('active');
            
            // 更新当前学科的图表
            updateSubjectAnalysis(subject);
            
            // 更新该学科的分数线差距分析
            updateSubjectLineDiffAnalysis(subject);
        }

        // 渲染学生表格 - 改进版，完整显示所有学科
        function renderStudentTable() {
            const tbody = document.getElementById('studentTableBody');
            tbody.innerHTML = '';
            
            // 获取当前考试的数据
            const currentExam = exams.find(exam => exam.id === currentExamId);
            const displayStudents = currentExam ? currentExam.data : [];
            
            if (displayStudents.length === 0) {
                // 如果没有学生，显示空状态
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `<td colspan="16" style="text-align: center; padding: 40px; color: #94a3b8;">暂无学生数据，请添加学生或导入数据</td>`;
                tbody.appendChild(emptyRow);
                
                // 更新学生数量
                document.getElementById('studentCount').textContent = '0';
                return;
            }
            
            // 渲染学生行
            displayStudents.forEach((student, index) => {
                const row = document.createElement('tr');
                
                // 获取年级排名（使用上传表格中的排名数据）
                const gradeRank = student.gradeRank || student.totalRank || '--';
                
                row.innerHTML = `
                    <td>${student.name}</td>
                    <td><strong>${student.total || 0}</strong></td>
                    <td><span class="rank-value grade-rank">${gradeRank}</span></td>
                    
                    <!-- 语文 -->
                    <td>
                        <div class="score-rank-cell">
                            <span class="score-value">${student.chinese || 0}</span>
                            <span class="rank-value">${student.chineseGradeRank || student.chineseRank || '--'}</span>
                        </div>
                    </td>
                    <td>
                        <div class="score-rank-cell">
                            <span class="score-value">排名</span>
                            <span class="rank-value">${student.chineseGradeRank || student.chineseRank || '--'}</span>
                        </div>
                    </td>
                    
                    <!-- 数学 -->
                    <td>
                        <div class="score-rank-cell">
                            <span class="score-value">${student.math || 0}</span>
                            <span class="rank-value">${student.mathGradeRank || student.mathRank || '--'}</span>
                        </div>
                    </td>
                    <td>
                        <div class="score-rank-cell">
                            <span class="score-value">排名</span>
                            <span class="rank-value">${student.mathGradeRank || student.mathRank || '--'}</span>
                        </div>
                    </td>
                    
                    <!-- 英语 -->
                    <td>
                        <div class="score-rank-cell">
                            <span class="score-value">${student.english || 0}</span>
                            <span class="rank-value">${student.englishGradeRank || student.englishRank || '--'}</span>
                        </div>
                    </td>
                    <td>
                        <div class="score-rank-cell">
                            <span class="score-value">排名</span>
                            <span class="rank-value">${student.englishGradeRank || student.englishRank || '--'}</span>
                        </div>
                    </td>
                    
                    <!-- 物理 -->
                    <td>
                        <div class="score-rank-cell">
                            <span class="score-value">${student.physics || 0}</span>
                            <span class="rank-value">${student.physicsGradeRank || student.physicsRank || '--'}</span>
                        </div>
                    </td>
                    <td>
                        <div class="score-rank-cell">
                            <span class="score-value">排名</span>
                            <span class="rank-value">${student.physicsGradeRank || student.physicsRank || '--'}</span>
                        </div>
                    </td>
                    
                    <!-- 化学 -->
                    <td>
                        <div class="score-rank-cell">
                            <span class="score-value">${student.chemistry || 0}</span>
                            <span class="rank-value">${student.chemistryGradeRank || student.chemistryRank || '--'}</span>
                        </div>
                    </td>
                    <td>
                        <div class="score-rank-cell">
                            <span class="score-value">排名</span>
                            <span class="rank-value">${student.chemistryGradeRank || student.chemistryRank || '--'}</span>
                        </div>
                    </td>
                    
                    <!-- 生物 -->
                    <td>
                        <div class="score-rank-cell">
                            <span class="score-value">${student.biology || 0}</span>
                            <span class="rank-value">${student.biologyGradeRank || student.biologyRank || '--'}</span>
                        </div>
                    </td>
                    <td>
                        <div class="score-rank-cell">
                            <span class="score-value">排名</span>
                            <span class="rank-value">${student.biologyGradeRank || student.biologyRank || '--'}</span>
                        </div>
                    </td>
                    
                    <td class="action-column">
                        <button class="action-btn edit" data-id="${student.id}">编辑</button>
                        <button class="action-btn delete" data-id="${student.id}">删除</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // 更新学生数量
            document.getElementById('studentCount').textContent = displayStudents.length;
            
            // 绑定表格内事件
            bindTableEvents();
        }

        // 绑定表格内事件
        function bindTableEvents() {
            // 编辑按钮事件
            document.querySelectorAll('.action-btn.edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const studentId = this.getAttribute('data-id');
                    editStudent(studentId);
                });
            });
            
            // 删除按钮事件
            document.querySelectorAll('.action-btn.delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const studentId = this.getAttribute('data-id');
                    deleteStudent(studentId);
                });
            });
        }

        // 更新学生成绩
        function updateStudentScore(input) {
            const studentId = input.getAttribute('data-id');
            const field = input.getAttribute('data-field');
            let value = parseFloat(input.value);
            
            // 处理空值
            if (isNaN(value)) {
                value = 0;
                input.value = 0;
            }
            
            // 验证输入范围
            const max = field === 'chinese' || field === 'math' || field === 'english' ? 150 : 100;
            const validValue = Math.max(0, Math.min(max, value));
            input.value = validValue;
            
            // 更新当前考试的数据
            const currentExam = exams.find(exam => exam.id === currentExamId);
            if (currentExam) {
                const student = currentExam.data.find(s => s.id === studentId);
                if (student) {
                    student[field] = validValue;
                    
                    // 重新计算总分
                    student.total = (student.chinese || 0) + (student.math || 0) + (student.english || 0) + 
                                   (student.physics || 0) + (student.chemistry || 0) + (student.biology || 0);
                }
            }
            
            // 重新渲染整个表格
            renderStudentTable();
            
            // 更新统计和图表
            updateClassStats();
            updateStudentSelects();
            updateSubjectTrendSelects();
            updateRankTrendSelect();
            updateSubjectRankSelects();
            updateLineDiffSelects();
            
            if (charts.radar) {
                updateRadarChart();
            }
            
            // 更新当前学科的图表
            const activeTab = document.querySelector('.subject-tab.active');
            if (activeTab) {
                updateSubjectAnalysis(activeTab.getAttribute('data-subject'));
                updateSubjectLineDiffAnalysis(activeTab.getAttribute('data-subject'));
            }
            
            // 更新趋势图
            updateTrendChart();
            const subjects = ['chinese', 'math', 'english', 'physics', 'chemistry', 'biology'];
            subjects.forEach(subject => {
                updateSubjectTrendChart(subject);
            });
            
            // 如果正在查看排名趋势页面，更新排名趋势分析
            if (document.getElementById('rank-trend').classList.contains('active')) {
                const activeRankTab = document.querySelector('.rank-subtab.active');
                if (activeRankTab && activeRankTab.getAttribute('data-rank-tab') === 'total-rank') {
                    updateRankTrendAnalysis();
                } else if (activeRankTab && activeRankTab.getAttribute('data-rank-tab') === 'subject-rank') {
                    updateSubjectRankTrendAnalysis();
                }
            }
            
            // 如果正在查看总分分析页面，更新分析
            if (document.getElementById('total-analysis').classList.contains('active')) {
                updateTotalAnalysis();
                updateTotalLineDiffAnalysis();
            }
            
            // 更新分数线人数统计
            updateLineCounts();
        }

        // 编辑学生信息
        function editStudent(studentId) {
            // 获取当前考试的数据
            const currentExam = exams.find(exam => exam.id === currentExamId);
            const displayStudents = currentExam ? currentExam.data : students;
            const student = displayStudents.find(s => s.id === studentId);
            
            if (!student) return;
            
            const newName = prompt('请输入学生姓名:', student.name);
            if (newName && newName.trim()) {
                student.name = newName.trim();
                renderStudentTable();
                updateStudentSelects();
                updateSubjectTrendSelects();
                updateRankTrendSelect();
                updateSubjectRankSelects();
                updateLineDiffSelects();
            }
        }

        // 删除学生
        function deleteStudent(studentId) {
            // 获取当前考试的数据
            const currentExam = exams.find(exam => exam.id === currentExamId);
            const displayStudents = currentExam ? currentExam.data : students;
            
            if (displayStudents.length === 0) {
                alert('没有学生数据可以删除');
                return;
            }
            
            const student = displayStudents.find(s => s.id === studentId);
            if (!student) return;
            
            const studentName = student.name;
            if (confirm(`确定要删除学生 "${studentName}" 吗？`)) {
                // 从当前考试中删除该学生
                if (currentExam) {
                    const index = currentExam.data.findIndex(s => s.id === studentId);
                    if (index !== -1) {
                        currentExam.data.splice(index, 1);
                    }
                } else {
                    const index = students.findIndex(s => s.id === studentId);
                    if (index !== -1) {
                        students.splice(index, 1);
                    }
                }
                
                // 重新渲染整个表格
                renderStudentTable();
                updateClassStats();
                updateStudentSelects();
                updateSubjectTrendSelects();
                updateRankTrendSelect();
                updateSubjectRankSelects();
                updateLineDiffSelects();
                
                // 更新当前学科的图表
                const activeTab = document.querySelector('.subject-tab.active');
                if (activeTab) {
                    updateSubjectAnalysis(activeTab.getAttribute('data-subject'));
                    updateSubjectLineDiffAnalysis(activeTab.getAttribute('data-subject'));
                }
                
                // 更新总分分析
                if (document.getElementById('total-analysis').classList.contains('active')) {
                    updateTotalAnalysis();
                    updateTotalLineDiffAnalysis();
                }
                
                // 更新分数线人数统计
                updateLineCounts();
                
                alert(`学生 "${studentName}" 已删除`);
            }
        }

        // 添加新学生
        function addNewStudent() {
            // 生成新ID
            const newId = generateStudentId();
            
            const newStudent = {
                id: newId,
                name: '新学生',
                chinese: 0,
                math: 0,
                english: 0,
                physics: 0,
                chemistry: 0,
                biology: 0,
                total: 0,
                totalRank: 0,
                chineseRank: 0,
                mathRank: 0,
                englishRank: 0,
                physicsRank: 0,
                chemistryRank: 0,
                biologyRank: 0
            };
            
            // 添加到当前考试中
            const currentExam = exams.find(exam => exam.id === currentExamId);
            if (currentExam) {
                currentExam.data.push({...newStudent});
            } else {
                students.push({...newStudent});
            }
            
            renderStudentTable();
            updateStudentSelects();
            updateSubjectTrendSelects();
            updateRankTrendSelect();
            updateSubjectRankSelects();
            updateLineDiffSelects();
            
            // 更新当前学科的图表
            const activeTab = document.querySelector('.subject-tab.active');
            if (activeTab) {
                updateSubjectAnalysis(activeTab.getAttribute('data-subject'));
                updateSubjectLineDiffAnalysis(activeTab.getAttribute('data-subject'));
            }
            
            // 更新总分分析
            if (document.getElementById('total-analysis').classList.contains('active')) {
                updateTotalAnalysis();
                updateTotalLineDiffAnalysis();
            }
            
            // 更新分数线人数统计
            updateLineCounts();
        }

        // 生成学生ID
        function generateStudentId() {
            // 获取当前考试的数据
            const currentExam = exams.find(exam => exam.id === currentExamId);
            const displayStudents = currentExam ? currentExam.data : students;
            
            if (displayStudents.length === 0) return '001';
            
            // 查找最大的数字ID
            let maxId = 0;
            displayStudents.forEach(student => {
                const idNum = parseInt(student.id);
                if (!isNaN(idNum) && idNum > maxId) {
                    maxId = idNum;
                }
            });
            
            return (maxId + 1).toString().padStart(3, '0');
        }

        // 更新学生选择下拉框
        function updateStudentSelects() {
            // 获取当前考试的数据
            const currentExam = exams.find(exam => exam.id === currentExamId);
            const displayStudents = currentExam ? currentExam.data : students;
            
            const studentSelect = document.getElementById('studentSelect');
            const trendSelect = document.getElementById('trendStudentSelect');
            const rankTrendSelect = document.getElementById('rankTrendStudentSelect');
            const subjectRankSelect = document.getElementById('subjectRankStudentSelect');
            
            // 清空选项
            studentSelect.innerHTML = '<option value="">选择学生</option>';
            trendSelect.innerHTML = '<option value="">选择学生</option>';
            rankTrendSelect.innerHTML = '<option value="">选择学生</option>';
            subjectRankSelect.innerHTML = '<option value="">选择学生</option>';
            
            // 添加学生选项
            displayStudents.forEach(student => {
                const option1 = document.createElement('option');
                option1.value = student.id;
                option1.textContent = `${student.name}`;
                studentSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = student.id;
                option2.textContent = `${student.name}`;
                trendSelect.appendChild(option2);
                
                const option3 = document.createElement('option');
                option3.value = student.id;
                option3.textContent = `${student.name}`;
                rankTrendSelect.appendChild(option3);
                
                const option4 = document.createElement('option');
                option4.value = student.id;
                option4.textContent = `${student.name}`;
                subjectRankSelect.appendChild(option4);
            });
            
            // 新增：更新雷达图考试选择
            updateRadarExamSelect();
        }

        // 更新雷达图考试选择下拉框
        function updateRadarExamSelect() {
            const radarExamSelect = document.getElementById('radarExamSelect');
            radarExamSelect.innerHTML = '<option value="">选择考试</option>';
            
            exams.forEach(exam => {
                const option = document.createElement('option');
                option.value = exam.id;
                option.textContent = exam.name;
                radarExamSelect.appendChild(option);
            });
        }

        // 更新排名趋势选择下拉框
        function updateRankTrendSelect() {
            // 获取当前考试的数据
            const currentExam = exams.find(exam => exam.id === currentExamId);
            const displayStudents = currentExam ? currentExam.data : students;
            
            const rankTrendSelect = document.getElementById('rankTrendStudentSelect');
            
            rankTrendSelect.innerHTML = '<option value="">选择学生</option>';
            
            displayStudents.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.name}`;
                rankTrendSelect.appendChild(option);
            });
        }

        // 更新学科排名选择下拉框
        function updateSubjectRankSelects() {
            // 获取当前考试的数据
            const currentExam = exams.find(exam => exam.id === currentExamId);
            const displayStudents = currentExam ? currentExam.data : students;
            
            const subjectRankSelect = document.getElementById('subjectRankStudentSelect');
            
            subjectRankSelect.innerHTML = '<option value="">选择学生</option>';
            
            displayStudents.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.name}`;
                subjectRankSelect.appendChild(option);
            });
        }

        // 更新学科趋势选择下拉框
        function updateSubjectTrendSelects() {
            // 获取当前考试的数据
            const currentExam = exams.find(exam => exam.id === currentExamId);
            const displayStudents = currentExam ? currentExam.data : students;
            
            const subjects = ['chinese', 'math', 'english', 'physics', 'chemistry', 'biology'];
            
            subjects.forEach(subject => {
                const selectElement = document.getElementById(`${subject}TrendSelect`);
                if (!selectElement) return;
                
                selectElement.innerHTML = '<option value="">选择学生</option>';
                
                displayStudents.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = `${student.name}`;
                    selectElement.appendChild(option);
                });
            });
        }

        // 更新分数线差距分析选择下拉框
        function updateLineDiffSelects() {
            // 获取当前考试的数据
            const currentExam = exams.find(exam => exam.id === currentExamId);
            const displayStudents = currentExam ? currentExam.data : [];
            
            // 更新总分差距选择
            const totalDiffSelect = document.getElementById('totalDiffStudentSelect');
            if (totalDiffSelect) {
                totalDiffSelect.innerHTML = '<option value="">选择学生查看差距</option>';
                displayStudents.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = `${student.name}`;
                    totalDiffSelect.appendChild(option);
                });
            }
            
            // 更新各学科差距选择
            const subjects = ['chinese', 'math', 'english', 'physics', 'chemistry', 'biology'];
            subjects.forEach(subject => {
                const selectElement = document.getElementById(`${subject}DiffStudentSelect`);
                if (!selectElement) return;
                
                selectElement.innerHTML = '<option value="">选择学生查看差距</option>';
                
                displayStudents.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = `${student.name}`;
                    selectElement.appendChild(option);
                });
            });
        }

        // 更新考试选择下拉框
        function updateExamSelects() {
            const trendExamSelect = document.getElementById('trendExamSelect');
            const rankTrendExamSelect = document.getElementById('rankTrendExamSelect');
            const subjectRankExamSelect = document.getElementById('subjectRankExamSelect');
            
            // 获取选中的考试
            const selectedExams = exams.filter(exam => selectedExamIds.includes(exam.id));
            
            // 更新趋势图考试选择
            updateSelectOptions(trendExamSelect, selectedExams);
            
            // 更新排名趋势考试选择
            updateSelectOptions(rankTrendExamSelect, selectedExams);
            
            // 更新学科排名趋势考试选择
            updateSelectOptions(subjectRankExamSelect, selectedExams);
            
            // 更新学科趋势考试选择
            const subjects = ['chinese', 'math', 'english', 'physics', 'chemistry', 'biology'];
            subjects.forEach(subject => {
                const selectElement = document.getElementById(`${subject}TrendExamSelect`);
                if (!selectElement) return;
                
                updateSelectOptions(selectElement, selectedExams);
            });
        }

        // 更新选择下拉框选项
        function updateSelectOptions(selectElement, examsList) {
            selectElement.innerHTML = '<option value="all">所有考试</option>';
            examsList.forEach(exam => {
                const option = document.createElement('option');
                option.value = exam.id;
                option.textContent = exam.name;
                selectElement.appendChild(option);
            });
        }

        // 更新考试复选框
        function updateExamCheckboxes() {
            const examCheckboxes = document.getElementById('examCheckboxes');
            examCheckboxes.innerHTML = '';
            
            if (exams.length === 0) {
                examCheckboxes.innerHTML = '<p style="color: #94a3b8; text-align: center;">暂无考试数据</p>';
                return;
            }
            
            exams.forEach(exam => {
                const checkboxItem = document.createElement('div');
                checkboxItem.className = 'exam-checkbox-item';
                checkboxItem.innerHTML = `
                    <input type="checkbox" id="exam-checkbox-${exam.id}" data-exam-id="${exam.id}" ${exam.selected ? 'checked' : ''}>
                    <label for="exam-checkbox-${exam.id}" class="exam-checkbox-label">
                        ${exam.name} (${exam.date})
                    </label>
                `;
                examCheckboxes.appendChild(checkboxItem);
            });
            
            // 绑定复选框事件
            document.querySelectorAll('#examCheckboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const examId = parseInt(this.getAttribute('data-exam-id'));
                    const exam = exams.find(e => e.id === examId);
                    if (exam) {
                        exam.selected = this.checked;
                    }
                });
            });
        }

        // 更新当前考试显示
        function updateCurrentExamDisplay() {
            // 更新当前考试按钮
            const currentExamButtons = document.getElementById('currentExamButtons');
            currentExamButtons.innerHTML = '';
            
            exams.forEach(exam => {
                const button = document.createElement('button');
                button.className = `exam-btn ${exam.id === currentExamId ? 'active' : ''}`;
                button.textContent = exam.name;
                button.addEventListener('click', () => {
                    switchCurrentExam(exam.id);
                });
                currentExamButtons.appendChild(button);
            });
            
            // 更新当前考试名称
            const currentExam = exams.find(exam => exam.id === currentExamId);
            if (currentExam) {
                document.getElementById('currentExamName').textContent = currentExam.name;
            }
        }

        // 切换当前考试
        function switchCurrentExam(examId) {
            currentExamId = examId;
            updateCurrentExamDisplay();
            renderStudentTable();
            updateClassStats();
            updateStudentSelects();
            updateSubjectTrendSelects();
            updateRankTrendSelect();
            updateSubjectRankSelects();
            updateLineDiffSelects();
            
            // 更新当前学科的图表
            const activeTab = document.querySelector('.subject-tab.active');
            if (activeTab) {
                updateSubjectAnalysis(activeTab.getAttribute('data-subject'));
                updateSubjectLineDiffAnalysis(activeTab.getAttribute('data-subject'));
            }
            
            // 更新总分分析
            if (document.getElementById('total-analysis').classList.contains('active')) {
                updateTotalAnalysis();
                updateTotalLineDiffAnalysis();
            }
            
            // 更新趋势图
            updateTrendChart();
        }

        // 更新考试分数线显示
        function updateExamLineDisplay() {
            // 更新当前分数线考试名称
            const currentExam = exams.find(exam => exam.id === currentLineExamId);
            if (currentExam) {
                document.getElementById('currentExamName').textContent = currentExam.name;
            }
            
            // 更新考试按钮
            const examLineButtons = document.getElementById('examLineButtons');
            examLineButtons.innerHTML = '';
            
            exams.forEach(exam => {
                const button = document.createElement('button');
                button.className = `exam-btn ${exam.id === currentLineExamId ? 'active' : ''}`;
                button.textContent = exam.name;
                button.addEventListener('click', () => {
                    switchExamForLines(exam.id);
                });
                examLineButtons.appendChild(button);
            });
            
            // 更新考试数量
            document.getElementById('examCount').textContent = exams.length;
        }

        // 切换考试（用于分数线设置）
        function switchExamForLines(examId) {
            currentLineExamId = examId;
            updateExamLineDisplay();
            
            // 更新分数线显示
            const currentExam = exams.find(exam => exam.id === currentLineExamId);
            if (currentExam) {
                scoreLines = JSON.parse(JSON.stringify(currentExam.lines));
                updateScoreLineDisplay();
                updateLineCounts();
            }
        }

        // 更新考试管理界面
        function updateExamManagement() {
            const examManagement = document.getElementById('examManagement');
            examManagement.innerHTML = '';
            
            if (exams.length === 0) return;
            
            const currentExam = exams.find(exam => exam.id === currentLineExamId);
            if (!currentExam) return;
            
            examManagement.innerHTML = `
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="editExamNameInput" class="exam-edit-input" value="${currentExam.name}" placeholder="考试名称">
                    <input type="date" id="editExamDateInput" class="exam-edit-input" value="${currentExam.date}">
                    <button class="exam-action-btn save" id="saveExamEditBtn">
                        <i class="fas fa-save"></i> 保存
                    </button>
                    <button class="exam-action-btn delete" id="deleteExamBtn">
                        <i class="fas fa-trash"></i> 删除
                    </button>
                </div>
            `;
            
            // 绑定事件
            document.getElementById('saveExamEditBtn').addEventListener('click', saveExamEditInline);
            document.getElementById('deleteExamBtn').addEventListener('click', deleteCurrentExam);
        }

        // 保存考试编辑（内联）
        function saveExamEditInline() {
            const examNameInput = document.getElementById('editExamNameInput');
            const examDateInput = document.getElementById('editExamDateInput');
            
            const newName = examNameInput.value.trim();
            const newDate = examDateInput.value;
            
            if (!newName) {
                alert('考试名称不能为空');
                examNameInput.focus();
                return;
            }
            
            const currentExam = exams.find(exam => exam.id === currentLineExamId);
            if (!currentExam) return;
            
            // 检查考试名称是否已存在（除了当前考试）
            const existingExam = exams.find(exam => exam.name === newName && exam.id !== currentLineExamId);
            if (existingExam) {
                alert('考试名称已存在，请使用其他名称');
                return;
            }
            
            // 保存更改
            currentExam.name = newName;
            currentExam.date = newDate;
            
            // 更新所有相关显示
            updateCurrentExamDisplay();
            updateExamLineDisplay();
            updateExamSelects();
            updateExamCheckboxes();
            updateExamLineAssociations();
            
            // 更新趋势图
            updateTrendChart();
            
            alert('考试信息已更新');
        }

        // 删除当前考试
        function deleteCurrentExam() {
            const currentExam = exams.find(exam => exam.id === currentLineExamId);
            if (!currentExam) return;
            
            if (exams.length <= 1) {
                alert('至少需要保留一个考试');
                return;
            }
            
            if (confirm(`确定要删除考试 "${currentExam.name}" 吗？此操作不可撤销。`)) {
                // 删除考试
                const examIndex = exams.findIndex(exam => exam.id === currentLineExamId);
                if (examIndex !== -1) {
                    exams.splice(examIndex, 1);
                }
                
                // 如果删除的是当前查看的考试，切换到第一个考试
                if (currentLineExamId === currentExamId) {
                    currentLineExamId = exams[0].id;
                    currentExamId = exams[0].id;
                }
                
                // 更新选中的考试ID列表
                selectedExamIds = selectedExamIds.filter(id => id !== currentLineExamId);
                if (selectedExamIds.length === 0 && exams.length > 0) {
                    selectedExamIds.push(exams[0].id);
                }
                
                // 更新所有显示
                updateCurrentExamDisplay();
                updateExamLineDisplay();
                updateExamSelects();
                updateExamCheckboxes();
                updateExamLineAssociations();
                updateExamManagement();
                renderStudentTable();
                updateClassStats();
                updateStudentSelects();
                updateSubjectTrendSelects();
                updateRankTrendSelect();
                updateSubjectRankSelects();
                updateLineDiffSelects();
                
                // 更新趋势图
                updateTrendChart();
                
                alert('考试已删除');
            }
        }

        // 添加新考试
        function addNewExam() {
            const examName = prompt('请输入新考试名称:', `考试${exams.length + 1}`);
            if (!examName || !examName.trim()) {
                return;
            }
            
            // 检查考试名称是否已存在
            if (exams.some(exam => exam.name === examName.trim())) {
                alert('考试名称已存在，请使用其他名称');
                return;
            }
            
            const examDate = prompt('请输入考试日期（格式：YYYY-MM-DD）:', new Date().toISOString().split('T')[0]);
            if (!examDate) {
                return;
            }
            
            // 创建新考试
            const newExamId = exams.length > 0 ? Math.max(...exams.map(e => e.id)) + 1 : 1;
            const newExam = {
                id: newExamId,
                name: examName.trim(),
                date: examDate,
                data: [],
                lines: JSON.parse(JSON.stringify(scoreLines)),
                selected: true,
                hasLines: true
            };
            
            exams.push(newExam);
            currentLineExamId = newExamId;
            selectedExamIds.push(newExamId);
            
            // 更新所有显示
            updateCurrentExamDisplay();
            updateExamLineDisplay();
            updateExamSelects();
            updateExamCheckboxes();
            updateExamLineAssociations();
            updateExamManagement();
            
            alert(`成功创建新考试 "${examName.trim()}"`);
        }

        // 编辑考试信息（模态框）
        function editExamInfo(examId) {
            const exam = exams.find(e => e.id === examId);
            if (!exam) return;
            
            editingExamId = examId;
            
            document.getElementById('editExamName').value = exam.name;
            document.getElementById('editExamDate').value = exam.date;
            
            document.getElementById('editExamModal').style.display = 'flex';
        }

        // 保存考试编辑（模态框）
        function saveExamEdit() {
            if (!editingExamId) return;
            
            const examName = document.getElementById('editExamName').value.trim();
            const examDate = document.getElementById('editExamDate').value;
            
            if (!examName) {
                alert('考试名称不能为空');
                return;
            }
            
            const exam = exams.find(e => e.id === editingExamId);
            if (!exam) return;
            
            // 检查考试名称是否已存在（除了当前考试）
            const existingExam = exams.find(e => e.name === examName && e.id !== editingExamId);
            if (existingExam) {
                alert('考试名称已存在，请使用其他名称');
                return;
            }
            
            // 保存更改
            exam.name = examName;
            exam.date = examDate;
            
            // 更新所有相关显示
            updateCurrentExamDisplay();
            updateExamLineDisplay();
            updateExamSelects();
            updateExamCheckboxes();
            updateExamLineAssociations();
            updateExamManagement();
            
            // 更新趋势图
            updateTrendChart();
            
            closeModal('editExamModal');
            editingExamId = null;
            
            alert('考试信息已更新');
        }

        // 更新考试分数线关联状态
        function updateExamLineAssociations() {
            const associationsContainer = document.getElementById('examLineAssociations');
            associationsContainer.innerHTML = '';
            
            if (exams.length === 0) {
                associationsContainer.innerHTML = '<p style="color: #64748b; text-align: center;">暂无考试数据</p>';
                return;
            }
            
            exams.forEach(exam => {
                const associationItem = document.createElement('div');
                associationItem.className = 'association-item';
                
                const statusClass = exam.hasLines ? 'status-has-line' : 'status-no-line';
                const statusText = exam.hasLines ? '已设置分数线' : '未设置分数线';
                
                associationItem.innerHTML = `
                    <div class="association-exam-name">${exam.name}</div>
                    <div class="association-line-info">${exam.date}</div>
                    <div class="association-line-status ${statusClass}">${statusText}</div>
                    <div style="display: flex; gap: 5px;">
                        <button class="exam-action-btn edit" data-exam-id="${exam.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                `;
                
                associationsContainer.appendChild(associationItem);
            });
            
            // 绑定编辑按钮事件
            document.querySelectorAll('.association-item .exam-action-btn.edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const examId = parseInt(this.getAttribute('data-exam-id'));
                    editExamInfo(examId);
                });
            });
        }

        // 更新分数线人数统计
        function updateLineCounts() {
            // 获取当前考试的数据
            const currentExam = exams.find(exam => exam.id === currentExamId);
            const displayStudents = currentExam ? currentExam.data : [];
            
            if (displayStudents.length === 0) {
                // 清空所有计数显示
                document.querySelectorAll('[id$="Count"]').forEach(element => {
                    element.textContent = '0';
                });
                return;
            }
            
            // 获取当前分数线（当前查看的考试的分数线）
            const currentLines = exams.find(exam => exam.id === currentLineExamId)?.lines || scoreLines;
            
            // 计算总分各分数线人数
            const totalScores = displayStudents.map(student => student.total || 0);
            const totalDoubleFirstCount = totalScores.filter(score => score >= currentLines.total.doubleFirst).length;
            const totalExcellentCount = totalScores.filter(score => score >= currentLines.total.excellent).length;
            const totalFirstTierCount = totalScores.filter(score => score >= currentLines.total.firstTier).length;
            const totalKeyTierCount = totalScores.filter(score => score >= currentLines.total.keyTier).length;
            
            // 更新总分分数线人数显示
            document.getElementById('totalDoubleFirstCount').textContent = `${totalDoubleFirstCount}人`;
            document.getElementById('totalExcellentCount').textContent = `${totalExcellentCount}人`;
            document.getElementById('totalFirstTierCount').textContent = `${totalFirstTierCount}人`;
            document.getElementById('totalKeyTierCount').textContent = `${totalKeyTierCount}人`;
            
            // 计算各学科分数线人数
            const subjects = ['chinese', 'math', 'english', 'physics', 'chemistry', 'biology'];
            subjects.forEach(subject => {
                const subjectScores = displayStudents.map(student => student[subject] || 0);
                const doubleFirstCount = subjectScores.filter(score => score >= currentLines[subject].doubleFirst).length;
                const excellentCount = subjectScores.filter(score => score >= currentLines[subject].excellent).length;
                const firstTierCount = subjectScores.filter(score => score >= currentLines[subject].firstTier).length;
                const keyTierCount = subjectScores.filter(score => score >= currentLines[subject].keyTier).length;
                
                // 更新学科分数线人数显示
                if (document.getElementById(`${subject}DoubleFirstCount`)) {
                    document.getElementById(`${subject}DoubleFirstCount`).textContent = doubleFirstCount;
                    document.getElementById(`${subject}ExcellentCount`).textContent = excellentCount;
                    document.getElementById(`${subject}FirstTierCount`).textContent = firstTierCount;
                    document.getElementById(`${subject}KeyTierCount`).textContent = keyTierCount;
                }
            });
        }

        // 显示导入分数线模态框
        function showImportLinesModal() {
            const currentExam = exams.find(exam => exam.id === currentLineExamId);
            if (!currentExam) {
                alert('请先选择考试');
                return;
            }
            
            // 触发文件选择
            document.getElementById('scoreLineExcelFile').click();
        }

        // 应用默认分数线
        function applyDefaultScoreLines() {
            const currentExam = exams.find(exam => exam.id === currentLineExamId);
            if (!currentExam) {
                alert('请先选择考试');
                return;
            }
            
            if (confirm(`确定要将默认分数线应用到考试 "${currentExam.name}" 吗？`)) {
                // 应用默认分数线
                currentExam.lines = {
                    total: { doubleFirst: 600.5, excellent: 556.5, firstTier: 451.5, keyTier: 328.5 },
                    chinese: { doubleFirst: 109, excellent: 104, firstTier: 87, keyTier: 70 },
                    math: { doubleFirst: 135, excellent: 117, firstTier: 79, keyTier: 38 },
                    english: { doubleFirst: 132, excellent: 128, firstTier: 107.5, keyTier: 63 },
                    physics: { doubleFirst: 81, excellent: 72, firstTier: 39, keyTier: 20 },
                    chemistry: { doubleFirst: 99, excellent: 89, firstTier: 66, keyTier: 38 },
                    biology: { doubleFirst: 94, excellent: 90, firstTier: 64, keyTier: 34 }
                };
                
                currentExam.hasLines = true;
                
                // 如果当前正在查看这个考试的分数线，更新显示
                if (currentLineExamId === currentExamId) {
                    scoreLines = JSON.parse(JSON.stringify(currentExam.lines));
                    updateScoreLineDisplay();
                    updateLineCounts();
                }
                
                // 更新考试分数线关联状态
                updateExamLineAssociations();
                
                // 更新趋势图
                updateTrendChart();
                
                // 更新分数线差距分析
                updateTotalLineDiffAnalysis();
                
                const activeTab = document.querySelector('.subject-tab.active');
                if (activeTab) {
                    const subject = activeTab.getAttribute('data-subject');
                    updateSubjectLineDiffAnalysis(subject);
                }
                
                alert(`成功为考试 "${currentExam.name}" 应用默认分数线`);
            }
        }

        // 全选考试
        function selectAllExams() {
            exams.forEach(exam => {
                exam.selected = true;
            });
            updateExamCheckboxes();
        }

        // 全不选考试
        function deselectAllExams() {
            exams.forEach(exam => {
                exam.selected = false;
            });
            updateExamCheckboxes();
        }

        // 应用考试选择
        function applyExamSelection() {
            // 更新选中的考试ID列表
            selectedExamIds = exams.filter(exam => exam.selected).map(exam => exam.id);
            
            // 如果当前考试没有被选中，切换到第一个被选中的考试
            if (!selectedExamIds.includes(currentExamId) && selectedExamIds.length > 0) {
                currentExamId = selectedExamIds[0];
                updateCurrentExamDisplay();
                renderStudentTable();
                updateClassStats();
                updateStudentSelects();
                updateSubjectTrendSelects();
                updateRankTrendSelect();
                updateSubjectRankSelects();
                updateLineDiffSelects();
            }
            
            // 更新考试选择下拉框
            updateExamSelects();
            
            // 更新所有图表
            updateTrendChart();
            updateRankTrendAnalysis();
            updateSubjectRankTrendAnalysis();
            
            const subjects = ['chinese', 'math', 'english', 'physics', 'chemistry', 'biology'];
            subjects.forEach(subject => {
                updateSubjectTrendChart(subject);
            });
            
            alert(`已选择 ${selectedExamIds.length} 个考试用于分析`);
        }

        // 更新班级统计
        function updateClassStats() {
            // 获取当前考试的数据
            const currentExam = exams.find(exam => exam.id === currentExamId);
            const displayStudents = currentExam ? currentExam.data : [];
            
            if (displayStudents.length === 0) {
                document.getElementById('classStats').innerHTML = '<div class="stat-card"><h3>暂无数据</h3></div>';
                return;
            }
            
            // 计算各科平均分
            const subjects = ['chinese', 'math', 'english', 'physics', 'chemistry', 'biology'];
            const averages = {};
            let totalSum = 0;
            let totalCount = 0;
            
            subjects.forEach(subject => {
                const sum = displayStudents.reduce((acc, student) => acc + (student[subject] || 0), 0);
                averages[subject] = (sum / displayStudents.length).toFixed(1);
                
                // 更新学科平均分显示
                const avgElement = document.getElementById(`${subject}Avg`);
                if (avgElement) {
                    avgElement.textContent = averages[subject];
                }
                
                totalSum += sum;
                totalCount += displayStudents.length;
            });
            
            const totalAvg = (totalSum / totalCount).toFixed(1);
            
            // 更新统计卡片
            document.getElementById('classStats').innerHTML = `
                <div class="stat-card">
                    <h3>语文平均分</h3>
                    <div class="stat-value">${averages.chinese}</div>
                    <p>满分150分</p>
                </div>
                <div class="stat-card">
                    <h3>数学平均分</h3>
                    <div class="stat-value">${averages.math}</div>
                    <p>满分150分</p>
                </div>
                <div class="stat-card">
                    <h3>英语平均分</h3>
                    <div class="stat-value">${averages.english}</div>
                    <p>满分150分</p>
                </div>
                <div class="stat-card">
                    <h3>总平均分</h3>
                    <div class="stat-value">${totalAvg}</div>
                    <p>学生人数: ${displayStudents.length}</p>
                </div>
            `;
        }

        // 更新总分分数线
        function updateTotalScoreLines() {
            // 获取输入值并确保是数字
            const keyTierValue = parseFloat(document.getElementById('keyTierLine').value);
            const firstTierValue = parseFloat(document.getElementById('firstTierLine').value);
            const excellentValue = parseFloat(document.getElementById('excellentLine').value);
            const doubleFirstValue = parseFloat(document.getElementById('doubleFirstLine').value);
            
            // 验证并更新
            if (!isNaN(keyTierValue) && keyTierValue >= 0 && keyTierValue <= 750) {
                scoreLines.total.keyTier = keyTierValue;
                document.getElementById('keyTierLine').value = scoreLines.total.keyTier;
            } else {
                alert('本科线请输入0-750之间的数字');
                document.getElementById('keyTierLine').value = scoreLines.total.keyTier;
                return;
            }
            
            if (!isNaN(firstTierValue) && firstTierValue >= 0 && firstTierValue <= 750) {
                scoreLines.total.firstTier = firstTierValue;
                document.getElementById('firstTierLine').value = scoreLines.total.firstTier;
            } else {
                alert('重本线请输入0-750之间的数字');
                document.getElementById('firstTierLine').value = scoreLines.total.firstTier;
                return;
            }
            
            if (!isNaN(excellentValue) && excellentValue >= 0 && excellentValue <= 750) {
                scoreLines.total.excellent = excellentValue;
                document.getElementById('excellentLine').value = scoreLines.total.excellent;
            } else {
                alert('高优线请输入0-750之间的数字');
                document.getElementById('excellentLine').value = scoreLines.total.excellent;
                return;
            }
            
            if (!isNaN(doubleFirstValue) && doubleFirstValue >= 0 && doubleFirstValue <= 750) {
                scoreLines.total.doubleFirst = doubleFirstValue;
                document.getElementById('doubleFirstLine').value = scoreLines.total.doubleFirst;
            } else {
                alert('双一流线请输入0-750之间的数字');
                document.getElementById('doubleFirstLine').value = scoreLines.total.doubleFirst;
                return;
            }
            
            // 更新当前考试的分数线
            const currentExam = exams.find(exam => exam.id === currentLineExamId);
            if (currentExam) {
                currentExam.lines.total = JSON.parse(JSON.stringify(scoreLines.total));
                currentExam.hasLines = true;
            }
            
            updateScoreLineDisplay();
            updateLineCounts();
            
            // 更新考试分数线关联状态
            updateExamLineAssociations();
            
            // 更新趋势图中的分数线
            updateTrendChart();
            
            // 更新分数线差距分析
            updateTotalLineDiffAnalysis();
            
            alert('总分分数线已更新！');
        }

        // 重置分数线
        function resetScoreLines() {
            const currentExam = exams.find(exam => exam.id === currentLineExamId);
            if (!currentExam) return;
            
            if (confirm(`确定要将考试 "${currentExam.name}" 的分数线重置为默认值吗？`)) {
                currentExam.lines = {
                    total: { doubleFirst: 600.5, excellent: 556.5, firstTier: 451.5, keyTier: 328.5 },
                    chinese: { doubleFirst: 109, excellent: 104, firstTier: 87, keyTier: 70 },
                    math: { doubleFirst: 135, excellent: 117, firstTier: 79, keyTier: 38 },
                    english: { doubleFirst: 132, excellent: 128, firstTier: 107.5, keyTier: 63 },
                    physics: { doubleFirst: 81, excellent: 72, firstTier: 39, keyTier: 20 },
                    chemistry: { doubleFirst: 99, excellent: 89, firstTier: 66, keyTier: 38 },
                    biology: { doubleFirst: 94, excellent: 90, firstTier: 64, keyTier: 34 }
                };
                
                currentExam.hasLines = true;
                
                // 如果当前正在查看这个考试的分数线，更新显示
                if (currentLineExamId === currentExamId) {
                    scoreLines = JSON.parse(JSON.stringify(currentExam.lines));
                    updateScoreLineDisplay();
                    updateLineCounts();
                }
                
                // 更新考试分数线关联状态
                updateExamLineAssociations();
                
                // 更新趋势图中的分数线
                updateTrendChart();
                
                // 更新分数线差距分析
                updateTotalLineDiffAnalysis();
                
                const activeTab = document.querySelector('.subject-tab.active');
                if (activeTab) {
                    const subject = activeTab.getAttribute('data-subject');
                    updateSubjectLineDiffAnalysis(subject);
                }
                
                alert('当前考试分数线已重置为默认值！');
            }
        }

        // 更新分数线显示
        function updateScoreLineDisplay() {
            // 更新总分分数线显示
            document.getElementById('keyTierLine').value = scoreLines.total.keyTier;
            document.getElementById('firstTierLine').value = scoreLines.total.firstTier;
            document.getElementById('excellentLine').value = scoreLines.total.excellent;
            document.getElementById('doubleFirstLine').value = scoreLines.total.doubleFirst;
            
            document.getElementById('totalKeyTier').value = scoreLines.total.keyTier;
            document.getElementById('totalFirstTier').value = scoreLines.total.firstTier;
            document.getElementById('totalExcellent').value = scoreLines.total.excellent;
            document.getElementById('totalDoubleFirst').value = scoreLines.total.doubleFirst;
            
            // 更新所有学科分数线显示
            const subjects = ['chinese', 'math', 'english', 'physics', 'chemistry', 'biology'];
            subjects.forEach(subject => {
                if (document.getElementById(`${subject}KeyTier`)) {
                    document.getElementById(`${subject}KeyTier`).value = scoreLines[subject].keyTier;
                    document.getElementById(`${subject}FirstTier`).value = scoreLines[subject].firstTier;
                    document.getElementById(`${subject}Excellent`).value = scoreLines[subject].excellent;
                    document.getElementById(`${subject}DoubleFirst`).value = scoreLines[subject].doubleFirst;
                }
            });
        }

        // 更新考试数据显示
        function updateExamDisplay() {
            // 更新考试复选框
            updateExamCheckboxes();
        }

        // 初始化图表
        function initCharts() {
            // 初始化雷达图（改为与分数线对比）
            const radarCtx = document.getElementById('radarChart').getContext('2d');
            charts.radar = new Chart(radarCtx, {
                type: 'radar',
                data: {
                    labels: ['语文', '数学', '英语', '物理', '化学', '生物'],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 150,
                            ticks: { stepSize: 30 }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.raw || 0;
                                    const lineType = context.dataset.lineType || '';
                                    const lineName = getLineTypeName(lineType) || '';
                                    const subject = context.label || '';
                                    const subjectCode = standardizeSubjectName(subject) || '';
                                    
                                    if (lineName) {
                                        return `${label}: ${value}分 (${lineName})`;
                                    } else {
                                        return `${label}: ${value}分`;
                                    }
                                }
                            }
                        }
                    }
                }
            });
            
            // 初始化趋势图（带有分数线）
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            charts.trend = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: [], // 动态生成考试名称
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 750,
                            title: { display: true, text: '总分' },
                            grid: {
                                drawBorder: false
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.raw || 0;
                                    const examIndex = context.dataIndex;
                                    const examName = charts.trend.data.labels[examIndex] || '';
                                    const lineType = context.dataset.lineType || '';
                                    const lineName = getLineTypeName(lineType) || '';
                                    
                                    if (lineName) {
                                        return `${label}: ${value}分 (${lineName})`;
                                    } else {
                                        return `${label}: ${value}分`;
                                    }
                                }
                            }
                        }
                    }
                }
            });
            
            // 初始化排名趋势图
            const rankTrendCtx = document.getElementById('rankTrendChart').getContext('2d');
            charts.rankTrend = new Chart(rankTrendCtx, {
                type: 'line',
                data: {
                    labels: [], // 动态生成考试名称
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            reverse: true, // 排名越小越靠上，所以y轴需要反转
                            beginAtZero: false,
                            title: { display: true, text: '排名' },
                            ticks: {
                                callback: function(value) {
                                    return '第' + value + '名';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `排名: 第${context.raw}名`;
                                }
                            }
                        }
                    }
                }
            });
            
            // 初始化学科排名趋势图
            const subjectRankTrendCtx = document.getElementById('subjectRankTrendChart').getContext('2d');
            charts.subjectRankTrend = new Chart(subjectRankTrendCtx, {
                type: 'line',
                data: {
                    labels: [], // 动态生成考试名称
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            reverse: true, // 排名越小越靠上，所以y轴需要反转
                            beginAtZero: false,
                            title: { display: true, text: '排名' },
                            ticks: {
                                callback: function(value) {
                                    return '第' + value + '名';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `排名: 第${context.raw}名`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 更新雷达图 - 改为与分数线对比，并精确匹配考试
        function updateRadarChart() {
            const studentId = document.getElementById('studentSelect').value;
            const examId = document.getElementById('radarExamSelect').value;
            
            if (!studentId || !examId) {
                charts.radar.data.datasets = [];
                charts.radar.update();
                return;
            }
            
            // 获取指定考试的数据
            const selectedExam = exams.find(exam => exam.id === parseInt(examId));
            if (!selectedExam) return;
            
            const displayStudents = selectedExam.data;
            const student = displayStudents.find(s => s.id === studentId);
            if (!student) return;
            
            // 获取指定考试的分数线
            const examLines = selectedExam.lines || scoreLines;
            
            // 获取当前考试的分数线
            const subjects = ['chinese', 'math', 'english', 'physics', 'chemistry', 'biology'];
            
            // 更新雷达图数据
            charts.radar.data.datasets = [
                {
                    label: `${student.name}的成绩（${selectedExam.name}）`,
                    data: subjects.map(subject => student[subject] || 0),
                    backgroundColor: 'rgba(67, 97, 238, 0.2)',
                    borderColor: '#4361ee',
                    borderWidth: 2,
                    pointBackgroundColor: '#4361ee'
                },
                {
                    label: '本科线',
                    data: subjects.map(subject => examLines[subject].keyTier),
                    backgroundColor: 'rgba(239, 68, 68, 0.2)',
                    borderColor: '#ef4444',
                    borderWidth: 1,
                    borderDash: [5, 5],
                    pointBackgroundColor: '#ef4444',
                    lineType: 'keyTier'
                },
                {
                    label: '重本线',
                    data: subjects.map(subject => examLines[subject].firstTier),
                    backgroundColor: 'rgba(245, 158, 11, 0.2)',
                    borderColor: '#f59e0b',
                    borderWidth: 1,
                    borderDash: [5, 5],
                    pointBackgroundColor: '#f59e0b',
                    lineType: 'firstTier'
                },
                {
                    label: '高优线',
                    data: subjects.map(subject => examLines[subject].excellent),
                    backgroundColor: 'rgba(22, 163, 74, 0.2)',
                    borderColor: '#16a34a',
                    borderWidth: 1,
                    borderDash: [5, 5],
                    pointBackgroundColor: '#16a34a',
                    lineType: 'excellent'
                },
                {
                    label: '双一流线',
                    data: subjects.map(subject => examLines[subject].doubleFirst),
                    backgroundColor: 'rgba(37, 99, 235, 0.2)',
                    borderColor: '#2563eb',
                    borderWidth: 1,
                    borderDash: [5, 5],
                    pointBackgroundColor: '#2563eb',
                    lineType: 'doubleFirst'
                }
            ];
            
            charts.radar.update();
        }

        // 更新趋势图 - 添加分数线显示功能，精确匹配每个考试的分数线
        function updateTrendChart() {
            const studentId = document.getElementById('trendStudentSelect').value;
            const examSelect = document.getElementById('trendExamSelect');
            const examId = examSelect.value;
            
            if (!studentId) {
                charts.trend.data.datasets = [];
                charts.trend.update();
                clearTrendLineLegend();
                return;
            }
            
            // 获取选中的考试
            let examsToShow;
            if (examId === 'all') {
                examsToShow = exams.filter(exam => selectedExamIds.includes(exam.id));
            } else {
                examsToShow = exams.filter(exam => exam.id === parseInt(examId));
            }
            
            if (examsToShow.length === 0) {
                charts.trend.data.datasets = [];
                charts.trend.update();
                clearTrendLineLegend();
                return;
            }
            
            // 按考试日期排序
            examsToShow.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // 准备数据
            const labels = examsToShow.map(exam => exam.name);
            const studentData = [];
            const lineDatasets = [];
            
            examsToShow.forEach(exam => {
                const student = exam.data.find(s => s.id === studentId);
                if (student) {
                    studentData.push(student.total || 0);
                } else {
                    studentData.push(null);
                }
            });
            
            // 创建分数线数据集（每个考试的分数线不同）
            const lineTypes = ['keyTier', 'firstTier', 'excellent', 'doubleFirst'];
            const lineColors = {
                'keyTier': '#ef4444',
                'firstTier': '#f59e0b',
                'excellent': '#16a34a',
                'doubleFirst': '#2563eb'
            };
            const lineNames = {
                'keyTier': '本科线',
                'firstTier': '重本线',
                'excellent': '高优线',
                'doubleFirst': '双一流线'
            };
            
            // 为每种分数线类型创建数据集，使用每个考试自己的分数线
            lineTypes.forEach(lineType => {
                const lineData = examsToShow.map(exam => {
                    return exam.lines?.total?.[lineType] || 0;
                });
                
                lineDatasets.push({
                    label: lineNames[lineType],
                    data: lineData,
                    borderColor: lineColors[lineType],
                    backgroundColor: `${lineColors[lineType]}20`,
                    borderWidth: 1,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    lineType: lineType
                });
            });
            
            // 更新趋势图
            charts.trend.data.labels = labels;
            charts.trend.data.datasets = [
                {
                    label: document.getElementById('trendStudentSelect').selectedOptions[0]?.text || '学生',
                    data: studentData,
                    borderColor: '#4361ee',
                    backgroundColor: 'rgba(67, 97, 238, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.3,
                    pointRadius: 4,
                    pointHoverRadius: 6
                },
                ...lineDatasets
            ];
            
            charts.trend.update();
            
            // 更新趋势图图例
            updateTrendLineLegend(lineTypes, lineNames, lineColors);
        }

        // 清除趋势图图例
        function clearTrendLineLegend() {
            const legendContainer = document.getElementById('trendLineLegend');
            if (legendContainer) {
                legendContainer.innerHTML = '';
            }
        }

        // 更新趋势图图例
        function updateTrendLineLegend(lineTypes, lineNames, lineColors) {
            const legendContainer = document.getElementById('trendLineLegend');
            if (!legendContainer) return;
            
            legendContainer.innerHTML = '<div style="font-weight: 600; margin-bottom: 5px;">分数线图例:</div>';
            
            lineTypes.forEach(lineType => {
                const lineItem = document.createElement('div');
                lineItem.className = 'trend-line-item';
                lineItem.innerHTML = `
                    <div class="trend-line-color" style="background-color: ${lineColors[lineType]};"></div>
                    <div class="trend-line-label">${lineNames[lineType]}</div>
                `;
                legendContainer.appendChild(lineItem);
            });
        }

        // 更新排名趋势分析
        function updateRankTrendAnalysis() {
            const studentId = document.getElementById('rankTrendStudentSelect').value;
            const examSelect = document.getElementById('rankTrendExamSelect');
            const examId = examSelect.value;
            
            if (!studentId) {
                // 清除图表和数据
                charts.rankTrend.data.datasets = [];
                charts.rankTrend.update();
                document.getElementById('rankTrendTableBody').innerHTML = '';
                document.getElementById('bestRank').textContent = '--';
                document.getElementById('worstRank').textContent = '--';
                document.getElementById('avgRank').textContent = '--';
                document.getElementById('rankStability').textContent = '--';
                return;
            }
            
            // 获取选中的考试
            let examsToShow;
            if (examId === 'all') {
                examsToShow = exams.filter(exam => selectedExamIds.includes(exam.id));
            } else {
                examsToShow = exams.filter(exam => exam.id === parseInt(examId));
            }
            
            if (examsToShow.length === 0) {
                charts.rankTrend.data.datasets = [];
                charts.rankTrend.update();
                document.getElementById('rankTrendTableBody').innerHTML = '';
                return;
            }
            
            // 按考试日期排序
            examsToShow.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // 准备数据
            const labels = examsToShow.map(exam => exam.name);
            const rankData = [];
            const scoreData = [];
            const rankChanges = [];
            const comparisons = [];
            
            let prevRank = null;
            
            examsToShow.forEach((exam, index) => {
                const student = exam.data.find(s => s.id === studentId);
                let rank = null;
                let totalScore = null;
                
                if (student) {
                    totalScore = student.total || 0;
                    
                    // 使用上传表格中的排名数据
                    rank = student.gradeRank || student.totalRank;
                    
                    // 如果没有年级排名，使用总分排名
                    if (!rank) {
                        rank = student.totalRank;
                    }
                }
                
                rankData.push(rank);
                scoreData.push(totalScore);
                
                // 计算排名变化
                let rankChange = '';
                let comparison = '';
                
                if (rank !== null && prevRank !== null) {
                    const change = prevRank - rank; // 正数表示进步，负数表示退步
                    
                    if (change > 0) {
                        rankChange = `<span class="rank-indicator rank-up">↑${Math.abs(change)}</span>`;
                        comparison = `<span style="color: #16a34a;">进步了 ${Math.abs(change)} 名</span>`;
                    } else if (change < 0) {
                        rankChange = `<span class="rank-indicator rank-down">↓${Math.abs(change)}</span>`;
                        comparison = `<span style="color: #ef4444;">退步了 ${Math.abs(change)} 名</span>`;
                    } else {
                        rankChange = `<span class="rank-indicator rank-same">→</span>`;
                        comparison = `<span style="color: #64748b;">排名不变</span>`;
                    }
                } else if (index === 0) {
                    comparison = `<span style="color: #64748b;">首次考试</span>`;
                } else {
                    comparison = `<span style="color: #64748b;">数据缺失</span>`;
                }
                
                rankChanges.push(rankChange);
                comparisons.push(comparison);
                
                if (rank !== null) {
                    prevRank = rank;
                }
            });
            
            // 更新排名趋势图表
            charts.rankTrend.data.labels = labels;
            charts.rankTrend.data.datasets = [
                {
                    label: '总分排名',
                    data: rankData,
                    borderColor: '#4361ee',
                    backgroundColor: 'rgba(67, 97, 238, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.3
                }
            ];
            
            charts.rankTrend.update();
            
            // 更新排名趋势表格
            const tableBody = document.getElementById('rankTrendTableBody');
            tableBody.innerHTML = '';
            
            examsToShow.forEach((exam, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${exam.name}</td>
                    <td>${exam.date}</td>
                    <td>${scoreData[index] !== null ? scoreData[index] : '--'}</td>
                    <td>${rankData[index] !== null ? `第${rankData[index]}名` : '--'}</td>
                    <td>${rankChanges[index]}</td>
                    <td>${comparisons[index]}</td>
                `;
                tableBody.appendChild(row);
            });
            
            // 计算并更新排名统计
            const validRanks = rankData.filter(r => r !== null);
            if (validRanks.length > 0) {
                const bestRank = Math.min(...validRanks);
                const worstRank = Math.max(...validRanks);
                const avgRank = (validRanks.reduce((a, b) => a + b, 0) / validRanks.length).toFixed(1);
                
                // 计算排名稳定性（标准差）
                const mean = validRanks.reduce((a, b) => a + b, 0) / validRanks.length;
                const squaredDiffs = validRanks.map(r => Math.pow(r - mean, 2));
                const variance = squaredDiffs.reduce((a, b) => a + b, 0) / validRanks.length;
                const stability = Math.sqrt(variance).toFixed(1);
                
                // 找到最佳和最差排名对应的考试
                const bestRankExamIndex = rankData.findIndex(r => r === bestRank);
                const worstRankExamIndex = rankData.findIndex(r => r === worstRank);
                
                document.getElementById('bestRank').textContent = `第${bestRank}名`;
                document.getElementById('bestRankExam').textContent = bestRankExamIndex !== -1 ? examsToShow[bestRankExamIndex].name : '--';
                
                document.getElementById('worstRank').textContent = `第${worstRank}名`;
                document.getElementById('worstRankExam').textContent = worstRankExamIndex !== -1 ? examsToShow[worstRankExamIndex].name : '--';
                
                document.getElementById('avgRank').textContent = `第${avgRank}名`;
                document.getElementById('rankStability').textContent = stability;
            }
        }

        // 更新学科排名趋势分析 - 使用上传表格中的排名数据
        function updateSubjectRankTrendAnalysis() {
            const studentId = document.getElementById('subjectRankStudentSelect').value;
            const subject = document.getElementById('subjectRankSubjectSelect').value;
            const examSelect = document.getElementById('subjectRankExamSelect');
            const examId = examSelect.value;
            
            if (!studentId) {
                // 清除图表和数据
                charts.subjectRankTrend.data.datasets = [];
                charts.subjectRankTrend.update();
                document.getElementById('subjectRankTableBody').innerHTML = '';
                document.getElementById('subjectBestRank').textContent = '--';
                document.getElementById('subjectWorstRank').textContent = '--';
                document.getElementById('subjectAvgRank').textContent = '--';
                document.getElementById('subjectRankStability').textContent = '--';
                return;
            }
            
            // 获取选中的考试
            let examsToShow;
            if (examId === 'all') {
                examsToShow = exams.filter(exam => selectedExamIds.includes(exam.id));
            } else {
                examsToShow = exams.filter(exam => exam.id === parseInt(examId));
            }
            
            if (examsToShow.length === 0) {
                charts.subjectRankTrend.data.datasets = [];
                charts.subjectRankTrend.update();
                document.getElementById('subjectRankTableBody').innerHTML = '';
                return;
            }
            
            // 按考试日期排序
            examsToShow.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // 准备数据
            const labels = examsToShow.map(exam => exam.name);
            const rankData = [];
            const scoreData = [];
            const rankChanges = [];
            const comparisons = [];
            
            let prevRank = null;
            
            examsToShow.forEach((exam, index) => {
                const student = exam.data.find(s => s.id === studentId);
                let rank = null;
                let subjectScore = null;
                
                if (student) {
                    subjectScore = student[subject] || 0;
                    
                    // 使用上传表格中的排名数据
                    rank = student[`${subject}GradeRank`] || student[`${subject}Rank`];
                }
                
                rankData.push(rank);
                scoreData.push(subjectScore);
                
                // 计算排名变化
                let rankChange = '';
                let comparison = '';
                
                if (rank !== null && prevRank !== null) {
                    const change = prevRank - rank; // 正数表示进步，负数表示退步
                    
                    if (change > 0) {
                        rankChange = `<span class="rank-indicator rank-up">↑${Math.abs(change)}</span>`;
                        comparison = `<span style="color: #16a34a;">进步了 ${Math.abs(change)} 名</span>`;
                    } else if (change < 0) {
                        rankChange = `<span class="rank-indicator rank-down">↓${Math.abs(change)}</span>`;
                        comparison = `<span style="color: #ef4444;">退步了 ${Math.abs(change)} 名</span>`;
                    } else {
                        rankChange = `<span class="rank-indicator rank-same">→</span>`;
                        comparison = `<span style="color: #64748b;">排名不变</span>`;
                    }
                } else if (index === 0) {
                    comparison = `<span style="color: #64748b;">首次考试</span>`;
                } else {
                    comparison = `<span style="color: #64748b;">数据缺失</span>`;
                }
                
                rankChanges.push(rankChange);
                comparisons.push(comparison);
                
                if (rank !== null) {
                    prevRank = rank;
                }
            });
            
            // 更新学科排名趋势图表
            charts.subjectRankTrend.data.labels = labels;
            charts.subjectRankTrend.data.datasets = [
                {
                    label: getSubjectName(subject) + '排名',
                    data: rankData,
                    borderColor: '#4361ee',
                    backgroundColor: 'rgba(67, 97, 238, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.3
                }
            ];
            
            charts.subjectRankTrend.update();
            
            // 更新学科排名趋势表格
            const tableBody = document.getElementById('subjectRankTableBody');
            tableBody.innerHTML = '';
            
            examsToShow.forEach((exam, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${exam.name}</td>
                    <td>${exam.date}</td>
                    <td>${scoreData[index] !== null ? scoreData[index] : '--'}</td>
                    <td>${rankData[index] !== null ? `第${rankData[index]}名` : '--'}</td>
                    <td>${rankChanges[index]}</td>
                    <td>${comparisons[index]}</td>
                `;
                tableBody.appendChild(row);
            });
            
            // 计算并更新学科排名统计
            const validRanks = rankData.filter(r => r !== null);
            if (validRanks.length > 0) {
                const bestRank = Math.min(...validRanks);
                const worstRank = Math.max(...validRanks);
                const avgRank = (validRanks.reduce((a, b) => a + b, 0) / validRanks.length).toFixed(1);
                
                // 计算排名稳定性（标准差）
                const mean = validRanks.reduce((a, b) => a + b, 0) / validRanks.length;
                const squaredDiffs = validRanks.map(r => Math.pow(r - mean, 2));
                const variance = squaredDiffs.reduce((a, b) => a + b, 0) / validRanks.length;
                const stability = Math.sqrt(variance).toFixed(1);
                
                // 找到最佳和最差排名对应的考试
                const bestRankExamIndex = rankData.findIndex(r => r === bestRank);
                const worstRankExamIndex = rankData.findIndex(r => r === worstRank);
                
                document.getElementById('subjectBestRank').textContent = `第${bestRank}名`;
                document.getElementById('subjectBestRankExam').textContent = bestRankExamIndex !== -1 ? examsToShow[bestRankExamIndex].name : '--';
                
                document.getElementById('subjectWorstRank').textContent = `第${worstRank}名`;
                document.getElementById('subjectWorstRankExam').textContent = worstRankExamIndex !== -1 ? examsToShow[worstRankExamIndex].name : '--';
                
                document.getElementById('subjectAvgRank').textContent = `第${avgRank}名`;
                document.getElementById('subjectRankStability').textContent = stability;
            }
        }

        // 更新学科趋势图 - 改为与分数线对比，精确匹配每个考试的分数线
        function updateSubjectTrendChart(subject) {
            const studentId = document.getElementById(`${subject}TrendSelect`).value;
            const examSelect = document.getElementById(`${subject}TrendExamSelect`);
            const examId = examSelect.value;
            
            if (!studentId) return;
            
            // 获取选中的考试
            let examsToShow;
            if (examId === 'all') {
                examsToShow = exams.filter(exam => selectedExamIds.includes(exam.id));
            } else {
                examsToShow = exams.filter(exam => exam.id === parseInt(examId));
            }
            
            if (examsToShow.length === 0) return;
            
            // 按考试日期排序
            examsToShow.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // 准备数据
            const labels = examsToShow.map(exam => exam.name);
            const studentData = [];
            
            examsToShow.forEach(exam => {
                const student = exam.data.find(s => s.id === studentId);
                if (student) {
                    studentData.push(student[subject] || 0);
                } else {
                    studentData.push(null);
                }
            });
            
            // 获取图表元素
            const canvas = document.getElementById(`${subject}TrendChart`);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // 如果图表已经存在，销毁它
            if (charts[`${subject}Trend`]) {
                charts[`${subject}Trend`].destroy();
            }
            
            // 创建分数线数据集（每个考试的分数线不同）
            const lineTypes = ['keyTier', 'firstTier', 'excellent', 'doubleFirst'];
            const lineColors = {
                'keyTier': '#ef4444',
                'firstTier': '#f59e0b',
                'excellent': '#16a34a',
                'doubleFirst': '#2563eb'
            };
            const lineNames = {
                'keyTier': '本科线',
                'firstTier': '重本线',
                'excellent': '高优线',
                'doubleFirst': '双一流线'
            };
            
            // 为每种分数线类型创建数据集，使用每个考试自己的分数线
            const lineDatasets = lineTypes.map(lineType => {
                const lineData = examsToShow.map(exam => {
                    return exam.lines?.[subject]?.[lineType] || 0;
                });
                
                return {
                    label: lineNames[lineType],
                    data: lineData,
                    borderColor: lineColors[lineType],
                    backgroundColor: `${lineColors[lineType]}20`,
                    borderWidth: 1,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    lineType: lineType
                };
            });
            
            // 创建新图表
            charts[`${subject}Trend`] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: `${document.getElementById(`${subject}TrendSelect`).selectedOptions[0]?.text || '学生'}（${getSubjectName(subject)}）`,
                            data: studentData,
                            borderColor: '#4361ee',
                            backgroundColor: 'rgba(67, 97, 238, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.3,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        ...lineDatasets
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: subject === 'chinese' || subject === 'math' || subject === 'english' ? 150 : 100,
                            title: { display: true, text: '分数' }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.raw || 0;
                                    const examIndex = context.dataIndex;
                                    const examName = labels[examIndex] || '';
                                    const lineType = context.dataset.lineType || '';
                                    const lineName = getLineTypeName(lineType) || '';
                                    
                                    if (lineName) {
                                        return `${label}: ${value}分 (${lineName})`;
                                    } else {
                                        return `${label}: ${value}分`;
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }

        // 新增：更新总分分析考试选择器
        function updateTotalAnalysisExamSelector() {
            const totalAnalysisExamButtons = document.getElementById('totalAnalysisExamButtons');
            totalAnalysisExamButtons.innerHTML = '';
            
            exams.forEach(exam => {
                const button = document.createElement('button');
                button.className = `exam-btn ${exam.id === totalAnalysisExamId ? 'active' : ''}`;
                button.textContent = exam.name;
                button.addEventListener('click', () => {
                    switchTotalAnalysisExam(exam.id);
                });
                totalAnalysisExamButtons.appendChild(button);
            });
        }

        // 新增：切换总分分析考试
        function switchTotalAnalysisExam(examId) {
            totalAnalysisExamId = examId;
            updateTotalAnalysisExamSelector();
            updateTotalAnalysis();
        }

        // 新增：更新学科分析考试选择器
        function updateSubjectAnalysisExamSelector() {
            const subjectAnalysisExamButtons = document.getElementById('subjectAnalysisExamButtons');
            subjectAnalysisExamButtons.innerHTML = '';
            
            exams.forEach(exam => {
                const button = document.createElement('button');
                button.className = `exam-btn ${exam.id === subjectAnalysisExamId ? 'active' : ''}`;
                button.textContent = exam.name;
                button.addEventListener('click', () => {
                    switchSubjectAnalysisExam(exam.id);
                });
                subjectAnalysisExamButtons.appendChild(button);
            });
        }

        // 新增：切换学科分析考试
        function switchSubjectAnalysisExam(examId) {
            subjectAnalysisExamId = examId;
            updateSubjectAnalysisExamSelector();
            
            // 更新当前学科的图表
            const activeTab = document.querySelector('.subject-tab.active');
            if (activeTab) {
                updateSubjectAnalysis(activeTab.getAttribute('data-subject'));
                updateSubjectLineDiffAnalysis(activeTab.getAttribute('data-subject'));
            }
        }

        // 更新总分分析 - 使用指定考试的数据
        function updateTotalAnalysis() {
            // 获取指定考试的数据
            const selectedExam = exams.find(exam => exam.id === totalAnalysisExamId);
            const displayStudents = selectedExam ? selectedExam.data : [];
            
            if (displayStudents.length === 0) return;
            
            // 计算每个学生的总分
            const totalScores = displayStudents.map(student => student.total || 0);
            
            // 获取指定考试的分数线
            const examLines = selectedExam ? selectedExam.lines : scoreLines;
            
            // 更新总分分布直方图
            updateTotalScoreChart(totalScores, examLines);
            
            // 更新分数线分布图
            updateScoreLineChart(totalScores, examLines);
            
            // 更新排名表格
            updateRankTable(displayStudents, examLines);
        }

        // 更新总分分布直方图
        function updateTotalScoreChart(scores, currentLines) {
            const canvas = document.getElementById('totalScoreChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // 如果图表已经存在，销毁它
            if (charts.totalScore) {
                charts.totalScore.destroy();
            }
            
            // 计算分数段
            const maxScore = 750;
            const binSize = 50;
            const bins = Math.ceil(maxScore / binSize);
            const data = new Array(bins).fill(0);
            
            scores.forEach(score => {
                const binIndex = Math.min(Math.floor(score / binSize), bins - 1);
                data[binIndex]++;
            });
            
            // 创建标签
            const labels = [];
            for (let i = 0; i < bins; i++) {
                const start = i * binSize;
                const end = Math.min((i + 1) * binSize - 1, maxScore);
                labels.push(`${start}-${end}`);
            }
            
            // 创建新图表
            charts.totalScore = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '学生人数',
                        data: data,
                        backgroundColor: 'rgba(67, 97, 238, 0.7)',
                        borderColor: '#4361ee',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: '学生人数' }
                        },
                        x: {
                            title: { display: true, text: '总分区间' }
                        }
                    }
                }
            });
        }

        // 更新分数线分布图
        function updateScoreLineChart(scores, currentLines) {
            const canvas = document.getElementById('scoreLineChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // 如果图表已经存在，销毁它
            if (charts.scoreLine) {
                charts.scoreLine.destroy();
            }
            
            // 计算各分数线以上人数
            const belowKeyTier = scores.filter(score => score < currentLines.total.keyTier).length;
            const betweenKeyAndFirst = scores.filter(score => score >= currentLines.total.keyTier && score < currentLines.total.firstTier).length;
            const betweenFirstAndExcellent = scores.filter(score => score >= currentLines.total.firstTier && score < currentLines.total.excellent).length;
            const betweenExcellentAndDouble = scores.filter(score => score >= currentLines.total.excellent && score < currentLines.total.doubleFirst).length;
            const aboveDoubleFirst = scores.filter(score => score >= currentLines.total.doubleFirst).length;
            
            // 创建新图表
            charts.scoreLine = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: [
                        `低于本科线 (${belowKeyTier}人)`,
                        `本科线-重本线 (${betweenKeyAndFirst}人)`,
                        `重本线-高优线 (${betweenFirstAndExcellent}人)`,
                        `高优线-双一流线 (${betweenExcellentAndDouble}人)`,
                        `高于双一流线 (${aboveDoubleFirst}人)`
                    ],
                    datasets: [{
                        data: [belowKeyTier, betweenKeyAndFirst, betweenFirstAndExcellent, betweenExcellentAndDouble, aboveDoubleFirst],
                        backgroundColor: [
                            'rgba(100, 116, 139, 0.7)',
                            'rgba(239, 68, 68, 0.7)',
                            'rgba(245, 158, 11, 0.7)',
                            'rgba(22, 163, 74, 0.7)',
                            'rgba(37, 99, 235, 0.7)'
                        ],
                        borderColor: [
                            '#64748b',
                            '#ef4444',
                            '#f59e0b',
                            '#16a34a',
                            '#2563eb'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // 更新排名表格
        function updateRankTable(students, currentLines) {
            const tbody = document.getElementById('rankTableBody');
            tbody.innerHTML = '';
            
            if (students.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `<td colspan="5" style="text-align: center; padding: 40px; color: #94a3b8;">暂无学生数据</td>`;
                tbody.appendChild(emptyRow);
                return;
            }
            
            // 按总分排序
            const sortedStudents = [...students].sort((a, b) => (b.total || 0) - (a.total || 0));
            
            // 渲染排名行
            let rank = 1;
            for (let i = 0; i < sortedStudents.length; i++) {
                const student = sortedStudents[i];
                
                // 处理并列排名
                if (i > 0 && student.total !== sortedStudents[i-1].total) {
                    rank = i + 1;
                }
                
                // 获取年级排名（使用上传表格中的排名数据）
                const gradeRank = student.gradeRank || student.totalRank || '--';
                
                // 确定分数线状态
                let status = '';
                let statusClass = '';
                
                if (student.total >= currentLines.total.doubleFirst) {
                    status = '高于双一流线';
                    statusClass = 'above-double-first';
                } else if (student.total >= currentLines.total.excellent) {
                    status = '高于高优线';
                    statusClass = 'above-excellent';
                } else if (student.total >= currentLines.total.firstTier) {
                    status = '高于重本线';
                    statusClass = 'above-first-tier';
                } else if (student.total >= currentLines.total.keyTier) {
                    status = '高于本科线';
                    statusClass = 'above-key-tier';
                } else {
                    status = '低于本科线';
                    statusClass = 'below-line';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${rank}</td>
                    <td>${student.name}</td>
                    <td><strong>${student.total || 0}</strong></td>
                    <td><span class="rank-label grade-rank">${gradeRank}</span></td>
                    <td class="${statusClass}">${status}</td>
                `;
                tbody.appendChild(row);
            }
        }

        // 更新学科分析 - 使用指定考试的数据
        function updateSubjectAnalysis(subject) {
            if (!subject) {
                const activeTab = document.querySelector('.subject-tab.active');
                if (activeTab) {
                    subject = activeTab.getAttribute('data-subject');
                } else {
                    return;
                }
            }
            
            // 获取指定考试的数据
            const selectedExam = exams.find(exam => exam.id === subjectAnalysisExamId);
            const displayStudents = selectedExam ? selectedExam.data : [];
            
            if (displayStudents.length === 0) return;
            
            // 获取该学科的分数
            const scores = displayStudents.map(student => student[subject] || 0);
            
            // 获取指定考试的分数线
            const examLines = selectedExam ? selectedExam.lines : scoreLines;
            
            // 更新学科分布图
            updateSubjectDistributionChart(subject, scores);
            
            // 更新学科分数线图
            updateSubjectLineChart(subject, scores, examLines);
            
            // 更新学科统计
            updateSubjectStats(subject, scores);
        }

        // 更新学科分布图
        function updateSubjectDistributionChart(subject, scores) {
            const canvas = document.getElementById(`${subject}DistributionChart`);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // 如果图表已经存在，销毁它
            if (charts[`${subject}Distribution`]) {
                charts[`${subject}Distribution`].destroy();
            }
            
            // 计算分数段
            const maxScore = subject === 'chinese' || subject === 'math' || subject === 'english' ? 150 : 100;
            const binSize = subject === 'chinese' || subject === 'math' || subject === 'english' ? 15 : 10;
            const bins = Math.ceil(maxScore / binSize);
            const data = new Array(bins).fill(0);
            
            scores.forEach(score => {
                const binIndex = Math.min(Math.floor(score / binSize), bins - 1);
                data[binIndex]++;
            });
            
            // 创建标签
            const labels = [];
            for (let i = 0; i < bins; i++) {
                const start = i * binSize;
                const end = Math.min((i + 1) * binSize - 1, maxScore);
                labels.push(`${start}-${end}`);
            }
            
            // 创建新图表
            charts[`${subject}Distribution`] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '学生人数',
                        data: data,
                        backgroundColor: 'rgba(67, 97, 238, 0.7)',
                        borderColor: '#4361ee',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: '学生人数' }
                        },
                        x: {
                            title: { display: true, text: '分数区间' }
                        }
                    }
                }
            });
        }

        // 更新学科分数线图
        function updateSubjectLineChart(subject, scores, currentLines) {
            const canvas = document.getElementById(`${subject}LineChart`);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // 如果图表已经存在，销毁它
            if (charts[`${subject}Line`]) {
                charts[`${subject}Line`].destroy();
            }
            
            // 计算各分数线以上人数
            const belowKeyTier = scores.filter(score => score < currentLines[subject].keyTier).length;
            const betweenKeyAndFirst = scores.filter(score => score >= currentLines[subject].keyTier && score < currentLines[subject].firstTier).length;
            const betweenFirstAndExcellent = scores.filter(score => score >= currentLines[subject].firstTier && score < currentLines[subject].excellent).length;
            const betweenExcellentAndDouble = scores.filter(score => score >= currentLines[subject].excellent && score < currentLines[subject].doubleFirst).length;
            const aboveDoubleFirst = scores.filter(score => score >= currentLines[subject].doubleFirst).length;
            
            // 创建新图表
            charts[`${subject}Line`] = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: [
                        `低于本科线 (${belowKeyTier}人)`,
                        `本科线-重本线 (${betweenKeyAndFirst}人)`,
                        `重本线-高优线 (${betweenFirstAndExcellent}人)`,
                        `高优线-双一流线 (${betweenExcellentAndDouble}人)`,
                        `高于双一流线 (${aboveDoubleFirst}人)`
                    ],
                    datasets: [{
                        data: [belowKeyTier, betweenKeyAndFirst, betweenFirstAndExcellent, betweenExcellentAndDouble, aboveDoubleFirst],
                        backgroundColor: [
                            'rgba(100, 116, 139, 0.7)',
                            'rgba(239, 68, 68, 0.7)',
                            'rgba(245, 158, 11, 0.7)',
                            'rgba(22, 163, 74, 0.7)',
                            'rgba(37, 99, 235, 0.7)'
                        ],
                        borderColor: [
                            '#64748b',
                            '#ef4444',
                            '#f59e0b',
                            '#16a34a',
                            '#2563eb'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // 更新学科统计
        function updateSubjectStats(subject, scores) {
            const statsContainer = document.getElementById(`${subject}Stats`);
            if (!statsContainer) return;
            
            if (scores.length === 0) {
                statsContainer.innerHTML = '<div class="stat-card"><h3>暂无数据</h3></div>';
                return;
            }
            
            // 计算统计信息
            const sum = scores.reduce((a, b) => a + b, 0);
            const avg = (sum / scores.length).toFixed(1);
            const max = Math.max(...scores);
            const min = Math.min(...scores);
            
            // 计算标准差
            const mean = sum / scores.length;
            const squaredDiffs = scores.map(score => Math.pow(score - mean, 2));
            const variance = squaredDiffs.reduce((a, b) => a + b, 0) / scores.length;
            const stdDev = Math.sqrt(variance).toFixed(1);
            
            // 更新统计卡片
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <h3>平均分</h3>
                    <div class="stat-value">${avg}</div>
                    <p>全班平均</p>
                </div>
                <div class="stat-card">
                    <h3>最高分</h3>
                    <div class="stat-value">${max}</div>
                    <p>班级最高</p>
                </div>
                <div class="stat-card">
                    <h3>最低分</h3>
                    <div class="stat-value">${min}</div>
                    <p>班级最低</p>
                </div>
                <div class="stat-card">
                    <h3>标准差</h3>
                    <div class="stat-value">${stdDev}</div>
                    <p>分数离散程度</p>
                </div>
            `;
        }

        // 更新总分与分数线差距分析 - 使用指定考试的数据
        function updateTotalLineDiffAnalysis() {
            const studentId = document.getElementById('totalDiffStudentSelect').value;
            const container = document.getElementById('totalLineDiffContainer');
            
            if (!studentId) {
                container.innerHTML = '<p style="color: #64748b; text-align: center;">请选择学生查看与分数线的差距</p>';
                return;
            }
            
            // 获取指定考试的数据
            const selectedExam = exams.find(exam => exam.id === totalAnalysisExamId);
            const displayStudents = selectedExam ? selectedExam.data : [];
            const student = displayStudents.find(s => s.id === studentId);
            
            if (!student) {
                container.innerHTML = '<p style="color: #64748b; text-align: center;">未找到该学生数据</p>';
                return;
            }
            
            const totalScore = student.total || 0;
            
            // 获取指定考试的分数线
            const examLines = selectedExam ? selectedExam.lines : scoreLines;
            
            // 计算与各分数线的差距
            const diffKeyTier = totalScore - examLines.total.keyTier;
            const diffFirstTier = totalScore - examLines.total.firstTier;
            const diffExcellent = totalScore - examLines.total.excellent;
            const diffDoubleFirst = totalScore - examLines.total.doubleFirst;
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div class="line-diff-card">
                        <div class="line-diff-title">与本科线差距</div>
                        <div class="line-diff-value ${diffKeyTier >= 0 ? 'line-diff-positive' : 'line-diff-negative'}">
                            ${diffKeyTier >= 0 ? '+' : ''}${diffKeyTier.toFixed(1)}分
                        </div>
                        <p>本科线: ${examLines.total.keyTier}分</p>
                        <p>学生总分: ${totalScore.toFixed(1)}分</p>
                    </div>
                    <div class="line-diff-card">
                        <div class="line-diff-title">与重本线差距</div>
                        <div class="line-diff-value ${diffFirstTier >= 0 ? 'line-diff-positive' : 'line-diff-negative'}">
                            ${diffFirstTier >= 0 ? '+' : ''}${diffFirstTier.toFixed(1)}分
                        </div>
                        <p>重本线: ${examLines.total.firstTier}分</p>
                        <p>学生总分: ${totalScore.toFixed(1)}分</p>
                    </div>
                    <div class="line-diff-card">
                        <div class="line-diff-title">与高优线差距</div>
                        <div class="line-diff-value ${diffExcellent >= 0 ? 'line-diff-positive' : 'line-diff-negative'}">
                            ${diffExcellent >= 0 ? '+' : ''}${diffExcellent.toFixed(1)}分
                        </div>
                        <p>高优线: ${examLines.total.excellent}分</p>
                        <p>学生总分: ${totalScore.toFixed(1)}分</p>
                    </div>
                    <div class="line-diff-card">
                        <div class="line-diff-title">与双一流线差距</div>
                        <div class="line-diff-value ${diffDoubleFirst >= 0 ? 'line-diff-positive' : 'line-diff-negative'}">
                            ${diffDoubleFirst >= 0 ? '+' : ''}${diffDoubleFirst.toFixed(1)}分
                        </div>
                        <p>双一流线: ${examLines.total.doubleFirst}分</p>
                        <p>学生总分: ${totalScore.toFixed(1)}分</p>
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 15px; background: #f8fafc; border-radius: 8px;">
                    <h4 style="margin-bottom: 10px;">分析说明</h4>
                    <p>• 正值表示超过该分数线，负值表示低于该分数线</p>
                    <p>• 绿色数字表示已超过该分数线，红色数字表示未达到该分数线</p>
                    <p>• 建议重点关注负值最大的科目进行针对性提升</p>
                </div>
            `;
        }

        // 更新学科与分数线差距分析 - 使用指定考试的数据
        function updateSubjectLineDiffAnalysis(subject) {
            const studentId = document.getElementById(`${subject}DiffStudentSelect`).value;
            const container = document.getElementById(`${subject}LineDiffContainer`);
            
            if (!studentId) {
                container.innerHTML = '<p style="color: #64748b; text-align: center;">请选择学生查看与分数线的差距</p>';
                return;
            }
            
            // 获取指定考试的数据
            const selectedExam = exams.find(exam => exam.id === subjectAnalysisExamId);
            const displayStudents = selectedExam ? selectedExam.data : [];
            const student = displayStudents.find(s => s.id === studentId);
            
            if (!student) {
                container.innerHTML = '<p style="color: #64748b; text-align: center;">未找到该学生数据</p>';
                return;
            }
            
            const subjectScore = student[subject] || 0;
            const maxScore = subject === 'chinese' || subject === 'math' || subject === 'english' ? 150 : 100;
            
            // 获取指定考试的分数线
            const examLines = selectedExam ? selectedExam.lines : scoreLines;
            
            // 计算与各分数线的差距
            const diffKeyTier = subjectScore - examLines[subject].keyTier;
            const diffFirstTier = subjectScore - examLines[subject].firstTier;
            const diffExcellent = subjectScore - examLines[subject].excellent;
            const diffDoubleFirst = subjectScore - examLines[subject].doubleFirst;
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div class="line-diff-card">
                        <div class="line-diff-title">与本科线差距</div>
                        <div class="line-diff-value ${diffKeyTier >= 0 ? 'line-diff-positive' : 'line-diff-negative'}">
                            ${diffKeyTier >= 0 ? '+' : ''}${diffKeyTier.toFixed(1)}分
                        </div>
                        <p>本科线: ${examLines[subject].keyTier}分</p>
                        <p>学生${getSubjectName(subject)}: ${subjectScore.toFixed(1)}分</p>
                    </div>
                    <div class="line-diff-card">
                        <div class="line-diff-title">与重本线差距</div>
                        <div class="line-diff-value ${diffFirstTier >= 0 ? 'line-diff-positive' : 'line-diff-negative'}">
                            ${diffFirstTier >= 0 ? '+' : ''}${diffFirstTier.toFixed(1)}分
                        </div>
                        <p>重本线: ${examLines[subject].firstTier}分</p>
                        <p>学生${getSubjectName(subject)}: ${subjectScore.toFixed(1)}分</p>
                    </div>
                    <div class="line-diff-card">
                        <div class="line-diff-title">与高优线差距</div>
                        <div class="line-diff-value ${diffExcellent >= 0 ? 'line-diff-positive' : 'line-diff-negative'}">
                            ${diffExcellent >= 0 ? '+' : ''}${diffExcellent.toFixed(1)}分
                        </div>
                        <p>高优线: ${examLines[subject].excellent}分</p>
                        <p>学生${getSubjectName(subject)}: ${subjectScore.toFixed(1)}分</p>
                    </div>
                    <div class="line-diff-card">
                        <div class="line-diff-title">与双一流线差距</div>
                        <div class="line-diff-value ${diffDoubleFirst >= 0 ? 'line-diff-positive' : 'line-diff-negative'}">
                            ${diffDoubleFirst >= 0 ? '+' : ''}${diffDoubleFirst.toFixed(1)}分
                        </div>
                        <p>双一流线: ${examLines[subject].doubleFirst}分</p>
                        <p>学生${getSubjectName(subject)}: ${subjectScore.toFixed(1)}分</p>
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 15px; background: #f8fafc; border-radius: 8px;">
                    <h4 style="margin-bottom: 10px;">${getSubjectName(subject)}学科分析</h4>
                    <p>• ${getSubjectName(subject)}满分: ${maxScore}分</p>
                    <p>• 当前分数占满分比例: ${(subjectScore / maxScore * 100).toFixed(1)}%</p>
                    <p>• 建议目标: ${diffDoubleFirst < 0 ? '争取达到双一流线' : diffExcellent < 0 ? '保持高优线，冲击双一流线' : diffFirstTier < 0 ? '保持重本线，冲击高优线' : '保持优势，争取更高分'}</p>
                </div>
            `;
        }

        // 生成报告
        function generateReport() {
            // 获取当前考试的数据
            const currentExam = exams.find(exam => exam.id === currentExamId);
            const displayStudents = currentExam ? currentExam.data : [];
            
            if (displayStudents.length === 0) {
                alert('没有学生数据可以生成报告');
                return;
            }
            
            // 计算统计信息
            const studentCount = displayStudents.length;
            
            // 计算各科平均分
            const subjects = ['chinese', 'math', 'english', 'physics', 'chemistry', 'biology'];
            const averages = {};
            let totalSum = 0;
            
            subjects.forEach(subject => {
                const sum = displayStudents.reduce((acc, student) => acc + (student[subject] || 0), 0);
                averages[subject] = (sum / displayStudents.length).toFixed(1);
                totalSum += sum;
            });
            
            const totalAvg = (totalSum / (displayStudents.length * subjects.length)).toFixed(1);
            
            // 获取当前分数线（当前查看的考试的分数线）
            const currentLines = exams.find(exam => exam.id === currentLineExamId)?.lines || scoreLines;
            
            // 计算各分数线人数
            const totalScores = displayStudents.map(student => student.total || 0);
            
            const belowKeyTier = totalScores.filter(score => score < currentLines.total.keyTier).length;
            const betweenKeyAndFirst = totalScores.filter(score => score >= currentLines.total.keyTier && score < currentLines.total.firstTier).length;
            const betweenFirstAndExcellent = totalScores.filter(score => score >= currentLines.total.firstTier && score < currentLines.total.excellent).length;
            const betweenExcellentAndDouble = totalScores.filter(score => score >= currentLines.total.excellent && score < currentLines.total.doubleFirst).length;
            const aboveDoubleFirst = totalScores.filter(score => score >= currentLines.total.doubleFirst).length;
            
            // 创建报告内容
            const reportContent = `
                学生成绩分析报告
                =================
                
                考试信息:
                - 考试名称: ${currentExam ? currentExam.name : '当前考试'}
                - 考试日期: ${currentExam ? currentExam.date : new Date().toISOString().split('T')[0]}
                - 学生人数: ${studentCount}
                
                学科平均分:
                - 语文: ${averages.chinese}分
                - 数学: ${averages.math}分
                - 英语: ${averages.english}分
                - 物理: ${averages.physics}分
                - 化学: ${averages.chemistry}分
                - 生物: ${averages.biology}分
                - 总平均分: ${totalAvg}分
                
                总分分数线分布:
                - 低于本科线(${currentLines.total.keyTier}分): ${belowKeyTier}人 (${((belowKeyTier/studentCount)*100).toFixed(1)}%)
                - 本科线-重本线(${currentLines.total.firstTier}分): ${betweenKeyAndFirst}人 (${((betweenKeyAndFirst/studentCount)*100).toFixed(1)}%)
                - 重本线-高优线(${currentLines.total.excellent}分): ${betweenFirstAndExcellent}人 (${((betweenFirstAndExcellent/studentCount)*100).toFixed(1)}%)
                - 高优线-双一流线(${currentLines.total.doubleFirst}分): ${betweenExcellentAndDouble}人 (${((betweenExcellentAndDouble/studentCount)*100).toFixed(1)}%)
                - 高于双一流线: ${aboveDoubleFirst}人 (${((aboveDoubleFirst/studentCount)*100).toFixed(1)}%)
                
                报告生成时间: ${new Date().toLocaleString()}
            `;
            
            // 创建下载链接
            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `学生成绩分析报告_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('报告已生成并开始下载');
        }

        // 重置数据
        function resetData() {
            if (confirm('确定要重置所有学生数据吗？这将清除所有学生记录。')) {
                // 清空当前考试的数据
                const currentExam = exams.find(exam => exam.id === currentExamId);
                if (currentExam) {
                    currentExam.data = [];
                } else {
                    students = [];
                }
                
                renderStudentTable();
                updateClassStats();
                updateStudentSelects();
                updateSubjectTrendSelects();
                updateRankTrendSelect();
                updateSubjectRankSelects();
                updateLineDiffSelects();
                updateLineCounts();
                
                alert('学生数据已重置');
            }
        }
    </script>
</body>
</html>